<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-touch-fullscreen" content="yes"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="theme-color" content="#0a0a0a"/>
  <title>ELITE TRAINING</title>
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%230a0a0a'/><text y='.9em' font-size='90'>ðŸ’ª</text></svg>"/>
  <!-- Firebase SDKs -->
  <style>
    /* System fonts - works 100% offline, no network requests */
    .bebas-font { font-family: 'Impact', 'Arial Narrow', 'Arial Black', sans-serif; letter-spacing: 2px; }
  </style>
  <style>
    /* DYSLEXIA MODE â€” uses Verdana, proven most readable for dyslexia, no external fonts needed */
    body.dyslexia-mode,
    body.dyslexia-mode p,
    body.dyslexia-mode div,
    body.dyslexia-mode span,
    body.dyslexia-mode input,
    body.dyslexia-mode textarea {
      font-family: Verdana, Geneva, sans-serif !important;
      letter-spacing: 0.06em !important;
      word-spacing: 0.15em !important;
      line-height: 2 !important;
    }
    body.dyslexia-mode .habit-label { font-size: 15px !important; }
    body.dyslexia-mode .ex-name { font-size: 15px !important; }
    body.dyslexia-mode .ex-note { font-size: 13px !important; }
    body.dyslexia-mode .box-txt { font-size: 13px !important; }
    body.dyslexia-mode .habit-detail { font-size: 13px !important; }
  </style>
  <style>
    :root{
      --accent:#00ff88;--bg:#0a0a0a;--card:#111;--border:#1a1a1a;
      --sat: env(safe-area-inset-top, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);
      --sar: env(safe-area-inset-right, 0px);
    }
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
    html{height:100%;background:var(--bg);}
    body{background:var(--bg);color:#f0f0f0;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue','Segoe UI',sans-serif;min-height:100%;min-height:-webkit-fill-available;overscroll-behavior:none;-webkit-overflow-scrolling:touch;}
    .bebas{font-family:Impact,'Arial Narrow','Arial Black',sans-serif;}
    #app{max-width:480px;margin:0 auto;min-height:100vh;min-height:-webkit-fill-available;padding-bottom:calc(32px + var(--sab));}
    ::-webkit-scrollbar{width:3px;}
    ::-webkit-scrollbar-thumb{background:#333;border-radius:2px;}

    /* HEADER */
    .header{padding:calc(16px + var(--sat)) 20px 14px;padding-top:max(52px, calc(16px + var(--sat)));border-bottom:1px solid var(--border);background:var(--bg);position:sticky;top:0;z-index:20;display:flex;justify-content:space-between;align-items:flex-start;}
    .h-eyebrow{font-size:10px;letter-spacing:4px;color:#444;margin-bottom:2px;}
    .h-phase{font-size:30px;letter-spacing:2px;line-height:1;}
    .h-sub{font-size:12px;margin-top:2px;}
    .h-date{font-size:11px;color:#444;margin-top:4px;}
    .prog-circle{width:52px;height:52px;border-radius:50%;border:2px solid var(--accent);display:flex;align-items:center;justify-content:center;flex-direction:column;flex-shrink:0;}
    .prog-num{font-size:17px;line-height:1;font-family:Impact,'Arial Narrow','Arial Black',sans-serif;}
    .prog-pct{font-size:8px;color:#555;}

    /* MAIN TABS */
    .tabs{display:flex;border-bottom:1px solid var(--border);background:var(--bg);position:sticky;top:var(--header-h, 100px);z-index:19;overflow-x:auto;}
    .tabs::-webkit-scrollbar{display:none;}
    .tab-btn{flex-shrink:0;padding:11px 12px;background:none;border:none;border-bottom:2px solid transparent;color:#444;font-size:12px;letter-spacing:1.5px;cursor:pointer;font-family:Impact,'Arial Narrow','Arial Black',sans-serif;transition:all 0.2s;white-space:nowrap;}
    .tab-btn.active{border-bottom-color:var(--accent);color:var(--accent);}

    /* DAY SELECTOR TABS */
    .day-tabs{display:flex;padding:12px 20px 0;gap:6px;overflow-x:auto;}
    .day-tabs::-webkit-scrollbar{display:none;}
    .day-tab{flex-shrink:0;padding:8px 12px;border-radius:8px 8px 0 0;font-size:12px;letter-spacing:1px;cursor:pointer;font-family:Impact,'Arial Narrow','Arial Black',sans-serif;background:none;color:#444;border:1px solid #1e1e1e;border-bottom:none;transition:all 0.15s;white-space:nowrap;}
    .day-tab.active{color:var(--accent);border-color:var(--accent);background:#141414;}
    .day-tab.rest-day.active{color:#6699ff;border-color:#6699ff;}
    .day-tab.recovery-day.active{color:#ffcc00;border-color:#ffcc00;}
    .day-tab.hiit-day.active{color:#ff88aa;border-color:#ff88aa;}

    /* PHASE PILLS */
    .phase-row{padding:12px 20px 8px;display:flex;gap:8px;}
    .phase-btn{flex:1;padding:7px 4px;border-radius:6px;font-size:14px;letter-spacing:1px;cursor:pointer;font-family:Impact,'Arial Narrow','Arial Black',sans-serif;border:1px solid #222;background:#141414;color:#555;transition:all 0.2s;}
    .phase-btn.active{color:#000;}

    /* DAY CARD */
    .day-card{margin:0 20px 14px;background:var(--card);border-radius:0 10px 10px 10px;padding:14px 16px;border-left:3px solid var(--accent);}
    .day-name{font-size:24px;letter-spacing:1px;font-family:Impact,'Arial Narrow','Arial Black',sans-serif;}
    .day-tag{font-size:12px;color:#666;margin-top:2px;}

    /* INFO BOXES */
    .info-box{margin:0 20px 10px;border-radius:8px;padding:11px 14px;display:flex;align-items:center;gap:10px;}
    .info-box.warm{background:#0d1a12;border:1px solid #1a2e1f;}
    .info-box.cool{background:#110d1a;border:1px solid #1e1a2e;}
    .info-box.note{background:#1a1a0d;border:1px solid #2e2e1a;}
    .info-box.blue{background:#0d0f1a;border:1px solid #1a2030;}
    .box-icon{font-size:16px;flex-shrink:0;}
    .box-lbl{font-size:9px;color:#555;letter-spacing:2px;}
    .box-txt{font-size:12px;margin-top:1px;}

    /* PROGRESS BAR */
    .prog-bar-wrap{padding:0 20px 14px;}
    .prog-bar-labels{display:flex;justify-content:space-between;margin-bottom:5px;font-size:10px;letter-spacing:2px;color:#444;}
    .prog-bar-track{height:3px;background:#1a1a1a;border-radius:2px;}
    .prog-bar-fill{height:100%;background:var(--accent);border-radius:2px;transition:width 0.3s ease;}

    /* EXERCISE ITEMS */
    .ex-section{padding:0 20px;}
    .section-lbl{font-size:10px;letter-spacing:3px;color:#444;margin-bottom:8px;}
    .section-lbl.pink{color:#ff88aa;}
    .section-lbl.yellow{color:#ffcc00;}
    .section-lbl.blue{color:#6699ff;}
    .ex-item{margin-bottom:8px;background:var(--card);border-radius:10px;border:1px solid var(--border);overflow:hidden;transition:border-color 0.15s;}
    .ex-item.done{border-color:#1a3a1a;background:#0d1a0d;}
    .ex-item.body-item.done{border-color:#1a1a3a;background:#0d0d1a;}
    .ex-top{display:flex;align-items:center;gap:12px;padding:12px 14px;cursor:pointer;}
    .ex-check{width:22px;height:22px;border-radius:5px;border:2px solid #333;background:none;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.15s;}
    .ex-check.checked{background:var(--accent);border-color:var(--accent);}
    .ex-check.checked::after{content:'âœ“';color:#000;font-size:12px;font-weight:bold;}
    .ex-check.blue-check{border-color:#2a2a44;}
    .ex-check.blue-check.checked{background:#6699ff;border-color:#6699ff;}
    .ex-check.yellow-check{border-color:#44440a;}
    .ex-check.yellow-check.checked{background:#ffcc00;border-color:#ffcc00;}
    .ex-info{flex:1;}
    .ex-name{font-size:14px;letter-spacing:0.3px;transition:all 0.15s;}
    .ex-item.done .ex-name{color:#444;text-decoration:line-through;}
    .ex-note{font-size:11px;color:#555;margin-top:2px;}
    .ex-reps-badge{font-size:12px;color:var(--accent);text-align:right;flex-shrink:0;white-space:nowrap;}
    .ex-reps-badge.blue{color:#6699ff;}
    .ex-reps-badge.yellow{color:#ffcc00;}

    /* WEIGHT INPUT */
    .ex-weight{padding:0 14px 12px;display:none;}
    .ex-weight.open{display:block;}
    .weight-row{display:flex;align-items:center;gap:10px;}
    .weight-lbl{font-size:10px;color:#555;letter-spacing:2px;flex-shrink:0;}
    .weight-input{flex:1;background:#0a0a0a;border:1px solid #2a2a2a;border-radius:6px;padding:7px 10px;color:#f0f0f0;font-size:14px;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif;outline:none;}
    .weight-input:focus{border-color:var(--accent);}
    .weight-unit{font-size:12px;color:#555;}
    .weight-note{font-size:10px;color:#444;margin-top:5px;font-style:italic;}

    /* RECOVERY CHECKLIST ITEMS */
    .rec-item{display:flex;align-items:flex-start;gap:12px;padding:12px 14px;margin:0 20px 8px;background:var(--card);border-radius:10px;border:1px solid var(--border);cursor:pointer;transition:all 0.15s;}
    .rec-item.done{background:#0d1a0d;border-color:#1a3a1a;}
    .rec-item.blue-rec.done{background:#0d0f1a;border-color:#1a2030;}
    .rec-check{width:20px;height:20px;border-radius:4px;border:2px solid #333;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;transition:all 0.15s;}
    .rec-check.checked{background:var(--accent);border-color:var(--accent);}
    .rec-check.checked::after{content:'âœ“';color:#000;font-size:11px;font-weight:bold;}
    .rec-check.blue-rc.checked{background:#6699ff;border-color:#6699ff;}
    .rec-check.pink-rc.checked{background:#ff88aa;border-color:#ff88aa;}
    .rec-check.yellow-rc.checked{background:#ffcc00;border-color:#ffcc00;}
    .rec-text{font-size:13px;line-height:1.3;}
    .rec-item.done .rec-text{color:#444;text-decoration:line-through;}
    .rec-detail{font-size:11px;color:#555;margin-top:3px;line-height:1.4;}

    /* SUPPS */
    .supp-item{display:flex;align-items:center;gap:12px;padding:13px 16px;margin:0 20px 8px;background:var(--card);border-radius:10px;border:1px solid var(--border);cursor:pointer;transition:all 0.15s;}
    .supp-item.done{background:#0d1a0d;border-color:#1a3a1a;}
    .supp-check{width:22px;height:22px;border-radius:5px;border:2px solid #333;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.15s;}
    .supp-check.checked{background:var(--accent);border-color:var(--accent);}
    .supp-check.checked::after{content:'âœ“';color:#000;font-size:12px;font-weight:bold;}
    .supp-info{flex:1;}
    .supp-name{font-size:15px;font-family:Impact,'Arial Narrow','Arial Black',sans-serif;letter-spacing:0.5px;}
    .supp-item.done .supp-name{color:#444;text-decoration:line-through;}
    .supp-detail{font-size:11px;color:#555;margin-top:2px;}
    .supp-dose{font-size:10px;color:#000;padding:2px 8px;border-radius:20px;font-weight:600;white-space:nowrap;flex-shrink:0;}
    .sex-item{display:flex;align-items:center;gap:12px;padding:13px 16px;margin-bottom:8px;background:var(--card);border-radius:10px;border:1px solid #2a1a20;cursor:pointer;transition:all 0.15s;}
    .sex-item.done{background:#1a0d12;border-color:#3a1a22;}
    .sex-check{width:22px;height:22px;border-radius:5px;border:2px solid #3a1a2a;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.15s;}
    .sex-check.checked{background:#ff88aa;border-color:#ff88aa;}
    .sex-check.checked::after{content:'âœ“';color:#000;font-size:12px;font-weight:bold;}

    /* CALENDAR */
    .cal-wrap{padding:14px 20px;}
    .cal-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
    .cal-month{font-size:22px;font-family:Impact,'Arial Narrow','Arial Black',sans-serif;letter-spacing:2px;}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;}
    .cal-dow{font-size:10px;color:#444;text-align:center;padding:4px 0;letter-spacing:1px;}
    .cal-day{aspect-ratio:1;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px;cursor:pointer;border:1px solid transparent;transition:all 0.15s;color:#555;}
    .cal-day.empty{cursor:default;}
    .cal-day.today{border-color:var(--accent);color:#fff;}
    .cal-day.trained{background:var(--accent);color:#000;font-weight:600;}
    .cal-day.partial{background:#1a3a1a;color:var(--accent);}
    .cal-day.rest{background:#1a1a2e;color:#6699ff;}
    .nav-btn{background:none;border:1px solid #2a2a2a;border-radius:6px;color:#888;padding:5px 12px;cursor:pointer;font-size:16px;}

    /* MODAL */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:100;display:flex;align-items:flex-end;justify-content:center;}
    .modal{background:#111;border-radius:20px 20px 0 0;padding:24px 20px 40px;width:100%;max-width:480px;max-height:80vh;overflow-y:auto;border-top:1px solid #222;}
    .modal-handle{width:36px;height:4px;background:#333;border-radius:2px;margin:0 auto 20px;}
    .modal-date{font-size:22px;font-family:Impact,'Arial Narrow','Arial Black',sans-serif;letter-spacing:2px;margin-bottom:16px;color:var(--accent);}
    .modal-section-lbl{font-size:10px;letter-spacing:3px;color:#444;margin-bottom:8px;margin-top:16px;}
    .modal-row{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:#0a0a0a;border-radius:6px;margin-bottom:4px;}
    .modal-close{width:100%;padding:14px;background:#1a1a1a;border:none;border-radius:10px;color:#888;font-size:14px;cursor:pointer;margin-top:12px;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif;}

    /* HABITS */
    .habit-item{display:flex;align-items:center;gap:14px;padding:13px 16px;margin:0 20px 8px;background:var(--card);border-radius:10px;border:1px solid var(--border);cursor:pointer;transition:all 0.15s;}
    .habit-item.done{background:#0d1a0d;border-color:#1a3a1a;}
    .habit-check{width:22px;height:22px;border-radius:5px;border:2px solid #333;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.15s;}
    .habit-check.checked{background:var(--accent);border-color:var(--accent);}
    .habit-check.checked::after{content:'âœ“';color:#000;font-size:12px;font-weight:bold;}
    /* NEW GROUPED HABITS */
    .hgroup{margin:0 16px 10px;border-radius:14px;overflow:hidden;border:1px solid #222;}
    .hgroup-header{display:flex;align-items:center;gap:12px;padding:14px 16px;background:#151515;cursor:pointer;user-select:none;-webkit-user-select:none;}
    .hgroup-icon{font-size:22px;flex-shrink:0;}
    .hgroup-label{font-size:16px;font-family:Impact,'Arial Narrow',sans-serif;letter-spacing:2px;flex:1;}
    .hgroup-count{font-size:13px;font-family:Impact,sans-serif;padding:3px 10px;border-radius:20px;background:#222;flex-shrink:0;}
    .hgroup-arrow{font-size:12px;color:#444;flex-shrink:0;transition:transform 0.2s;}
    .hgroup-arrow.open{transform:rotate(90deg);}
    .hgroup-body{background:#0f0f0f;}
    .hnew-item{padding:14px 16px;border-bottom:1px solid #1a1a1a;cursor:pointer;user-select:none;-webkit-user-select:none;transition:background 0.15s;position:relative;overflow:hidden;}
    .hnew-item:last-child{border-bottom:none;}
    .hnew-item.done{background:#080f08;}
    .hnew-item.flash{animation:habitFlash 0.4s ease-out;}
    @keyframes habitFlash{0%{background:#00ff8844;}50%{background:#00ff8822;}100%{background:transparent;}}
    .hnew-item.done.flash{animation:habitFlashDone 0.4s ease-out;}
    @keyframes habitFlashDone{0%{background:#00ff8866;}100%{background:#080f08;}}
    .hnew-top{display:flex;align-items:center;gap:12px;}
    .hnew-check{width:26px;height:26px;border-radius:7px;border:2px solid #333;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.2s;font-size:14px;font-weight:bold;}
    .hnew-check.checked{background:var(--accent);border-color:var(--accent);color:#000;}
    .hnew-icon{font-size:22px;flex-shrink:0;}
    .hnew-label{font-size:15px;line-height:1.4;flex:1;}
    .habit-label{font-size:15px;line-height:1.4;}
    .hnew-item.done .hnew-label{color:#444;text-decoration:line-through;}
    .hnew-expand{font-size:10px;color:#444;flex-shrink:0;transition:transform 0.2s;padding:4px;}
    .hnew-expand.open{transform:rotate(180deg);}
    .hnew-detail{padding:0 16px 14px 60px;display:none;}
    .hnew-detail.open{display:block;}
    .habit-detail{font-size:12px;color:#666;line-height:1.9;margin-bottom:8px;}
    .habit-today-tip{font-size:12px;padding:8px 12px;border-radius:8px;line-height:1.8;margin-top:4px;}
    .nut-card{display:flex;justify-content:space-between;align-items:center;padding:13px 16px;margin:0 20px 8px;background:var(--card);border-radius:8px;border:1px solid var(--border);}
    .vyv-box{margin:16px 20px 0;padding:16px;background:#0d1219;border-radius:10px;border:1px solid #1a2030;}
    .timeline-wrap{position:relative;padding:14px 20px 14px 40px;}
    .timeline-line{position:absolute;left:26px;top:20px;bottom:20px;width:2px;background:linear-gradient(to bottom,#00ff88,#ff6b35,#ff0055);border-radius:1px;}
    .tl-item{position:relative;margin-bottom:20px;}
    .tl-dot{position:absolute;left:-21px;top:5px;width:10px;height:10px;border-radius:50%;border:2px solid var(--bg);}
    .tl-week{font-size:14px;font-family:Impact,'Arial Narrow','Arial Black',sans-serif;letter-spacing:1px;}
    .tl-text{font-size:12px;color:#777;margin-top:3px;line-height:1.5;}
    .warn-box{margin:8px 20px 32px;padding:14px;background:#1a0d0d;border-radius:10px;border:1px solid #2e1a1a;}

    .content-area{padding-bottom:calc(48px + var(--sab));}
    .divider{height:1px;background:#1a1a1a;margin:16px 20px;}
    .saved-badge{position:fixed;bottom:calc(20px + var(--sab));left:50%;transform:translateX(-50%);background:var(--accent);color:#000;font-size:12px;font-family:Impact,'Arial Narrow','Arial Black',sans-serif;letter-spacing:2px;padding:8px 20px;border-radius:20px;z-index:50;opacity:0;transition:opacity 0.3s;pointer-events:none;}
    .saved-badge.show{opacity:1;}
  
    /* â”€â”€ STRETCH TIMERS â”€â”€ */
    .stretch-timers{margin:10px 20px 0;background:#0d0a1a;border:1px solid #2a1a4a;border-radius:10px;overflow:hidden;}
    .stretch-timers-hdr{padding:10px 14px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #1a1228;}
    .stretch-row{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid #1a1228;}
    .stretch-row:last-child{border-bottom:none;}
    .stretch-lbl{flex:1;font-size:12px;color:#bbb;}
    .stretch-time{font-size:11px;color:#7755cc;font-family:Impact,sans-serif;min-width:32px;text-align:right;}
    .stretch-btn{padding:5px 12px;background:#1a0a2e;border:1px solid #7755cc;border-radius:6px;color:#aa88ff;font-size:11px;font-family:Impact,sans-serif;letter-spacing:1px;cursor:pointer;flex-shrink:0;}
    /* â”€â”€ HYGIENE KIT â”€â”€ */
    .hkit-wrap{margin:0 16px 16px;}
    .hkit-tabs{display:flex;overflow-x:auto;gap:0;background:#0d0d0d;border-radius:10px 10px 0 0;border:1px solid #1e1e1e;border-bottom:none;}
    .hkit-tab{padding:9px 14px;font-size:10px;font-family:Impact,sans-serif;letter-spacing:1px;color:#444;cursor:pointer;white-space:nowrap;border-right:1px solid #1a1a1a;flex-shrink:0;}
    .hkit-tab.on{color:#ff6b35;border-bottom:2px solid #ff6b35;background:#1a0800;}
    .hkit-body{background:#0d0d0d;border:1px solid #1e1e1e;border-radius:0 0 10px 10px;overflow:hidden;}
    .hkit-item{display:flex;gap:10px;padding:10px 14px;border-bottom:1px solid #141414;align-items:flex-start;}
    .hkit-item:last-child{border-bottom:none;}
    .hkit-ico{font-size:15px;flex-shrink:0;margin-top:1px;}
    .hkit-name{font-size:12px;color:#ccc;line-height:1.4;}
    .hkit-note{font-size:10px;color:#555;margin-top:2px;line-height:1.5;}
  </style>

<style>
.rest-btn-large {
  font-size:18px !important;
  padding:12px 16px !important;
  margin:4px !important;
  border-radius:8px !important;
}
.timer-display-large {
  font-size:56px !important;
  font-weight:bold !important;
}
.alarm-flash {
  position:fixed;
  inset:0;
  background:rgba(255,0,0,0.85);
  z-index:9999;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  font-size:28px;
  color:white;
}
</style>

</head>
<body>
<div id="installBanner" style="display:none;position:fixed;bottom:0;left:0;right:0;z-index:200;background:#111;border-top:1px solid #00ff88;padding:14px 20px calc(14px + env(safe-area-inset-bottom));text-align:center">
  <div style="font-size:13px;color:#f0f0f0;margin-bottom:6px">Add to Home Screen for the full app experience</div>
  <div style="font-size:12px;color:#00ff88">Tap <strong>Share</strong> â†’ <strong>Add to Home Screen</strong></div>
  <div style="font-size:11px;color:#444;margin-top:4px">Then reopen from your home screen</div>
  <button onclick="document.getElementById('installBanner').style.display='none';localStorage.setItem('bannerDismissed','1')" 
    style="margin-top:10px;background:none;border:1px solid #333;border-radius:6px;color:#555;padding:6px 16px;font-size:12px;cursor:pointer">
    Dismiss
  </button>
</div>
<div id="app"></div>
<div class="saved-badge" id="savedBadge">SAVED âœ“</div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIGHTER'S POWER SYSTEM - 4 Equipment Setups
// Mon=Pull, Tue=Push, Wed=Legs, Thu=Arms+Core, Fri=Optional Pull
const FIGHTERS = {
  gym: {
    label: "ðŸ‹ï¸ FULL GYM",
    color: "#00ff88",
    days: [
      { name:"MONDAY", type:"PULL", tag:"Back Â· Biceps Â· Grip Â· V-Taper Power",
        warmup:"5 min rowing machine + band pull-aparts 2Ã—15 + cat-cow 10 reps + dead hang 30 sec",
        cooldown:"Lat stretch doorway 30 sec each Â· child's pose 60 sec Â· standing hamstring hang 60 sec",
        exercises:[
          {n:"Deadlifts",s:5,r:"5 â€” king of power. Explosive hip drive. Add weight weekly."},
          {n:"Pull-ups / Chin-ups",s:4,r:"6-8 â€” add weight belt when bodyweight is easy"},
          {n:"Barbell Rows",s:4,r:"8 â€” explosive pull up, hold 1 sec, control down"},
          {n:"T-Bar Rows",s:4,r:"10 â€” builds thick back for punching power"},
          {n:"Single-Arm Cable Row",s:3,r:"12 each â€” full rotation at bottom"},
          {n:"Cable Face Pulls",s:4,r:"20 â€” rear delt health. Never skip."},
          {n:"Lat Pulldowns (wide grip)",s:3,r:"12 â€” full stretch at top"},
          {n:"Barbell Curls",s:4,r:"8 â€” heavy bicep mass"},
          {n:"Hammer Curls",s:3,r:"12 â€” forearm strength for grip"},
          {n:"Farmer's Walks",s:3,r:"50 yards â€” grip endurance"},
          {n:"Dead Hangs",s:3,r:"max time â€” pure grip strength"},
          {n:"Cable High Rows",s:2,r:"20 â€” fast explosive pulls to finish"},
        ]},
      { name:"TUESDAY", type:"PUSH", tag:"Chest Â· Shoulders Â· Triceps Â· Knockout Power",
        warmup:"8 min elliptical + arm swings 2Ã—15 + push-up progression 10/8/6",
        cooldown:"Doorway chest stretch 30 sec Â· shoulder cross-body 30 sec each Â· shadowbox slow 3 min",
        exercises:[
          {n:"Barbell Bench Press",s:5,r:"5 â€” king of upper body. Add weight weekly."},
          {n:"Overhead Press (standing)",s:4,r:"6 â€” full body pressing power"},
          {n:"Incline Barbell Press",s:4,r:"8 â€” upper chest for uppercut power"},
          {n:"Weighted Dips",s:4,r:"10 â€” lower chest and tricep power"},
          {n:"Push Press",s:4,r:"6 â€” leg drive to overhead. Max power."},
          {n:"DB Shoulder Press",s:4,r:"10 â€” unilateral shoulder stability"},
          {n:"Lateral Raises",s:4,r:"15 â€” constant tension. Cable or DB."},
          {n:"Close-Grip Bench Press",s:4,r:"8 â€” heavy tricep power"},
          {n:"Overhead Cable Extension",s:4,r:"12 â€” full tricep stretch"},
          {n:"Medicine Ball Slams",s:4,r:"12 â€” explosive power finisher"},
          {n:"Clap Push-ups",s:3,r:"8 â€” plyometric finishing move"},
          {n:"Battle Ropes",s:3,r:"30 sec all out"},
        ]},
      { name:"WEDNESDAY", type:"LEGS", tag:"Legs Â· Glutes Â· Hip Power Â· Sexual Stamina",
        warmup:"8 min bike/elliptical + glute bridges 2Ã—15 + world's greatest stretch 5 each side",
        cooldown:"Pigeon pose 90 sec each Â· deep squat hold 2 min Â· couch stretch 2 min each side",
        exercises:[
          {n:"Back Squats",s:5,r:"5 â€” explosive up. Add weight weekly."},
          {n:"Romanian Deadlifts",s:4,r:"8 â€” hip hinge power. Directly transfers to bedroom performance."},
          {n:"Bulgarian Split Squats",s:4,r:"12 each leg â€” single leg strength"},
          {n:"Hip Thrusts (weighted)",s:4,r:"15 â€” 2 sec squeeze at top. Most important exercise for sexual power."},
          {n:"Walking Lunges",s:4,r:"20 steps â€” dynamic leg power"},
          {n:"Box Jumps",s:4,r:"8 â€” explosive jumping power"},
          {n:"Leg Press",s:4,r:"12 â€” heavy quad development"},
          {n:"Leg Curls",s:4,r:"15 â€” hamstring isolation"},
          {n:"Explosive Hip Thrusts",s:3,r:"10 â€” same weight as regular, drive fast"},
          {n:"Calf Raises",s:4,r:"20 â€” explosive"},
          {n:"Jump Squats",s:4,r:"15 â€” bodyweight explosive finisher"},
        ]},
      { name:"THURSDAY", type:"ARMS + CORE", tag:"Core Â· Arms Â· Rotational Power Â· Knockout Finisher",
        warmup:"5 min rowing + cable rotations 2Ã—10 each + plank 30 sec",
        cooldown:"Shoulder stretch 30 sec each Â· thoracic extension foam roller 2 min Â· shadowbox slow 5 min",
        exercises:[
          {n:"Cable Wood Chops",s:5,r:"12 each side â€” rotational power for knockouts and bedroom"},
          {n:"Russian Twists (weighted)",s:4,r:"25 each side â€” oblique power"},
          {n:"Hanging Leg Raises",s:4,r:"12 â€” lower abs + grip"},
          {n:"Cable Crunches",s:4,r:"20 â€” upper ab power"},
          {n:"Pallof Press",s:3,r:"12 each side â€” anti-rotation core"},
          {n:"Barbell Curls",s:5,r:"8 â€” heavy bicep mass"},
          {n:"Preacher Curls",s:4,r:"10 â€” isolated bicep peak"},
          {n:"Close-Grip Bench Press",s:5,r:"8 â€” heavy tricep power"},
          {n:"Overhead Tricep Extension",s:4,r:"10 â€” full tricep stretch"},
          {n:"Weighted Dips",s:4,r:"12 â€” compound tricep power"},
          {n:"Weighted Plank",s:3,r:"60 sec â€” core stability"},
          {n:"Medicine Ball Slams",s:3,r:"15 â€” explosive core finisher"},
        ]},
      { name:"FRIDAY", type:"OPTIONAL PULL", tag:"Optional Â· Same as Monday Â· Show Up If You Can",
        warmup:"5 min rowing machine + band pull-aparts 2Ã—15 + dead hang 30 sec",
        cooldown:"Lat stretch 30 sec each Â· child's pose 60 sec Â· hamstring hang 60 sec",
        exercises:[
          {n:"Deadlifts",s:4,r:"5 â€” optional but if you are here go heavy"},
          {n:"Pull-ups / Chin-ups",s:4,r:"max reps"},
          {n:"Barbell Rows",s:4,r:"8"},
          {n:"Single-Arm Cable Row",s:3,r:"12 each"},
          {n:"Cable Face Pulls",s:3,r:"20"},
          {n:"Barbell Curls",s:3,r:"8"},
          {n:"Hammer Curls",s:3,r:"12"},
          {n:"Farmer's Walks",s:3,r:"50 yards"},
        ]},
    ]
  },
  bowflex: {
    label: "ðŸ  BOWFLEX",
    color: "#ff6b35",
    days: [
      { name:"MONDAY", type:"PULL", tag:"Back Â· Biceps Â· Grip Â· Bowflex 5-52lbs",
        warmup:"5 min jumping jacks + band pull-aparts 2Ã—15 + dead hang doorframe 30 sec",
        cooldown:"Lat stretch doorway 30 sec each Â· child's pose 60 sec Â· hamstring hang 60 sec",
        exercises:[
          {n:"Bent-Over DB Rows",s:5,r:"8 Â· 35-50lbs â€” primary pulling power"},
          {n:"Single-Arm DB Rows",s:4,r:"10 each Â· 30-45lbs â€” unilateral strength"},
          {n:"Renegade Rows",s:4,r:"12 total Â· 20-30lbs â€” core + pulling combo"},
          {n:"DB Pullovers",s:3,r:"12 Â· 25-35lbs â€” lat expansion"},
          {n:"Reverse Flyes",s:4,r:"15 Â· 10-20lbs â€” rear delt isolation"},
          {n:"DB Shrugs",s:4,r:"15 Â· 40-52lbs â€” upper trap power"},
          {n:"Alternating DB Curls",s:4,r:"10 each Â· 25-40lbs â€” heavy bicep"},
          {n:"Hammer Curls",s:4,r:"12 Â· 20-35lbs â€” forearm strength"},
          {n:"Concentration Curls",s:3,r:"12 each Â· 15-25lbs â€” peak bicep"},
          {n:"Prone Y-Raises",s:3,r:"12 Â· 5-15lbs â€” lower trap activation"},
        ]},
      { name:"TUESDAY", type:"PUSH", tag:"Chest Â· Shoulders Â· Triceps Â· Bowflex",
        warmup:"5 min jumping jacks + arm swings 2Ã—15 + push-up warmup 10/8/6",
        cooldown:"Doorway chest stretch 30 sec Â· shoulder cross-body 30 sec each",
        exercises:[
          {n:"DB Floor Press",s:5,r:"8 Â· 40-52lbs â€” primary chest power"},
          {n:"Incline DB Press",s:4,r:"10 Â· 35-45lbs â€” upper chest"},
          {n:"Single-Arm DB Press",s:4,r:"8 each Â· 30-40lbs â€” unilateral"},
          {n:"DB Push Press",s:5,r:"6 Â· 30-45lbs â€” explosive leg drive to overhead"},
          {n:"DB Shoulder Press",s:4,r:"10 Â· 25-40lbs â€” strict shoulder strength"},
          {n:"Lateral Raises",s:4,r:"15 Â· 10-25lbs â€” side delt isolation"},
          {n:"Close-Grip DB Press",s:4,r:"10 Â· 30-45lbs â€” tricep-focused"},
          {n:"Overhead Tricep Extension",s:4,r:"12 Â· 25-40lbs â€” full tricep stretch"},
          {n:"Tricep Kickbacks",s:3,r:"15 Â· 15-25lbs â€” isolation"},
          {n:"Push-up Variations",s:3,r:"max reps â€” bodyweight finisher"},
        ]},
      { name:"WEDNESDAY", type:"LEGS", tag:"Legs Â· Glutes Â· Hip Power Â· Bowflex",
        warmup:"5 min jumping jacks + glute bridges 2Ã—15 + hip circles 10 each",
        cooldown:"Pigeon pose 90 sec each Â· deep squat hold 2 min Â· couch stretch 2 min each",
        exercises:[
          {n:"Goblet Squats",s:5,r:"10 Â· 40-52lbs â€” primary squat"},
          {n:"Romanian Deadlifts",s:5,r:"8 Â· 40-52lbs â€” hip hinge power"},
          {n:"Bulgarian Split Squats",s:4,r:"12 each Â· 25-40lbs"},
          {n:"DB Hip Thrusts",s:4,r:"15 Â· 35-52lbs â€” maximum glute. Most important."},
          {n:"DB Lunges",s:4,r:"20 total Â· 20-35lbs"},
          {n:"Single-Leg Deadlifts",s:3,r:"10 each Â· 15-30lbs"},
          {n:"Lateral Lunges",s:3,r:"12 each Â· 20-35lbs"},
          {n:"Calf Raises",s:4,r:"20 Â· 30-45lbs"},
          {n:"Jump Squats",s:4,r:"12 â€” bodyweight explosive"},
        ]},
      { name:"THURSDAY", type:"ARMS + CORE", tag:"Core Â· Arms Â· Rotational Power Â· Bowflex",
        warmup:"5 min jumping jacks + plank 30 sec + hip circles 10 each",
        cooldown:"Full body stretch 5 min Â· shadowbox slow 3 min",
        exercises:[
          {n:"Russian Twists (DB)",s:4,r:"25 each Â· 15-30lbs â€” rotational core power"},
          {n:"DB Wood Chops",s:4,r:"12 each Â· 20-35lbs â€” diagonal core power"},
          {n:"Weighted Plank",s:3,r:"45 sec Â· 15-25lbs on back"},
          {n:"Alternating DB Curls",s:5,r:"8 each Â· 30-45lbs â€” heavy bicep"},
          {n:"Hammer Curls",s:4,r:"12 Â· 25-40lbs â€” forearm power"},
          {n:"Overhead Tricep Extension",s:5,r:"10 Â· 30-45lbs â€” full stretch"},
          {n:"Tricep Kickbacks",s:4,r:"15 Â· 15-25lbs â€” peak contraction"},
          {n:"21s Bicep Curls",s:2,r:"21 total Â· 15-25lbs â€” 7 bottom + 7 top + 7 full"},
          {n:"Renegade Rows",s:3,r:"12 total Â· 15-25lbs"},
          {n:"Mountain Climbers",s:3,r:"30 sec â€” dynamic core finisher"},
        ]},
      { name:"FRIDAY", type:"OPTIONAL PULL", tag:"Optional Â· Same as Monday Â· Show Up",
        warmup:"5 min jumping jacks + band pull-aparts 2Ã—15",
        cooldown:"Lat stretch 30 sec each Â· child's pose 60 sec",
        exercises:[
          {n:"Bent-Over DB Rows",s:4,r:"8 Â· 35-50lbs"},
          {n:"Single-Arm DB Rows",s:4,r:"10 each Â· 30-45lbs"},
          {n:"Renegade Rows",s:3,r:"12 total Â· 20-30lbs"},
          {n:"Alternating DB Curls",s:4,r:"10 each Â· 25-40lbs"},
          {n:"Hammer Curls",s:3,r:"12 Â· 20-35lbs"},
          {n:"Reverse Flyes",s:3,r:"15 Â· 10-20lbs"},
        ]},
    ]
  },
  bands: {
    label: "ðŸŽ½ BANDS",
    color: "#ffcc00",
    days: [
      { name:"MONDAY", type:"PULL", tag:"Back Â· Biceps Â· Resistance Bands",
        warmup:"5 min jumping jacks + band pull-aparts 2Ã—20 + dead hang doorframe 30 sec",
        cooldown:"Lat stretch doorway 30 sec each Â· child's pose 60 sec",
        exercises:[
          {n:"Band Pull-Aparts",s:5,r:"30 â€” high speed rear delt activation"},
          {n:"Seated Band Rows",s:5,r:"20 â€” anchor low, primary pulling"},
          {n:"Single-Arm Band Rows",s:4,r:"15 each â€” unilateral pulling"},
          {n:"Face Pulls (band)",s:4,r:"25 â€” anchor chest height, external rotation"},
          {n:"High Band Pulls",s:4,r:"20 â€” anchor high, lat development"},
          {n:"Band Bicep Curls",s:4,r:"20 â€” step on band, curl up"},
          {n:"Band Hammer Curls",s:3,r:"20 â€” neutral grip forearm"},
          {n:"Reverse Flyes (band)",s:3,r:"25 â€” rear delt isolation"},
        ]},
      { name:"TUESDAY", type:"PUSH", tag:"Chest Â· Shoulders Â· Triceps Â· Bands",
        warmup:"5 min jumping jacks + arm swings 2Ã—15 + push-up warmup",
        cooldown:"Doorway chest stretch 30 sec Â· shoulder cross-body 30 sec each",
        exercises:[
          {n:"Band Chest Press",s:5,r:"20 â€” anchor behind, primary pressing"},
          {n:"Band Shoulder Press",s:5,r:"15 â€” step on band, press overhead"},
          {n:"Single-Arm Band Press",s:4,r:"15 each â€” unilateral"},
          {n:"Lateral Raises (band)",s:4,r:"20 â€” side delt isolation"},
          {n:"Overhead Tricep Extension (band)",s:4,r:"20 â€” anchor low, extend overhead"},
          {n:"Tricep Pushdowns (band)",s:4,r:"20 â€” anchor high, push down"},
          {n:"Band-Resisted Push-ups",s:3,r:"15 â€” band across back"},
          {n:"Speed Chest Press",s:3,r:"30 sec â€” maximum speed for power"},
        ]},
      { name:"WEDNESDAY", type:"LEGS", tag:"Legs Â· Glutes Â· Hip Power Â· Bands",
        warmup:"5 min jumping jacks + glute bridges 2Ã—15 + hip circles",
        cooldown:"Pigeon pose 90 sec each Â· deep squat hold 2 min",
        exercises:[
          {n:"Band Squats",s:5,r:"25 â€” step on band, handles at shoulders"},
          {n:"Band Hip Thrusts",s:4,r:"20 â€” band across hips, anchor both ends. Most important."},
          {n:"Band Romanian Deadlifts",s:4,r:"20 â€” step on band, hip hinge"},
          {n:"Band Lunges",s:4,r:"15 each â€” step on band with front foot"},
          {n:"Glute Bridges + Band",s:4,r:"25 â€” mini band around knees"},
          {n:"Lateral Band Walks",s:4,r:"20 each direction â€” mini band ankles"},
          {n:"Monster Walks",s:3,r:"15 each direction â€” mini band, forward steps"},
          {n:"Jump Squats + Band",s:4,r:"15 â€” explosive power with resistance"},
        ]},
      { name:"THURSDAY", type:"ARMS + CORE", tag:"Core Â· Arms Â· Rotational Power Â· Bands",
        warmup:"5 min jumping jacks + plank 30 sec",
        cooldown:"Full body stretch 5 min Â· shadowbox slow 3 min",
        exercises:[
          {n:"Band Wood Chops",s:4,r:"20 each side â€” diagonal rotational power"},
          {n:"Pallof Press (band)",s:3,r:"15 each side â€” anti-rotation"},
          {n:"Band Bicep Curls",s:5,r:"20 â€” constant tension"},
          {n:"Overhead Tricep Extension (band)",s:5,r:"20 â€” full stretch"},
          {n:"Hammer Curls (band)",s:4,r:"20 â€” forearm strength"},
          {n:"Tricep Pushdowns (band)",s:4,r:"20 â€” peak contraction"},
          {n:"Russian Twists (hold band handles)",s:4,r:"25 each side"},
          {n:"Plank + Pull-Aparts",s:3,r:"45 sec â€” core stability while pulling"},
        ]},
      { name:"FRIDAY", type:"OPTIONAL PULL", tag:"Optional Â· Same as Monday Â· Show Up",
        warmup:"5 min jumping jacks + band pull-aparts 2Ã—20",
        cooldown:"Lat stretch 30 sec each Â· child's pose 60 sec",
        exercises:[
          {n:"Band Pull-Aparts",s:4,r:"30"},
          {n:"Seated Band Rows",s:4,r:"20"},
          {n:"Face Pulls (band)",s:3,r:"25"},
          {n:"Band Bicep Curls",s:4,r:"20"},
          {n:"Band Hammer Curls",s:3,r:"20"},
        ]},
    ]
  },
  bodyweight: {
    label: "ðŸ’ª BODYWEIGHT",
    color: "#6699ff",
    days: [
      { name:"MONDAY", type:"PULL", tag:"Back Â· Biceps Â· Bodyweight Only",
        warmup:"5 min jumping jacks + arm circles + dead hang 30 sec if bar available",
        cooldown:"Lat stretch doorway 30 sec each Â· child's pose 60 sec Â· hamstring hang 60 sec",
        exercises:[
          {n:"Pull-ups / Chin-ups",s:5,r:"max reps â€” king of bodyweight pulling"},
          {n:"Inverted Rows",s:4,r:"15 â€” under table or bar"},
          {n:"Superman Pulls",s:4,r:"20 â€” prone pulling motion"},
          {n:"Reverse Snow Angels",s:3,r:"25 â€” rear delt activation"},
          {n:"Dead Hangs",s:3,r:"max time â€” grip strength"},
          {n:"Prone Y-T-W Raises",s:3,r:"30 total â€” 10 each position"},
          {n:"Wall Handstand Hold",s:3,r:"30 sec â€” shoulder stability"},
        ]},
      { name:"TUESDAY", type:"PUSH", tag:"Chest Â· Shoulders Â· Triceps Â· Bodyweight",
        warmup:"5 min jumping jacks + arm swings 2Ã—15 + push-up warmup",
        cooldown:"Doorway chest stretch 30 sec Â· shoulder stretch 30 sec each",
        exercises:[
          {n:"Standard Push-ups",s:5,r:"20 â€” perfect form foundation"},
          {n:"Diamond Push-ups",s:4,r:"12 â€” tricep-focused"},
          {n:"Wide-Grip Push-ups",s:4,r:"15 â€” chest-focused"},
          {n:"Pike Push-ups",s:4,r:"12 â€” shoulder-focused"},
          {n:"Clap Push-ups",s:3,r:"8 â€” explosive plyometric"},
          {n:"Chair Dips",s:4,r:"15 â€” tricep compound"},
          {n:"Hindu Push-ups",s:3,r:"12 â€” dynamic full-body"},
          {n:"Burpees",s:4,r:"10 â€” full-body explosive"},
        ]},
      { name:"WEDNESDAY", type:"LEGS", tag:"Legs Â· Glutes Â· Hip Power Â· Bodyweight",
        warmup:"5 min jumping jacks + glute bridges 2Ã—15 + hip circles",
        cooldown:"Pigeon pose 90 sec each Â· deep squat hold 2 min Â· couch stretch 2 min each",
        exercises:[
          {n:"Bodyweight Squats",s:5,r:"30 â€” high-volume foundation"},
          {n:"Jump Squats",s:4,r:"20 â€” explosive power"},
          {n:"Glute Bridges",s:4,r:"30 â€” maximum glute squeeze. Most important."},
          {n:"Single-Leg Glute Bridges",s:3,r:"20 each â€” unilateral hip strength"},
          {n:"Walking Lunges",s:4,r:"30 steps"},
          {n:"Reverse Lunges",s:4,r:"20 each â€” controlled"},
          {n:"Broad Jumps",s:4,r:"8 â€” forward explosive power"},
          {n:"Wall Sit",s:3,r:"90 sec â€” isometric endurance"},
        ]},
      { name:"THURSDAY", type:"ARMS + CORE", tag:"Core Â· Arms Â· Rotational Power Â· Bodyweight",
        warmup:"5 min jumping jacks + plank 30 sec + hip circles",
        cooldown:"Full body stretch 5 min Â· shadowbox slow 3 min",
        exercises:[
          {n:"Russian Twists",s:4,r:"30 each side â€” explosive rotational"},
          {n:"Plank",s:4,r:"60 sec â€” core stability"},
          {n:"Mountain Climbers",s:4,r:"40 sec â€” dynamic core power"},
          {n:"V-Ups",s:4,r:"20 â€” full ab contraction"},
          {n:"Chin-ups (bicep focus)",s:5,r:"max reps â€” underhand grip"},
          {n:"Diamond Push-ups",s:5,r:"15 â€” maximum tricep"},
          {n:"Chair Dips",s:4,r:"20 â€” compound tricep"},
          {n:"Burpees",s:3,r:"15 â€” full-body finisher"},
        ]},
      { name:"FRIDAY", type:"OPTIONAL PULL", tag:"Optional Â· Same as Monday Â· Show Up",
        warmup:"5 min jumping jacks + arm circles",
        cooldown:"Lat stretch 30 sec each Â· child's pose 60 sec",
        exercises:[
          {n:"Pull-ups / Chin-ups",s:5,r:"max reps"},
          {n:"Inverted Rows",s:4,r:"15"},
          {n:"Superman Pulls",s:3,r:"20"},
          {n:"Dead Hangs",s:3,r:"max time"},
          {n:"Prone Y-T-W Raises",s:3,r:"30 total"},
        ]},
    ]
  }
};



// Body fix routines added to every workout day
const BODY_FIX = [
  {n:"Chin Tucks (10 Ã— 5 sec holds)", detail:"Pull chin straight back â€” make a double chin. Hold 5 sec. Release. #1 tech neck fix. Do every hour at desk too.", type:"techneck"},
  {n:"Cat-Cow (10 slow reps)", detail:"Hands and knees. Arch fully (cow) then round fully (cat). Slow. Decompresses spine, relieves sciatic pressure.", type:"sciatica"},
  {n:"Piriformis Stretch (60 sec each side)", detail:"Sit in chair, cross right ankle over left knee, sit tall, lean forward gently. Deep burn in glute = sciatic nerve releasing.", type:"sciatica"},
  {n:"Hip Flexor Stretch (2 min each side)", detail:"Kneeling lunge, back knee down, sink hips forward and down. Tight hip flexors cause sciatica AND restrict sexual performance.", type:"mobility"},
  {n:"Standing Hamstring Hang (60 sec)", detail:"Feet hip width, soft knees, fold forward, hang completely. Don't force â€” gravity does the work. Daily consistency = toes in 8 weeks.", type:"flexibility"},
  {n:"Doorway Chest Stretch (30 sec)", detail:"Arms at 90Â° on doorframe, step through gently. Reverses the forward rounding that causes tech neck.", type:"techneck"},
  {n:"Couch Stretch (2 min each side)", detail:"Back foot elevated on couch or bench, front foot forward, sink hips straight down. Best hip flexor stretch available.", type:"mobility"},
  {n:"Child's Pose (60 sec)", detail:"Sit back on heels, arms stretched forward, forehead to ground. Decompresses entire lower spine. Sciatica's enemy.", type:"sciatica"},
];

const FRIDAY_PLAN = [
  {t:"20 min incline walk â€” easy conversational pace", d:"15% / 2.5mph. Blood flow only. Not a workout. Active recovery."},
  {t:"Foam rolling â€” full body", d:"Quads 2 min Â· hamstrings 2 min Â· glutes 2 min Â· upper back 2 min Â· calves 1 min. Slow, find the tight spots."},
  {t:"Band pull-aparts 3Ã—20", d:"Directly fixes tech neck and rounded shoulders. Light band, squeeze shoulder blades at end."},
  {t:"Face pulls 3Ã—15", d:"Shoulder health and posture. Do these every Friday without fail."},
  {t:"Weighted hip thrusts 3Ã—10", d:"Moderate weight only â€” 60% of your max. Maintain glute activation going into Saturday."},
  {t:"Pallof press 3Ã—12 each side", d:"Core anti-rotation. Keeps your punch power foundation intact."},
  {t:"Plank 3Ã—45 sec", d:"Core maintenance. Focus on breathing not just surviving."},
  {t:"Shadowboxing 10 min", d:"Stay sharp for Saturday. Focus on combinations and footwork, not intensity."},
  {t:"Chin tucks 3Ã—10 (hold 5 sec each)", d:"Tech neck fix â€” most important single exercise for forward head posture. Do slowly."},
  {t:"Cat-cow 10 reps", d:"Spine mobility. Sciatica prevention. Do first thing every morning too."},
  {t:"Piriformis stretch 60 sec each side", d:"Non-negotiable. Prevents sciatica flare on Saturday from HIIT."},
  {t:"Hip flexor stretch 2 min each side", d:"Releases 4 days of compression. Couch stretch is best version."},
  {t:"Standing hamstring hang 60 sec", d:"Gravity does the work. Don't force it. Consistency = touching toes by week 8."},
];

const SATURDAY_PLAN = [
  {t:"Eat solid meal 90 min before", d:"Rice + chicken + banana. Complex carbs for sustained HIIT energy. Not too heavy."},
  {t:"Hydrate 1 liter before training starts", d:"HIIT + Vyvanse = highest sweat day of the week. Start hydrated."},
  {t:"Pre-workout capsules taken", d:"L-Arg/Citrulline + Fish Oil. Blood flow for max performance."},
  {t:"HIIT Training â€” leave nothing", d:"This is your peak conditioning day. Every interval at 90%+. This is what lowers BP fastest."},
  {t:"Martial Arts â€” apply your training", d:"Hip thrusts = punch power. Cable rotations = strike speed. You will feel the difference by week 4."},
  {t:"Post-training stretch 10 min minimum", d:"Hips, hamstrings, shoulders, neck. Saturday recovery determines how Monday feels."},
  {t:"Piriformis stretch 60 sec each side", d:"Do this immediately after class. HIIT compresses the sciatic nerve. Release it now."},
  {t:"Cold shower â€” 30 sec cold finish", d:"Reduces inflammation, boosts blood flow rebound, testosterone response. Do it."},
  {t:"Protein shake within 30 min", d:"Muscle repair window is wide open. 31g protein + creatine. Don't skip this."},
  {t:"500ml+ water before bed", d:"Replace sweat losses. Creatine and magnesium need water to work overnight."},
];

const SUNDAY_PLAN = [
  {t:"No alarm â€” sleep until body wakes naturally", d:"Most testosterone and growth hormone produced in final sleep cycles. Don't cut them short."},
  {t:"Morning sunlight 20â€“30 min outside", d:"Resets your cortisol rhythm which improves sleep quality all week. Phone away."},
  {t:"Highest protein day â€” 180g+ minimum", d:"Muscles have been repairing all week. Sunday is the biggest repair day. Feed them aggressively."},
  {t:"3+ liters water throughout the day", d:"Recovery rate is directly tied to hydration. Creatine specifically needs water to work."},
  {t:"2 full rounds of body fix stretches", d:"Tech neck, sciatica, and flexibility all improve through Sunday consistency not gym sessions."},
  {t:"Kegels + Reverse Kegels", d:"Even on rest day. Pelvic floor is trained like any other muscle â€” daily consistency."},
  {t:"Pill pack prep for the week", d:"Fill all pouches now. Sunday prep = zero friction Monday through Saturday."},
  {t:"Meal prep proteins for the week", d:"Cook chicken, ground beef, eggs in bulk. Remove the excuse of not eating enough."},
  {t:"Set out gym bag and clothes for Monday", d:"Decision fatigue is real. Eliminate it tonight."},
  {t:"No screens 30 min before bed", d:"Blue light suppresses melatonin by 50%. Night mode is not enough. Put the phone down."},
  {t:"L-Theanine + Magnesium Glycinate combo (3 softgels) before bed", d:"Most important dose of the week. 10pm every night. This is what stops the 3-4am waking and locks in full testosterone recovery."},
  {t:"In bed by 10:30â€“11pm", d:"8 hrs before 7am. This one habit compounds everything else in the program."},
];

// PILL PACKS organized by time of day
const PILL_PACKS = [
  {
    id:'morning', time:'ðŸ”´ MORNING PACK', emoji:'ðŸŒ…', color:'#00ff88',
    note:'With breakfast BEFORE Vyvanse kicks in Â· every day',
    items:[
      {n:"BIRDMAN Falcon Vegan Protein (already have)", dose:"1 scoop â€” REST DAYS ONLY", benefit:"31g protein + 5g creatine + 5g BCAA + probiotics Â· on training days take post-workout instead Â· already includes creatine"},
      {n:"Zinc Picolinate 30mg", dose:"1 softgel", benefit:"ðŸ”´ NON-NEGOTIABLE Â· testosterone Â· load volume Â· immunity"},
      {n:"Vitamin D3 5,000 IU + K2", dose:"1 softgel", benefit:"ðŸ”´ NON-NEGOTIABLE Â· testosterone Â· calcium to bones not arteries"},
      {n:"Ashwagandha 300mg", dose:"1 softgel", benefit:"ðŸŸ¡ HIGH VALUE Â· cortisol down Â· testosterone up Â· take with food"},
      {n:"Sunflower Lecithin 1,600mg", dose:"2 softgels", benefit:"ðŸŸ¡ HIGH VALUE Â· girth Â· volume Â· phosphatidylcholine for engorgement"},
      {n:"Hair, Skin & Nails 22-in-1 (Micro Ingredients)", dose:"3 softgels", benefit:"ðŸŸ¢ BONUS Â· Biotin 5,000mcg Â· Collagen Â· Keratin Â· Hyaluronic Acid Â· hair thickness Â· skin quality Â· also contains Zinc 10mg + D3 1,000 IU"},
    ]
  },
  {
    id:'postworkout', time:'ðŸ’ª POST-WORKOUT PACK', emoji:'ðŸ’ª', color:'#00ff88',
    note:'Within 30 min of finishing â€” TRAINING DAYS ONLY (Monâ€“Thu + Sat)',
    items:[
      {n:"BIRDMAN Falcon Vegan Protein (already have)", dose:"1 scoop in water/milk", benefit:"ðŸ”´ NON-NEGOTIABLE on training days Â· 31g protein + 5g creatine already included Â· muscle repair window Â· take within 30 min of finishing"},
      {n:"L-Glutamine", dose:"5g powder mixed in shake", benefit:"ðŸŸ¢ BONUS Â· reduces soreness Â· gut health Â· faster recovery between sessions"},
    ]
  },
  {
    id:'preworkout', time:'âš¡ PRE-WORKOUT PACK', emoji:'âš¡', color:'#ff6b35',
    note:'30â€“45 min before training â€” Mon/Tue/Wed/Thu only',
    items:[
      {n:"Nitric Oxide Booster 3,600mg â€” L-Arginine 2,400mg + L-Citrulline 1,200mg (Micro Ingredients)", dose:"3 tablets", benefit:"ðŸ”´ NON-NEGOTIABLE Â· max strength nitric oxide Â· blood flow Â· BP Â· erection quality Â· take 30-45 min pre-workout"},
      {n:"Beet Root 3,000mg + Grape Seed Extract + CoQ10 (Micro Ingredients)", dose:"2 tablets", benefit:"ðŸŸ¡ HIGH VALUE Â· nitric oxide booster Â· antioxidant Â· heart health Â· stacks with Nitric Oxide Booster for maximum blood flow"},
      {n:"Fish Oil 4,200mg", dose:"3 softgels", benefit:"ðŸ”´ NON-NEGOTIABLE Â· cardiovascular protection Â· inflammation Â· brain function"},
    ]
  },
  {
    id:'evening', time:'ðŸŒ™ EVENING PACK', emoji:'ðŸŒ™', color:'#6699ff',
    note:'30â€“60 min before bed Â· every single night Â· most important pack',
    items:[
      {n:"L-Theanine 200mg + Magnesium Glycinate 200mg combo (Micro Ingredients)", dose:"3 softgels at 10pm", benefit:"ðŸ”´ NON-NEGOTIABLE Â· cortisol down Â· deep sleep Â· BP down Â· stops 3-4am waking Â· full testosterone recovery Â· do NOT take in the morning with Vyvanse"},
      {n:"Ashwagandha 300mg (2nd dose)", dose:"1 softgel", benefit:"ðŸŸ¡ HIGH VALUE Â· 600mg total = clinical testosterone dose"},
    ]
  },
];

// Flat list for checkbox tracking
const SUPPLEMENTS = PILL_PACKS.flatMap(p=>p.items);

// Sunday prep checklist for packing the week
const PREP_CHECKLIST = [
  {t:"Fill 7 MORNING pouches", d:"Zinc + D3/K2 + Ashwagandha + Lecithin Â· label M/T/W/TH/F/SA/SU Â· check AM box"},
  {t:"Fill 4 PRE-WORKOUT pouches", d:"L-Arg/Citrulline capsules + Fish Oil Â· label MON/TUE/WED/THU only"},
  {t:"Fill 7 POST-WORKOUT pouches (training days)", d:"Pre-measure protein shake scoops + L-Glutamine into bags Â· label training days"},
  {t:"Fill 7 EVENING pouches", d:"Magnesium Glycinate + Ashwagandha 2nd dose Â· label each day Â· check PM box"},
  {t:"Check Zinc supply", d:"ðŸ”´ NON-NEGOTIABLE Â· make sure you have enough for the week"},
  {t:"Check Fish Oil supply", d:"ðŸ”´ NON-NEGOTIABLE Â· 3 softgels per training day Â· burns through fast"},
  {t:"Check Magnesium Glycinate supply", d:"ðŸ”´ NON-NEGOTIABLE Â· 3 softgels every night"},
  {t:"Set pouches out somewhere visible", d:"Kitchen counter or gym bag â€” out of sight = forgotten"},
  {t:"Restock anything running low", d:"Order now not when you run out"},
  {t:"Meal prep proteins for the week", d:"Chicken, ground beef, eggs â€” cook in bulk, refrigerate"},
  {t:"Set out gym bag and workout clothes", d:"Remove every excuse not to go Monday morning"},
];

const SEX_CHECKLIST = [
  {n:"Kegels â€” 10 Ã— 5 sec holds", d:"Squeeze pelvic floor hard, hold 5 sec, release fully. Traps blood = harder erections + more girth"},
  {n:"Reverse Kegels â€” 10 reps", d:"Consciously push out and relax completely. Trains full control â€” harder in, longer out"},
  {n:"Deep squat hold 2 min", d:"Opens hips, drives blood flow to pelvis. Do it daily not just at gym"},
  {n:"Hip flexor stretch 2 min each side", d:"Tight hip flexors restrict pelvic blood flow and limit depth and power"},
  {n:"L-Arginine + L-Citrulline capsules taken", d:"Nitric oxide = wider blood vessels = maximum engorgement. Take pre-workout or morning"},
  {n:"Sunflower Lecithin taken", d:"Phosphatidylcholine directly increases fluid volume and fullness. Daily is mandatory"},
  {n:"No alcohol today", d:"Even 2 drinks drops testosterone 24 hrs. Kills engorgement quality directly"},
  {n:"NO FAP Â· NO PORN TODAY", d:"TRACK THIS â€” tap YES I stayed clean or NO I slipped", type:"porn"},
  {n:"Cold shower finish", d:"30 sec cold on lower abdomen at end of shower. Rebound blood flow effect when warming up"},
  {n:"8+ hours sleep tonight", d:"Testosterone is produced during deep sleep. Every hour under 7 measurably drops your levels"},
];

// Grouped habits â€” each has an id (stable key), category, icon, label, and day-specific instructions
const HABIT_GROUPS = [
  {
    id:"training", icon:"ðŸ’ª", label:"TRAINING", color:"#00ff88",
    habits:[
      { id:0, icon:"ðŸ“", label:"Weights logged in app",
        detail:"Log EVERY set right after finishing it. Takes 10 seconds. No logging = no proof you showed up.",
        days:{MON:"Pull day. Deadlifts through Dead Hangs. Log each set weight.",TUE:"Push day. Bench through Battle Ropes. Log it all.",WED:"Legs day. Squats through Hip Thrusts. These are your most important logs.",THU:"Arms+Core day. Wood Chops through Med Ball Slams.",FRI:"Optional Pull. Log if you showed up.",SAT:"Fight day. No weight logging needed.",SUN:"Rest day."}
      },
      { id:1, icon:"ðŸ§˜", label:"Body fix stretches done",
        detail:"Tech neck, sciatica, flexibility stretches after your workout. See Workout tab cooldown section.",
        days:{MON:"After Pull. Lat stretch, childs pose, hamstring hang.",TUE:"After Push. Doorway chest stretch, shoulder cross-body.",WED:"After Legs. Pigeon 90 sec each side, couch stretch 2 min each.",THU:"After Arms+Core. Shoulder stretch, thoracic foam roller.",FRI:"Optional. Same as Monday cooldown.",SAT:"After martial arts. Hips, hamstrings, piriformis 60 sec each side. Non-negotiable.",SUN:"Full 2 rounds. Sunday is where flexibility actually improves."}
      },
    ]
  },
  {
    id:"health", icon:"â¤ï¸", label:"HEALTH", color:"#ff6b35",
    habits:[
      { id:2, icon:"ðŸ’Š", label:"All supplement packs taken",
        detail:"Morning pack + evening pack minimum. Pre/post workout on training days. Every single day.",
        days:{MON:"Morning pack before Vyvanse. Pre-workout 30 min before gym. Post-workout shake within 30 min.",TUE:"Same as Monday. Pre-workout before Push session.",WED:"Same. Pre-workout before Legs. This is your hardest session.",THU:"Same. Pre-workout before Arms+Core.",FRI:"Morning + evening packs. Optional pre-workout if you go.",SAT:"Morning pack. Pre-workout before HIIT. Post-workout shake within 30 min.",SUN:"Morning + evening packs only. No pre-workout on rest day."}
      },
      { id:3, icon:"ðŸ’§", label:"3 liters water minimum",
        detail:"Creatine needs water to work. Magnesium needs water. Everything needs water. Track it.",
        days:{MON:"Training day. Push 3.5L. Vyvanse suppresses thirst. Set a reminder.",TUE:"Training day. 3.5L minimum.",WED:"Legs day. Hardest session. 4L target today.",THU:"Training day. 3.5L.",FRI:"3L minimum even if you skip gym.",SAT:"HIIT + martial arts = highest sweat day. 4L minimum. Start hydrated.",SUN:"3L. Recovery rate is directly tied to hydration."}
      },
      { id:4, icon:"ðŸ¥©", label:"150-180g protein hit",
        detail:"Muscle repair only happens if protein is high enough. Vyvanse kills appetite. Plan around it.",
        days:{MON:"Eat big before Vyvanse kicks in. Protein shake mid-day. Big meal at night.",TUE:"Same strategy. Chicken or beef at dinner. Shake counts toward total.",WED:"Legs day recovery. Highest protein need. 180g target today.",THU:"Same. Arms need protein to grow.",FRI:"Standard 150g minimum.",SAT:"Post-workout window is open. Hit 180g. Biggest muscle repair day of the week.",SUN:"180g+ minimum. This is your peak muscle repair day. Feed them."}
      },
      { id:5, icon:"ðŸ˜´", label:"7-9 hours sleep",
        detail:"Testosterone is made during sleep. Growth hormone peaks in last 2 sleep cycles. 10pm bedtime.",
        days:{MON:"In bed by 10pm. L-Theanine + Magnesium already taken. Phone away.",TUE:"Same. 10pm. No exceptions.",WED:"Hardest training day tomorrow (Legs). Sleep is your pre-workout.",THU:"Last hard training day of the week. Recovery starts tonight.",FRI:"Optional gym tomorrow. Still sleep 8 hours.",SAT:"Fight day recovery. Best sleep of the week. No alarm if possible.",SUN:"No alarm. Sleep until body wakes. Final sleep cycles = peak testosterone production."}
      },
      { id:6, icon:"â¤ï¸", label:"BP-friendly day",
        detail:"No excess sodium, no alcohol. Consistent training and diet is lowering your BP week by week.",
        days:{MON:"Avoid processed food sodium. Cook if you can.",TUE:"Same.",WED:"Same.",THU:"Same.",FRI:"End of training week. Do not celebrate with alcohol.",SAT:"Fight day. Eat clean. Your BP is measured by how you perform today.",SUN:"Prep your meals for the week. Clean food = lower BP all week."}
      },
      { id:7, icon:"ðŸ½ï¸", label:"Big meal when Vyvanse wears off",
        detail:"Evening is when your appetite returns. Do not skip this meal. This is when your body gets most of its calories.",
        days:{MON:"7-8pm window. Protein + carbs. Rice, chicken, vegetables.",TUE:"Same window.",WED:"Legs recovery. Make this your biggest meal of the week.",THU:"Same.",FRI:"Relax and eat well tonight.",SAT:"Post-workout + post-martial arts. You burned everything. Eat big.",SUN:"Meal prep day. Cook in bulk so you have no excuse all week."}
      },
    ]
  },
  {
    id:"grooming", icon:"ðŸª¥", label:"GROOMING", color:"#6699ff",
    habits:[
      { id:8, icon:"ðŸ¦·", label:"Brushed teeth morning + night",
        detail:"2 minutes each time. Electric toothbrush if you have one. No shortcuts.",
        days:{MON:"Before Vyvanse in morning. Before L-Theanine at night.",TUE:"Same.",WED:"Same.",THU:"Same.",FRI:"Same.",SAT:"Before going out. You are building a life where people want to be close to you. Act like it.",SUN:"Morning + night. Takes 4 minutes total. Do not skip the Sunday night brush."}
      },
      { id:9, icon:"ðŸ§µ", label:"Flossed tonight",
        detail:"60 seconds. Gum disease kills your confidence up close. Do it.",
        days:{MON:"After night brush. Before bed routine.",TUE:"Same.",WED:"Same.",THU:"Same.",FRI:"Same.",SAT:"Non-negotiable especially before going out.",SUN:"Same."}
      },
      { id:10, icon:"ðŸ§´", label:"Skincare routine done",
        detail:"Morning AND night. Micellar water to Toner to Vitamin C to Moisturizer (AM). Cleansing oil to Exfoliant to Niacinamide to Moisturizer (PM).",
        days:{MON:"WARNING: Do NOT use Some By Mi toner same night as Minoxidil. Alternate nights.",TUE:"Some By Mi toner okay tonight if you did Minoxidil last night.",WED:"Check your Minoxidil rotation.",THU:"Same rotation check.",FRI:"Exfoliant toner if you have not used it in 2 days.",SAT:"After shower. Skin is open from heat. Apply everything within 60 sec of drying.",SUN:"Full routine morning and night. Sunday skin = Monday confidence."}
      },
      { id:11, icon:"ðŸ§”", label:"Beard regimen done",
        detail:"Minoxidil foam twice daily on damp skin. Dermaroller Wed + Sat only. Beard oil daily after foam absorbs.",
        days:{MON:"Minoxidil AM + PM on damp skin. Half cap each time. Beard oil after it absorbs.",TUE:"Same AM + PM application.",WED:"DERMAROLLER DAY. Roll before bed. Do NOT apply Minoxidil tonight. Apply tomorrow morning instead.",THU:"Minoxidil AM + PM. No dermaroller today.",FRI:"Minoxidil AM + PM. Beard oil.",SAT:"DERMAROLLER DAY. Same as Wednesday. Roll tonight, skip Minoxidil tonight only.",SUN:"Minoxidil AM + PM. Beard oil. Castor oil on scalp optional."}
      },
      { id:12, icon:"ðŸ¦¶", label:"Foot routine done",
        detail:"Tea Tree wash in shower. Dry completely. THENA Foot Balm on heels. Tea Tree Balm between toes. Odor-X spray in shoes.",
        days:{MON:"Shower with Tea Tree body wash. Scrub feet specifically. Balm after.",TUE:"Same.",WED:"After Legs workout. Feet are sweating more. Double up on balm today.",THU:"Same standard routine.",FRI:"Same.",SAT:"Post-HIIT and martial arts. Foot wipes at gym before fresh socks. Full routine at home after.",SUN:"CALLUS REMOVER DAY. Electric callus remover on heels and ball of foot. Dead skin is the root cause of odor."}
      },
      { id:13, icon:"ðŸš¿", label:"Exfoliating gloves in shower",
        detail:"3x per week on Monday, Wednesday, Saturday. Full body including back and butt where acne lives.",
        days:{MON:"GLOVE DAY. Full body scrub. Back, butt, arms, legs.",TUE:"No gloves today. Skin needs recovery.",WED:"GLOVE DAY. Full body scrub.",THU:"No gloves today.",FRI:"No gloves today.",SAT:"GLOVE DAY. Especially before or after HIIT. Removes sweat-clogged dead skin.",SUN:"No gloves today."}
      },
      { id:14, icon:"ðŸ’Š", label:"Chlorophyll drops taken",
        detail:"Internal deodorant. Reduces body odor and foot odor from the inside. Take daily as directed.",
        days:{MON:"Morning with water. Before Vyvanse if possible.",TUE:"Same.",WED:"Same.",THU:"Same.",FRI:"Same.",SAT:"Take before HIIT. High sweat day. Chlorophyll works from inside out.",SUN:"Same. Consistency is what makes it work."}
      },
      { id:15, icon:"ðŸ’§", label:"Liquid Biotin + Collagen taken",
        detail:"Beard + hair growth from inside. Works with Minoxidil. Take daily as directed.",
        days:{MON:"With morning water. Stacks with Minoxidil for beard growth.",TUE:"Same.",WED:"Same.",THU:"Same.",FRI:"Same.",SAT:"Same.",SUN:"Same."}
      },
    ]
  },
  {
    id:"skills", icon:"ðŸ§ ", label:"SKILLS", color:"#ffcc00",
    habits:[
      { id:16, icon:"ðŸ¥Š", label:"Kegels done",
        detail:"10 regular + 10 reverse. Can be done anywhere. Non-negotiable every single day.",
        days:{MON:"Morning while waiting for coffee. 10 regular hold 5 sec. 10 reverse push out 5 sec.",TUE:"Any time during day.",WED:"Morning.",THU:"Morning.",FRI:"Morning.",SAT:"Before and after training if possible. Fight day = pelvic floor day.",SUN:"Rest day but kegels are still training. Do them."}
      },
      { id:17, icon:"ðŸ‡«ðŸ‡·", label:"French practice 10 min min",
        detail:"Pingo AI or Udemy course. 10 minutes minimum. Consistency beats intensity.",
        days:{MON:"Pingo AI session during lunch or after dinner. New vocabulary.",TUE:"Udemy lesson if you have not watched one this week.",WED:"Pingo conversation practice.",THU:"Udemy or Pingo. Whatever you have not done.",FRI:"Review this week on Pingo.",SAT:"Light practice only. Fight day is exhausting.",SUN:"Best day for a longer Udemy session. 20-30 min if you can."}
      },
      { id:18, icon:"ðŸ¥‹", label:"Street Tactics studied",
        detail:"Watch 1 lesson. Drill the movement at Saturday/Sunday training.",
        days:{MON:"Watch one technique video. Visualize applying it.",TUE:"Another lesson. Think about what you drilled last Saturday.",WED:"Midweek review. Rewatch something from this week.",THU:"New lesson. Prep your drill for Saturday.",FRI:"Prep your mind for Saturday. What technique are you drilling tomorrow?",SAT:"APPLY IT. You watched it all week. This is the test. Drill it at training.",SUN:"Debrief. What worked? What did not? Watch the technique again with fresh eyes."}
      },
    ]
  },
];
// Flat habits list for backward compatibility with existing DB keys
const HABITS = HABIT_GROUPS.flatMap(g => g.habits);

const NUTRITION = [
  {label:"Calories", value:"2,800â€“3,200", color:"#ff6b35"},
  {label:"Protein", value:"150â€“180g", color:"#00ff88"},
  {label:"Carbs", value:"300â€“350g", color:"#ffcc00"},
  {label:"Fats", value:"80â€“100g", color:"#ff88aa"},
  {label:"Sodium", value:"<2,300mg", color:"#6699ff"},
  {label:"Water", value:"3L+ daily", color:"#88ccff"},
];

const TIMELINE = [
  {week:"WEEK 1â€“2", text:"Sleep improves, more energy, Magnesium working. Body adapting to training volume.", color:"#00ff88"},
  {week:"WEEK 3â€“4", text:"BP starting to drop. Noticeably stronger on all lifts. Habits locked in. Kegel results starting.", color:"#00ff88"},
  {week:"WEEK 5â€“6", text:"Visible muscle changes. Clothes fitting differently. Significantly better erection quality and hardness.", color:"#ff6b35"},
  {week:"WEEK 7â€“8", text:"Striking power up noticeably. Cardio endurance improved. Partner noticing changes. Can almost touch toes.", color:"#ff6b35"},
  {week:"WEEK 9â€“10", text:"Looking genuinely different. Martial arts conditioning at new level. BP numbers measurably better.", color:"#ff0055"},
  {week:"WEEK 11â€“12", text:"New body. New BP. Hitting harder, lasting longer, recovering faster. Mission accomplished. ðŸ”¥", color:"#ff0055"},
];

// Day constants
const ALL_DAYS = ['MON','TUE','WED','THU','FRI','SAT','SUN'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE + STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCipVNxfG3-rL-H4SGV6sxO8PB8W3JlsrM",
  authDomain: "elite-training-6a826.firebaseapp.com",
  projectId: "elite-training-6a826",
  storageBucket: "elite-training-6a826.firebasestorage.app",
  messagingSenderId: "785563069645",
  appId: "1:785563069645:web:89fa21149756837e24cd84"
};

// Initialize Firebase via CDN (loaded in <head>)
// Firebase with offline fallback â€” app renders even if Firebase is unavailable
let DOC_REF = null;
try {
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  DOC_REF = db.collection('users').doc('eric');
} catch(e) {
  console.warn('Firebase unavailable, running in localStorage-only mode:', e.message);
}

// Local DB â€” always up to date in memory
let DB = {};
let DB_LOADED = false;

// Load from Firestore on startup, fall back to localStorage if offline
async function loadDB(){
  // Always load localStorage as immediate fallback
  try { DB = JSON.parse(localStorage.getItem('eliteV4')||'{}'); } catch(e){ DB={}; }
  try {
    const snap = await DOC_REF.get();
    if(snap.exists){
      DB = snap.data();
      // Sync to localStorage as offline backup
      localStorage.setItem('eliteV4', JSON.stringify(DB));
    } else {
      // First time â€” push localStorage data up to Firestore if any
      if(Object.keys(DB).length > 0){
        await DOC_REF.set(DB);
      }
    }
  } catch(e){
    console.warn('Firebase offline, using localStorage:', e.message);
  }
  DB_LOADED = true;
  // Sync UI state from DB
  if(DB.activeDay) UI.activeDay = DB.activeDay;
  if(DB.lastEquip) UI.activeEquip = DB.lastEquip;
  if(DB.dyslexiaMode) document.body.classList.add('dyslexia-mode');
  render();
}

// Debounced save â€” batches rapid changes into one write
let _saveTimer = null;
function saveDB(){
  // Always save to localStorage immediately
  try { localStorage.setItem('eliteV4', JSON.stringify(DB)); } catch(e){}
  showSaved();
  // Debounce Firestore writes to max 1 per 2 seconds
  clearTimeout(_saveTimer);
  _saveTimer = setTimeout(async ()=>{
    try {
      await DOC_REF.set(DB);
    } catch(e){
      console.warn('Firebase save failed, data safe in localStorage:', e.message);
    }
  }, 2000);
}

function showSaved(){
  const b=document.getElementById('savedBadge');
  if(!b)return;
  b.classList.add('show');
  clearTimeout(window._st);
  window._st=setTimeout(()=>b.classList.remove('show'),1400);
}

// Initialize UI with defaults â€” loadDB() will update from Firebase
let UI={
  activePhase: 0,
  activeDay: 'MON',
  activeTab: 'journal',
  activeEquip: null,
  calYear: new Date().getFullYear(),
  calMonth: new Date().getMonth(),
  modalDate: null,
  openEx: null,
  activeDate: todayStr(),
};

function todayStr(){
  const d=new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function dateLabel(s){
  if(!s)return'';
  const[y,m,d]=s.split('-');
  const M=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return`${M[parseInt(m)-1]} ${parseInt(d)}, ${y}`;
}
function getDowStr(dateStr){
  const[y,m,d]=dateStr.split('-');
  return ALL_DAYS[new Date(parseInt(y),parseInt(m)-1,parseInt(d)).getDay()===0?6:new Date(parseInt(y),parseInt(m)-1,parseInt(d)).getDay()-1];
}
function todayDow(){
  const dow=new Date().getDay(); // 0=sun
  // map to MON=0...SUN=6
  return ALL_DAYS[dow===0?6:dow-1];
}

function getDD(date){
  if(!DB.days)DB.days={};
  if(!DB.days[date])DB.days[date]={ex:{},w:{},bf:{},rec:{},supp:{},sex:{},habits:{},bp:{},sleep:{},urges:[],hygiene:{},minox:{}};
  return DB.days[date];
}
function setAccent(c){document.documentElement.style.setProperty('--accent',c);}
function getDayType(d){return({'MON':'PULL','TUE':'PUSH','WED':'LEGS','THU':'ARMS+CORE','FRI':'OPTIONAL','SAT':'FIGHT DAY','SUN':'REST'})[d]||'TRAIN';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  // phase replaced by FIGHTERS equipment system
  const today=UI.activeDate;
  const dd=getDD(today);
  // Determine color by day type
  const dayTypeColors={'MON':'#00ff88','TUE':'#ff6b35','WED':'#ffcc00','THU':'#6699ff','FRI':'#00ff88','SAT':'#ff0055','SUN':'#444444'};
  const accentColor=dayTypeColors[UI.activeDay]||'#00ff88';
  setAccent(accentColor);

  // Calculate header progress
  let pct=0;
  const ad=UI.activeDay;
  if(ad==='SAT'){
    const done=SATURDAY_PLAN.filter((_,i)=>dd.rec['sat-'+i]).length;
    pct=Math.round(done/SATURDAY_PLAN.length*100);
  } else if(ad==='SUN'){
    const done=SUNDAY_PLAN.filter((_,i)=>dd.rec['sun-'+i]).length;
    pct=Math.round(done/SUNDAY_PLAN.length*100);
  } else {
    const dayIdx=['MON','TUE','WED','THU','FRI'].indexOf(ad);
    if(dayIdx>=0 && UI.activeEquip){
      const equipD=FIGHTERS[UI.activeEquip];
      if(equipD&&equipD.days[dayIdx]){
        const exs=equipD.days[dayIdx].exercises;
        const ekKey=UI.activeEquip+'-'+dayIdx;
        const totalItems=exs.length+BODY_FIX.length;
        const exDone=exs.filter((_,i)=>dd.ex[ekKey+'-'+i]).length;
        const bfDone=BODY_FIX.filter((_,i)=>dd.bf['bf-'+dayIdx+'-'+i]).length;
        pct=Math.round((exDone+bfDone)/totalItems*100);
      }
    }
  }

  const dowLabel=getDowStr(today);

  document.getElementById('app').innerHTML=`
    <div class="header">
      <div>
        <div class="h-eyebrow bebas">FIGHTER'S POWER SYSTEM</div>
        <div class="h-phase bebas">${getDayType(UI.activeDay)}</div>
        <div class="h-sub" style="color:${accentColor}">${UI.activeEquip?UI.activeEquip.toUpperCase()+' SETUP':'SELECT EQUIPMENT â†“'}</div>
        <div style="display:flex;align-items:center;gap:8px;margin-top:4px">
        <button onclick="toggleDyslexia()" id="dyslexBtn" style="background:none;border:1px solid #2a2a2a;border-radius:4px;color:#6699ff;padding:2px 7px;font-size:9px;font-family:Impact,sans-serif;letter-spacing:1px;cursor:pointer;margin-right:4px">Aa</button>
        <button onclick="shiftDate(-1)" style="background:none;border:1px solid #2a2a2a;border-radius:4px;color:#888;padding:2px 8px;font-size:14px;cursor:pointer;line-height:1">â€¹</button>
        <div class="h-date" style="margin:0">${dowLabel}, ${dateLabel(today)}${today===todayStr()?'':' <span style="font-size:9px;color:#ff6b35;letter-spacing:1px">PAST</span>'}</div>
        <button onclick="shiftDate(1)" style="background:none;border:1px solid #2a2a2a;border-radius:4px;color:${today===todayStr()?'#2a2a2a':'#888'};padding:2px 8px;font-size:14px;cursor:pointer;line-height:1" ${today===todayStr()?'disabled':''}>â€º</button>
        ${today!==todayStr()?`<button onclick="goToToday()" style="background:#ff6b35;border:none;border-radius:4px;color:#000;padding:2px 8px;font-size:9px;font-weight:bold;cursor:pointer;letter-spacing:1px">TODAY</button>`:''}
      </div>
      </div>
      <div class="prog-circle">
        <div class="prog-num">${pct}</div>
        <div class="prog-pct">%</div>
      </div>
    </div>

    <div class="tabs">
      ${(function(){
        var tabDefs=[
          {k:'journal',  lbl:'ðŸ““ JOURNAL', c:'#ffcc00'},
          {k:'workout',  lbl:'ðŸ’ª TRAIN',   c:''},
          {k:'habits',   lbl:'HABITS',     c:''},
          {k:'recovery', lbl:'ðŸ§  RECOV',   c:'#ff0055'},
          {k:'supplements',lbl:'ðŸ’Š SUPPS', c:''},
          {k:'weekly',   lbl:'ðŸ“Š WEEK',    c:'#ffcc00'},
        ];
        return tabDefs.map(function(td){
          var active=UI.activeTab===td.k;
          var sc=td.c?(active?td.c:td.c+'99'):'';
          var style=sc?'color:'+sc+';':'';
          return '<button class="tab-btn bebas '+(active?'active':'')+'" onclick="switchTab(\''+td.k+'\')" style="'+style+'">'+td.lbl+'</button>';
        }).join('');
      })()}
    </div>

    ${renderDailyMotivation(today)}
    <div class="content-area">
      ${UI.activeTab==='workout' ? renderWorkoutTab(today,dd) : ''}
      ${UI.activeTab==='supplements' ? renderSupplements(today,dd) : ''}
      ${UI.activeTab==='calendar' ? renderCalendar() : ''}
      ${UI.activeTab==='habits' ? renderHabits(today,dd) : ''}
      ${UI.activeTab==='recovery' ? renderRecovery(today,dd) : ''}
      ${UI.activeTab==='weekly' ? renderWeeklySummary(today) : ''}
      ${UI.activeTab==='journal' ? renderJournal(today,dd) : ''}
    </div>

    ${UI.modalDate ? renderModal(UI.modalDate) : ''}
  `;

  // Bind weight inputs after render
  if(UI.activeTab==='workout'){
    document.querySelectorAll('.weight-input').forEach(inp=>{
      const key=inp.dataset.key;
      const dd2=getDD(today);
      if(key&&dd2.w[key])inp.value=dd2.w[key];
      inp.addEventListener('input',e=>{
        getDD(today).w[key]=e.target.value;
        saveDB();
        // Update subtitle live â€” strip to base exercise key (phase-day-exIdx)
        const parts=key.split('-');
        const baseKey=parts.slice(0,3).join('-');
        const card=inp.closest('.ex-item');
        if(card){
          const note=card.querySelector('.ex-note');
          if(note){
            const equip=UI.activeEquip||'gym';
            const dayIdx=['MON','TUE','WED','THU','FRI'].indexOf(UI.activeDay);
            const exIdx=parseInt(parts[parts.length-1])||0;
            const ex=FIGHTERS[equip]?.days[dayIdx]?.exercises[exIdx];
            if(ex){
              const isSuperset=ex.n.includes(' + ')||ex.n.toLowerCase().includes('superset');
              const numParts=isSuperset?ex.n.replace(/\s*\(superset.*?\)/i,'').split(' + ').length:1;
              const summaries=[];
              for(let pi=0;pi<numParts;pi++){
                const psets=[];
                for(let s=0;s<ex.s;s++){
                  const sw=getDD(today).w[baseKey+'-p'+pi+'-s'+s];
                  if(sw) psets.push('S'+(s+1)+':'+sw+'lb');
                }
                if(psets.length) summaries.push(psets.join(' Â· '));
              }
              note.innerHTML=summaries.length?summaries.join(' | '):ex.s+' sets Â· tap to log weights';
              note.style.color=summaries.length?'var(--accent)':'#555';
            }
          }
        }
      });
      inp.addEventListener('focus',()=>setTimeout(()=>inp.scrollIntoView({behavior:'smooth',block:'center'}),300));
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WORKOUT TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderWorkoutTab(today,dd){
  const ad=UI.activeDay;
  const equip=UI.activeEquip;

  // Day tabs row
  const dayTabsHTML=`
    <div class="day-tabs">
      ${ALL_DAYS.map(d=>{
        let cls='day-tab';
        if(d==='SUN') cls+=' rest-day';
        else if(d==='FRI') cls+=' recovery-day';
        else if(d==='SAT') cls+=' hiit-day';
        if(ad===d) cls+=' active';
        return `<button class="${cls}" onclick="switchDay('${d}')">${d}</button>`;
      }).join('')}
    </div>`;

  if(ad==='SAT') return dayTabsHTML + renderSaturday(today,dd);
  if(ad==='SUN') return dayTabsHTML + renderSunday(today,dd);

  // FRI optional
  const isFriOptional = (ad==='FRI');

  // MONâ€“FRI workout days
  const dayIdx=['MON','TUE','WED','THU','FRI'].indexOf(ad);
  if(dayIdx<0) return dayTabsHTML;

  // Equipment selector â€” shown if no equipment chosen yet today OR user wants to change
  if(!equip){
    const types=['PULL','PUSH','LEGS','ARMS + CORE','OPTIONAL PULL'];
    const typeColors=['#00ff88','#ff6b35','#ffcc00','#6699ff','#00ff88'];
    const typeIcons=['ðŸ”¼','ðŸ’¥','ðŸ¦µ','ðŸ’ª','ðŸ”¼'];
    const equipOptions=[
      {k:'gym',      icon:'ðŸ‹ï¸', label:'FULL GYM',    sub:'Barbell Â· Cable Â· Everything',  color:'#00ff88'},
      {k:'bowflex',  icon:'ðŸ ', label:'BOWFLEX',      sub:'Adjustable dumbbells 5-52lbs',  color:'#ff6b35'},
      {k:'bands',    icon:'ðŸŽ½', label:'BANDS',         sub:'Resistance bands only',         color:'#ffcc00'},
      {k:'bodyweight',icon:'ðŸ’ª',label:'BODYWEIGHT',   sub:'No equipment needed',           color:'#6699ff'},
    ];
    let btnHTML='';
    equipOptions.forEach(function(e){
      btnHTML+='<button data-equip="'+e.k+'" class="equip-btn" style="padding:18px 12px;background:#111;border:2px solid #2a2a2a;border-radius:14px;cursor:pointer;text-align:center">'
        +'<div style="font-size:32px;margin-bottom:8px">'+e.icon+'</div>'
        +'<div style="font-size:15px;font-family:Impact,sans-serif;letter-spacing:2px;color:'+e.color+';margin-bottom:4px">'+e.label+'</div>'
        +'<div style="font-size:10px;color:#555">'+e.sub+'</div>'
        +'</button>';
    });
    return dayTabsHTML
      +'<div style="padding:20px 16px">'
        +'<div style="text-align:center;margin-bottom:6px">'
          +'<div style="font-size:11px;letter-spacing:3px;color:#555;font-family:Impact,sans-serif">'+(ad==='FRI'?'OPTIONAL â€” ':'')+'TODAY IS</div>'
          +'<div style="font-size:36px;font-family:Impact,sans-serif;letter-spacing:3px;color:'+typeColors[dayIdx]+'">'+typeIcons[dayIdx]+' '+types[dayIdx]+'</div>'
          +(ad==='FRI'?'<div style="font-size:11px;color:#555;margin-top:4px">No penalty if you skip. But the men who show up on Fridays are built different.</div>':'')
        +'</div>'
        +'<div style="font-size:13px;letter-spacing:2px;color:#888;text-align:center;margin:20px 0 12px;font-family:Impact,sans-serif">WHAT DO YOU HAVE TODAY?</div>'
        +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">'+btnHTML+'</div>'
        +(ad==='FRI'?'<button data-day="SAT" class="switch-day-btn" style="width:100%;padding:14px;background:none;border:1px solid #2a2a2a;border-radius:10px;color:#444;font-size:12px;font-family:Impact,sans-serif;letter-spacing:2px;cursor:pointer">SKIP TODAY â€” GO TO SATURDAY</button>':'')
      +'</div>';
  }

  // Equipment selected â€” get the workout
  const equipData = FIGHTERS[equip];
  const day = equipData.days[dayIdx];
  const equipColor = equipData.color;
  const exKey = equip+'-'+dayIdx;
  const exDone=day.exercises.filter((_,i)=>dd.ex[exKey+'-'+i]).length;
  const bfDone=BODY_FIX.filter((_,i)=>dd.bf['bf-'+dayIdx+'-'+i]).length;
  const minReq=Math.min(day.exercises.length,DB.minExercises||5);
  const totalItems=minReq+BODY_FIX.length;
  const pct=Math.min(100,Math.round((exDone+bfDone)/totalItems*100));

  return dayTabsHTML + `
    <div style="margin:0 16px 12px;display:flex;align-items:center;justify-content:space-between">
      <div>
        <div style="font-size:10px;letter-spacing:2px;color:#555;font-family:Impact,sans-serif">${day.type}</div>
        <div style="font-size:22px;font-family:Impact,sans-serif;letter-spacing:2px;color:${equipColor}">${day.name}</div>
        <div style="font-size:11px;color:#666;margin-top:2px">${day.tag}</div>
      </div>
      <button onclick="selectEquip(null)" style="padding:6px 12px;background:none;border:1px solid #333;border-radius:8px;color:#555;font-size:10px;font-family:Impact,sans-serif;letter-spacing:1px;cursor:pointer">${equipData.label}<br><span style="color:#333;font-size:9px">TAP TO CHANGE</span></button>
    </div>

    <div class="info-box warm" style="cursor:pointer" onclick="toggleWarmup('${today}','wu-${equip}-${dayIdx}')">
      <div style="width:20px;height:20px;border-radius:4px;border:2px solid ${dd.w['wu-'+equip+'-'+dayIdx]?'#00ff88':'#333'};background:${dd.w['wu-'+equip+'-'+dayIdx]?'#00ff88':'none'};display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.15s">
        ${dd.w['wu-'+equip+'-'+dayIdx]?'<span style="color:#000;font-size:11px;font-weight:bold">âœ“</span>':''}
      </div>
      <span class="box-icon">ðŸ”¥</span>
      <div><div class="box-lbl">WARM-UP Â· TAP TO CHECK OFF</div><div class="box-txt" style="color:${dd.w['wu-'+equip+'-'+dayIdx]?'#444':'#00ff88'};${dd.w['wu-'+equip+'-'+dayIdx]?'text-decoration:line-through':''}">${day.warmup}</div></div>
    </div>

    <div style="display:flex;align-items:center;justify-content:space-between;padding:4px 20px;font-size:10px;color:#555">
      <span>REQUIRED: <span style="color:var(--accent);font-family:Impact,sans-serif">${minReq}/${day.exercises.length}</span></span>
      <div style="display:flex;gap:4px"><button onclick="event.stopPropagation();setMinEx(${Math.max(3,minReq-1)})" style="width:30px;height:26px;background:#111;border:1px solid #222;border-radius:5px;color:#777;font-size:16px;cursor:pointer;line-height:1">âˆ’</button><button onclick="event.stopPropagation();setMinEx(${Math.min(day.exercises.length,minReq+1)})" style="width:30px;height:26px;background:#111;border:1px solid #222;border-radius:5px;color:#777;font-size:16px;cursor:pointer;line-height:1">+</button></div>
    </div>
    <div class="prog-bar-wrap">
      <div class="prog-bar-labels"><span>PROGRESS (${minReq} = 100%)</span><span style="color:${equipColor}">${exDone+bfDone}/${totalItems}</span></div>
      <div class="prog-bar-track"><div class="prog-bar-fill" style="width:${pct}%;background:${equipColor}"></div></div>
    </div>

    ${renderRestBar()}
    <div class="ex-section">
      <div class="section-lbl">EXERCISES â€” TAP âœ“ TO COMPLETE Â· TAP NAME FOR WEIGHT</div>
      ${day.exercises.map((ex,i)=>{
        const key=exKey+'-'+i;
        const isDone=!!dd.ex[key];
        const isOpen=UI.openEx===key;
        const noWeight=['plank','shadowbox','hold','stretch','couch','bug','jump','carry','interval','bound'].some(k=>ex.n.toLowerCase().includes(k));
        
        // Detect superset â€” split on ' + ' in name
        const isSuperset = ex.n.includes(' + ') || ex.n.toLowerCase().includes('superset');
        // Parse superset parts â€” split on ' + ', strip trailing superset label
        const supersetParts = isSuperset 
          ? ex.n.replace(/\s*\(superset.*?\)/i,'').split(' + ').map(p=>p.trim())
          : [ex.n];
        
        // Build weight summary â€” per superset part per set
        const buildSummary = (partIdx) => {
          const rows=[];
          for(let s=0;s<ex.s;s++){
            const sw=dd.w[key+'-p'+partIdx+'-s'+s];
            if(sw) rows.push('S'+(s+1)+':'+sw+'lb');
          }
          return rows.join(' Â· ');
        };
        const allWeightSummary = supersetParts.map((_,pi)=>buildSummary(pi)).filter(Boolean).join(' | ');

        return `
          <div class="ex-item ${isDone?'done':''}">
            <div class="ex-top">
              <div class="ex-check ${isDone?'checked':''}" onclick="toggleEx('${key}','ex')"></div>
              <div class="ex-info" onclick="toggleWeight('${key}')">
                <div class="ex-name">${weightProgressAlert(equip,dayIdx,i)}${isSuperset?'ðŸ” SUPERSET':''}${isSuperset?'<br>':''}${supersetParts.join('<br>+ ')}</div>
                <div class="ex-note" style="font-size:11px;color:${allWeightSummary?'var(--accent)':'#555'}">${allWeightSummary||ex.s+' sets Â· tap to log weights'}</div>
              </div>
              <div class="ex-reps-badge">${ex.s}Ã—${ex.r}</div>
            </div>
            ${!noWeight?`
            <div class="ex-weight ${isOpen?'open':''}">
              ${isSuperset ? supersetParts.map((part,pi)=>`
                <div style="margin-bottom:14px">
                  <div style="font-size:10px;letter-spacing:2px;color:#ff6b35;margin-bottom:8px;padding:4px 8px;background:#1a0e00;border-radius:4px;border-left:2px solid #ff6b35">${part.toUpperCase()}</div>
                  ${Array.from({length:ex.s},(_,s)=>`
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                      <span style="font-size:11px;color:#555;width:40px;flex-shrink:0;letter-spacing:1px">SET ${s+1}</span>
                      <input class="weight-input" type="number" inputmode="decimal" placeholder="0"
                        data-key="${key}-p${pi}-s${s}"
                        style="flex:1;background:#0a0a0a;border:1px solid #2a2a2a;border-radius:6px;padding:8px 10px;color:#f0f0f0;font-size:15px;outline:none;"
                      />
                      <span style="font-size:12px;color:#555">lbs</span>
                      <span style="font-size:11px;color:#444;width:28px;text-align:center">${ex.r.split('/')[pi]||ex.r} reps</span>
                    </div>`).join('')}
                </div>`).join('') 
              : `
                <div style="padding:0 0 8px;font-size:10px;letter-spacing:2px;color:#555">LOG WEIGHT PER SET</div>
                ${Array.from({length:ex.s},(_,s)=>`
                  <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                    <span style="font-size:11px;color:#555;width:40px;flex-shrink:0;letter-spacing:1px">SET ${s+1}</span>
                    <input class="weight-input" type="number" inputmode="decimal" placeholder="0"
                      data-key="${key}-p0-s${s}"
                      style="flex:1;background:#0a0a0a;border:1px solid #2a2a2a;border-radius:6px;padding:8px 10px;color:#f0f0f0;font-size:15px;outline:none;"
                    />
                    <span style="font-size:12px;color:#555">lbs</span>
                    <span style="font-size:11px;color:#444;width:28px;text-align:center">${ex.r} reps</span>
                  </div>`).join('')}`}
              <div style="font-size:10px;color:#444;padding-top:2px;font-style:italic">Auto-saved Â· view in calendar</div>
            </div>`:''}
          </div>`;
      }).join('')}
    </div>

    <div class="divider"></div>

    <div class="ex-section" style="margin-top:4px">
      <div class="section-lbl blue">ðŸ§  BODY FIX â€” TECH NECK Â· SCIATICA Â· FLEXIBILITY</div>
      <div style="font-size:11px;color:#444;margin-bottom:12px;padding:0 0 4px">Do these after your workout or during cooldown</div>
      ${BODY_FIX.map((bf,i)=>{
        const key=`bf-${dayIdx}-${i}`;
        const isDone=!!dd.bf[key];
        return `
          <div class="ex-item body-item ${isDone?'done':''}" style="${isDone?'':'border-color:#1a1a2e'}">
            <div class="ex-top" onclick="toggleBF('${key}')">
              <div class="ex-check blue-check ${isDone?'checked':''}"></div>
              <div class="ex-info">
                <div class="ex-name">${bf.n}</div>
                <div class="ex-note" style="color:#6699ff88">${bf.detail}</div>
              </div>
              <div class="ex-reps-badge blue">${bf.type==='techneck'?'ðŸ–¥ï¸':bf.type==='sciatica'?'âš¡':bf.type==='flexibility'?'ðŸ¦µ':'ðŸ¦µ'}</div>
            </div>
          </div>`;
      }).join('')}
    </div>

    <div class="info-box cool" style="margin-top:14px;cursor:pointer" onclick="toggleWarmup('${today}','cd-${equip}-${dayIdx}')">
      <div style="width:20px;height:20px;border-radius:4px;border:2px solid ${dd.w['cd-'+equip+'-'+dayIdx]?'#aa88ff':'#333'};background:${dd.w['cd-'+equip+'-'+dayIdx]?'#aa88ff':'none'};display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.15s">
        ${dd.w['cd-'+equip+'-'+dayIdx]?'<span style="color:#000;font-size:11px;font-weight:bold">âœ“</span>':''}
      </div>
      <span class="box-icon">â„ï¸</span>
      <div><div class="box-lbl">COOL-DOWN Â· TAP TO CHECK OFF</div>
    <div class="box-txt" style="color:${dd.w['cd-'+equip+'-'+dayIdx]?'#444':'#aa88ff'};${dd.w['cd-'+equip+'-'+dayIdx]?'text-decoration:line-through':''}">${day.cooldown}</div></div>
    </div>
    ${renderStretchTimers(day.cooldown)}

    <div style="margin:14px 20px 0;background:#0d1a12;border-radius:10px;border:1px solid #1a3a1a;overflow:hidden">
      <div style="padding:12px 16px;border-bottom:1px solid #1a3a1a;display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-size:14px;font-family:Impact,'Arial Narrow',sans-serif;letter-spacing:1px;color:#00ff88">POST-WORKOUT</div>
          <div style="font-size:11px;color:#555;margin-top:2px">Within 30 min of finishing Â· muscle repair window</div>
        </div>
        <span style="font-size:20px">ðŸ’ª</span>
      </div>
      ${[
        {k:'pw-shake', icon:'ðŸ¥¤', name:'Protein Shake', detail:'1 scoop Â· 31g protein + 5g creatine Â· most important on training days'},
        {k:'pw-water', icon:'ðŸ’§', name:'Rehydrate â€” 500ml+ water', detail:'Replace what you lost Â· creatine needs water to work'},
        {k:'pw-cold', icon:'ðŸš¿', name:'Cold shower finish', detail:'30 sec cold at the end Â· recovery + blood flow rebound + testosterone'},
      ].map(item=>{
        const done=!!dd.w[item.k+'-'+equip+'-'+dayIdx];
        return `
          <div style="display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid #1a2e1f;cursor:pointer;${done?'background:#071208;':''}" 
            onclick="toggleWarmup('${today}','${item.k}-${equip}-${dayIdx}')">
            <div style="width:20px;height:20px;border-radius:4px;border:2px solid ${done?'#00ff88':'#333'};background:${done?'#00ff88':'none'};display:flex;align-items:center;justify-content:center;flex-shrink:0">
              ${done?'<span style="color:#000;font-size:11px;font-weight:bold">âœ“</span>':''}
            </div>
            <span style="font-size:16px">${item.icon}</span>
            <div>
              <div style="font-size:13px;${done?'color:#444;text-decoration:line-through':''}">${item.name}</div>
              <div style="font-size:11px;color:#555;margin-top:2px">${item.detail}</div>
            </div>
          </div>`;
      }).join('')}
      <div style="padding:10px 16px;font-size:11px;color:#444;font-style:italic">
        ðŸ’¡ On rest days drink your shake in the morning instead
      </div>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FRI / SAT / SUN VIEWS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFriday(today,dd){
  const done=FRIDAY_PLAN.filter((_,i)=>dd.rec[`fri-${i}`]).length;
  return `
    <div style="padding:12px 20px 8px">
      <div style="font-size:22px;font-family:Impact,'Arial Narrow','Arial Black',sans-serif;color:#ffcc00;letter-spacing:2px">FRIDAY</div>
      <div style="font-size:12px;color:#666;margin-bottom:4px">Active Recovery Â· 45 min max</div>
      <div style="font-size:11px;color:#ffcc00">${done}/${FRIDAY_PLAN.length} done Â· Sets you up for Saturday</div>
    </div>
    <div class="info-box note" style="margin-top:8px">
      <span class="box-icon">ðŸ’¡</span>
      <div><div class="box-lbl">GOAL</div><div class="box-txt" style="color:#ffcc00">Blood flow, tension release, prep for HIIT + martial arts</div></div>
    </div>
    <div class="prog-bar-wrap" style="margin-top:8px">
      <div class="prog-bar-labels"><span>PROGRESS</span><span style="color:#ffcc00">${done}/${FRIDAY_PLAN.length}</span></div>
      <div class="prog-bar-track"><div class="prog-bar-fill" style="width:${Math.round(done/FRIDAY_PLAN.length*100)}%;background:#ffcc00"></div></div>
    </div>
    <div style="padding:0 20px">
      <div class="section-lbl yellow">CHECKLIST â€” TAP TO COMPLETE</div>
      ${FRIDAY_PLAN.map((item,i)=>{
        const key=`fri-${i}`;
        const isDone=!!dd.rec[key];
        return `
          <div class="rec-item ${isDone?'done':''}" onclick="toggleRec('${today}','${key}')">
            <div class="rec-check yellow-rc ${isDone?'checked':''}"></div>
            <div>
              <div class="rec-text">${item.t}</div>
              <div class="rec-detail">${item.d}</div>
            </div>
          </div>`;
      }).join('')}
    </div>`;
}

function renderSaturday(today,dd){
  const done=SATURDAY_PLAN.filter((_,i)=>dd.rec[`sat-${i}`]).length;
  return `
    <div style="padding:12px 20px 8px">
      <div style="font-size:22px;font-family:Impact,'Arial Narrow','Arial Black',sans-serif;color:#ff88aa;letter-spacing:2px">SATURDAY</div>
      <div style="font-size:12px;color:#666;margin-bottom:4px">HIIT + Martial Arts Â· Peak Conditioning</div>
      <div style="font-size:11px;color:#ff88aa">${done}/${SATURDAY_PLAN.length} done</div>
    </div>
    <div class="info-box" style="margin-top:8px;background:#1a0d12;border:1px solid #3a1a22">
      <span class="box-icon">ðŸ¥Š</span>
      <div><div class="box-lbl">GOAL</div><div class="box-txt" style="color:#ff88aa">Max cardio, apply your week's training, set up recovery</div></div>
    </div>
    <div class="prog-bar-wrap" style="margin-top:8px">
      <div class="prog-bar-labels"><span>PROGRESS</span><span style="color:#ff88aa">${done}/${SATURDAY_PLAN.length}</span></div>
      <div class="prog-bar-track"><div class="prog-bar-fill" style="width:${Math.round(done/SATURDAY_PLAN.length*100)}%;background:#ff88aa"></div></div>
    </div>
    <div style="padding:0 20px">
      <div class="section-lbl pink">CHECKLIST â€” TAP TO COMPLETE</div>
      ${SATURDAY_PLAN.map((item,i)=>{
        const key=`sat-${i}`;
        const isDone=!!dd.rec[key];
        return `
          <div class="rec-item ${isDone?'done':''}" onclick="toggleRec('${today}','${key}')">
            <div class="rec-check pink-rc ${isDone?'checked':''}"></div>
            <div>
              <div class="rec-text">${item.t}</div>
              <div class="rec-detail">${item.d}</div>
            </div>
          </div>`;
      }).join('')}
    </div>`;
}

function renderSunday(today,dd){
  const recDone=SUNDAY_PLAN.filter((_,i)=>dd.rec[`sun-${i}`]).length;
  const prepDone=PREP_CHECKLIST.filter((_,i)=>dd.rec[`prep-${i}`]).length;
  const totalDone=recDone+prepDone;
  const totalItems=SUNDAY_PLAN.length+PREP_CHECKLIST.length;
  return `
    <div style="padding:12px 20px 8px">
      <div style="font-size:22px;font-family:Impact,'Arial Narrow','Arial Black',sans-serif;color:#00ff88;letter-spacing:2px">SUNDAY</div>
      <div style="font-size:12px;color:#666;margin-bottom:4px">Full Recovery Â· Testosterone Recharge Â· Week Prep</div>
      <div style="font-size:11px;color:#00ff88">${totalDone}/${totalItems} done</div>
    </div>
    <div class="info-box warm" style="margin-top:8px">
      <span class="box-icon">ðŸ’¤</span>
      <div><div class="box-lbl">GOAL</div><div class="box-txt" style="color:#00ff88">Sleep, eat, stretch, prep your pill packs. Win the week before it starts.</div></div>
    </div>
    <div class="prog-bar-wrap" style="margin-top:8px">
      <div class="prog-bar-labels"><span>TOTAL PROGRESS</span><span style="color:#00ff88">${totalDone}/${totalItems}</span></div>
      <div class="prog-bar-track"><div class="prog-bar-fill" style="width:${Math.round(totalDone/totalItems*100)}%"></div></div>
    </div>

    <div style="padding:0 20px">
      <div class="section-lbl">RECOVERY CHECKLIST</div>
      ${SUNDAY_PLAN.map((item,i)=>{
        const key=`sun-${i}`;
        const isDone=!!dd.rec[key];
        return `
          <div class="rec-item ${isDone?'done':''}" onclick="toggleRec('${today}','${key}')">
            <div class="rec-check ${isDone?'checked':''}"></div>
            <div>
              <div class="rec-text">${item.t}</div>
              <div class="rec-detail">${item.d}</div>
            </div>
          </div>`;
      }).join('')}
    </div>

    <div style="height:1px;background:#1a1a1a;margin:16px 20px"></div>

    <div style="padding:0 20px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div class="section-lbl" style="margin:0;color:#ffcc00">ðŸ’Š SUNDAY PILL PACK PREP</div>
        <div style="font-size:12px;color:#ffcc00;font-family:Impact,'Arial Narrow','Arial Black',sans-serif">${prepDone}/${PREP_CHECKLIST.length}</div>
      </div>
      <div style="background:#1a1a0d;border-radius:8px;padding:10px 14px;border:1px solid #2e2e1a;font-size:12px;color:#ffcc00;margin-bottom:12px;line-height:1.6">
        ðŸ›ï¸ Fill your pill pouches now. Label each with the day and time (AM / Pre-WO / PM). Grab and go all week â€” no thinking, no forgetting.
      </div>
      ${PREP_CHECKLIST.map((item,i)=>{
        const key=`prep-${i}`;
        const isDone=!!dd.rec[key];
        return `
          <div class="rec-item ${isDone?'done':''}" onclick="toggleRec('${today}','${key}')">
            <div class="rec-check yellow-rc ${isDone?'checked':''}"></div>
            <div>
              <div class="rec-text">${item.t}</div>
              <div class="rec-detail">${item.d}</div>
            </div>
          </div>`;
      }).join('')}
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPPLEMENTS TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSupplements(today,dd){
  // count total items across all packs
  const totalItems = SUPPLEMENTS.length;
  const suppDone = SUPPLEMENTS.filter((_,i)=>dd.supp[i]).length;
  const sexDone = SEX_CHECKLIST.filter((_,i)=>dd.sex[i]).length;
  
  // Build offset map for flat index
  let offset=0;
  const packHTML = PILL_PACKS.map(pack=>{
    const packOffset=offset;
    const packDone=pack.items.filter((_,i)=>dd.supp[packOffset+i]).length;
    const html=`
      <div style="margin:0 20px 16px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="display:flex;align-items:center;gap:8px">
            <span style="font-size:18px">${pack.emoji}</span>
            <div>
              <div style="font-size:16px;font-family:Impact,'Arial Narrow','Arial Black',sans-serif;letter-spacing:1px;color:${pack.color}">${pack.time}</div>
              <div style="font-size:11px;color:#555;margin-top:1px">${pack.note}</div>
            </div>
          </div>
          <div style="font-size:12px;color:${pack.color};font-family:Impact,'Arial Narrow','Arial Black',sans-serif;flex-shrink:0">${packDone}/${pack.items.length}</div>
        </div>
        <div style="background:#111;border-radius:10px;border:1px solid #1a1a1a;overflow:hidden">
          ${pack.items.map((item,i)=>{
            const globalIdx=packOffset+i;
            const done=!!dd.supp[globalIdx];
            return `
              <div style="display:flex;align-items:center;gap:12px;padding:12px 14px;border-bottom:1px solid #1a1a1a;cursor:pointer;${done?'background:#0d1a0d;':''};transition:all 0.15s" 
                onclick="toggleSupp('${today}',${globalIdx})">
                <div style="width:20px;height:20px;border-radius:4px;border:2px solid ${done?pack.color:'#333'};background:${done?pack.color:'none'};display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.15s">
                  ${done?'<span style="color:#000;font-size:11px;font-weight:bold">âœ“</span>':''}
                </div>
                <div style="flex:1">
                  <div style="font-size:13px;${done?'color:#444;text-decoration:line-through':'color:#e0e0e0'}">${item.n}</div>
                  <div style="font-size:10px;color:#555;margin-top:2px">${item.dose} Â· ${item.benefit}</div>
                </div>
              </div>`;
          }).join('')}
        </div>
      </div>`;
    offset+=pack.items.length;
    return html;
  }).join('');

  return `
    <div style="padding:14px 20px 8px;display:flex;justify-content:space-between;align-items:flex-end">
      <div>
        <div class="section-lbl" style="margin:0 0 2px">TODAY Â· ${dateLabel(today)}</div>
        <div style="font-size:11px;color:#555;margin-top:2px">Pre-pack on Sunday Â· grab and go all week</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:11px;color:var(--accent)">${suppDone}/${totalItems} taken</div>
        <div style="font-size:11px;color:#ff88aa;margin-top:2px">${sexDone}/${SEX_CHECKLIST.length} habits</div>
      </div>
    </div>

    <div style="margin:8px 20px 16px;background:#0d1a12;border-radius:8px;padding:10px 14px;border:1px solid #1a2e1f;font-size:12px;color:#00ff88;line-height:1.6">
      ðŸ’¡ <strong>How to use:</strong> Every Sunday, fill your pill pouches for the week. Label each pouch with the day and time. Grab the right pouch in the morning, pre-workout, and evening. Check items off below as you take them.
    </div>

    ${packHTML}

    <div style="margin:0 20px 16px">
      <div class="section-lbl pink" style="margin-bottom:8px">âš¡ SEX GOD DAILY CHECKLIST</div>
      ${(()=>{
        return SEX_CHECKLIST.map((s,i)=>{
          const done=!!dd.sex[i];
          if(s.type==='porn') return ''; // Moved to Recovery tab
          const safeToday = today;
          return '<div class="sex-item '+(done?'done':'')+'" onclick="toggleSex(this)" data-date="'+safeToday+'" data-idx="'+i+'">'
            +'<div class="sex-check '+(done?'checked':'')+'"></div>'
            +'<div>'
            +'<div style="font-size:14px;'+(done?'color:#444;text-decoration:line-through':'')+'">'+(s.n)+'</div>'
            +'<div style="font-size:11px;color:#555;margin-top:2px">'+s.d+'</div>'
            +'</div></div>';
        }).join('');
      })()}
    </div>

    <div style="margin:0 20px 16px;padding:14px;background:#1a0d0d;border-radius:10px;border:1px solid #2e1a1a;font-size:12px;color:#888;line-height:1.6">
      âš ï¸ On Vyvanse, Wellbutrin & Sertraline. Clear all supplements with your doctor first.
    </div>
    <div id="hkitContainer">${renderHygieneKit(today, dd)}</div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALENDAR TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCalendar(){
  const today=todayStr();
  const year=UI.calYear,month=UI.calMonth;
  const monthNames=['January','February','March','April','May','June','July','August','September','October','November','December'];
  const daysInMonth=new Date(year,month+1,0).getDate();
  const firstDay=new Date(year,month,1).getDay();
  const days=[];
  for(let i=0;i<firstDay;i++)days.push(null);
  for(let i=1;i<=daysInMonth;i++)days.push(i);

  function getStatus(d){
    if(!d)return'';
    const ds=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const data=DB.days&&DB.days[ds];
    if(!data)return'';
    const exDone=Object.values(data.ex||{}).filter(Boolean).length;
    const recDone=Object.values(data.rec||{}).filter(Boolean).length;
    const suppDone=Object.values(data.supp||{}).filter(Boolean).length;
    const dow=new Date(parseInt(year),parseInt(month),parseInt(d)).getDay();
    if(dow===0)return recDone>=3?'rest':'';
    if(exDone>=3||suppDone>=5)return'trained';
    if(exDone>0||recDone>0)return'partial';
    return'';
  }

  let streak=0;
  const chk=new Date();
  while(streak<365){
    const ds=`${chk.getFullYear()}-${String(chk.getMonth()+1).padStart(2,'0')}-${String(chk.getDate()).padStart(2,'0')}`;
    const data=DB.days&&DB.days[ds];
    const active=data&&(Object.values(data.ex||{}).filter(Boolean).length>0||Object.values(data.rec||{}).filter(Boolean).length>0);
    if(active){streak++;chk.setDate(chk.getDate()-1);}else break;
  }
  const trainedDays=Object.entries(DB.days||{}).filter(([,v])=>Object.values(v.ex||{}).filter(Boolean).length>0||Object.values(v.rec||{}).filter(Boolean).length>0).length;

  const cells=days.map(d=>{
    if(!d)return`<div class="cal-day empty"></div>`;
    const ds=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isToday=ds===today;
    const st=getStatus(d);
    const cls=['cal-day',isToday?'today':'',st].filter(Boolean).join(' ');
    return`<div class="${cls}" onclick="openModal('${ds}')">${d}</div>`;
  }).join('');

  return`
    <div class="cal-wrap">
      <div style="display:flex;gap:12px;margin-bottom:16px">
        <div style="flex:1;background:#111;border-radius:10px;padding:12px;border:1px solid #1a1a1a;text-align:center">
          <div style="font-size:28px;font-family:Impact,'Arial Narrow','Arial Black',sans-serif;color:var(--accent)">${streak}</div>
          <div style="font-size:10px;color:#444;letter-spacing:2px">DAY STREAK</div>
        </div>
        <div style="flex:1;background:#111;border-radius:10px;padding:12px;border:1px solid #1a1a1a;text-align:center">
          <div style="font-size:28px;font-family:Impact,'Arial Narrow','Arial Black',sans-serif;color:#ff6b35">${trainedDays}</div>
          <div style="font-size:10px;color:#444;letter-spacing:2px">ACTIVE DAYS</div>
        </div>
      </div>
      <div class="cal-nav">
        <button class="nav-btn" onclick="calPrev()">â€¹</button>
        <div class="cal-month">${monthNames[month]} ${year}</div>
        <button class="nav-btn" onclick="calNext()">â€º</button>
      </div>
      <div class="cal-grid">
        ${['S','M','T','W','T','F','S'].map(d=>`<div class="cal-dow">${d}</div>`).join('')}
        ${cells}
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:12px;padding:12px;background:#111;border-radius:8px;border:1px solid #1a1a1a">
        <div style="display:flex;align-items:center;gap:6px"><div style="width:12px;height:12px;border-radius:3px;background:var(--accent)"></div><span style="font-size:11px;color:#666">Trained</span></div>
        <div style="display:flex;align-items:center;gap:6px"><div style="width:12px;height:12px;border-radius:3px;background:#1a3a1a"></div><span style="font-size:11px;color:#666">Partial</span></div>
        <div style="display:flex;align-items:center;gap:6px"><div style="width:12px;height:12px;border-radius:3px;background:#1a1a2e"></div><span style="font-size:11px;color:#666">Recovery</span></div>
        <div style="display:flex;align-items:center;gap:6px"><div style="width:12px;height:12px;border-radius:3px;border:1px solid var(--accent)"></div><span style="font-size:11px;color:#666">Today</span></div>
      </div>
      <div style="margin-top:10px;font-size:11px;color:#444;text-align:center;letter-spacing:1px">TAP ANY DAY TO SEE YOUR LOG</div>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderModal(dateStr){
  const data=DB.days&&DB.days[dateStr];
  let sections='';
  if(data){
    const exE=Object.entries(data.ex||{}).filter(([,v])=>v);
    if(exE.length){
      sections+=`<div class="modal-section-lbl">EXERCISES</div>${exE.map(([key])=>{
        const[p,d,i]=key.split('-').map(Number);
        // Try all equipment setups to find the exercise name
        const equipKeys2=['gym','bowflex','bands','bodyweight'];
        let ex=null;
        for(var ek2=0;ek2<equipKeys2.length;ek2++){
          const candidate=FIGHTERS[equipKeys2[ek2]]?.days[d]?.exercises[i];
          if(candidate){ex=candidate;break;}
        }
        if(!ex) return '';
        // Build per-set weight display
        const setRows=[];
        for(let s=0;s<ex.s;s++){
          const sw=data.w?.[key+'-s'+s];
          if(sw) setRows.push('<span style="font-size:11px;color:#555;margin-right:8px">S'+(s+1)+'</span><span style="font-size:12px;color:var(--accent)">'+sw+'lbs</span>');
        }
        const weightDisplay=setRows.length
          ? `<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px">${setRows.map(r=>'<span style="background:#0d1a0d;padding:3px 8px;border-radius:4px;display:inline-flex;align-items:center;gap:4px">'+r+'</span>').join('')}</div>`
          : `<span style="font-size:12px;color:#555">${ex.s}Ã—${ex.r}</span>`;
        return `<div class="modal-row" style="flex-direction:column;align-items:flex-start;gap:4px">
          <span style="font-size:13px;color:#ccc">${ex.n}</span>
          ${weightDisplay}
        </div>`;
      }).join('')}`;
    }
    const bfE=Object.entries(data.bf||{}).filter(([,v])=>v);
    if(bfE.length){
      sections+=`<div class="modal-section-lbl" style="color:#6699ff">BODY FIX DONE</div>${bfE.map(([key])=>{
        const i=parseInt(key.split('-')[2]);
        const bf=BODY_FIX[i];
        return bf?`<div class="modal-row"><span style="font-size:12px;color:#6699ff">${bf.n}</span><span style="color:#6699ff">âœ“</span></div>`:'';
      }).join('')}`;
    }
    const recE=Object.entries(data.rec||{}).filter(([,v])=>v);
    if(recE.length){
      sections+=`<div class="modal-section-lbl">RECOVERY / ACTIVITIES</div>${recE.map(([key])=>{
        let label='';
        if(key.startsWith('fri-'))label=FRIDAY_PLAN[parseInt(key.split('-')[1])]?.t;
        else if(key.startsWith('sat-'))label=SATURDAY_PLAN[parseInt(key.split('-')[1])]?.t;
        else if(key.startsWith('sun-'))label=SUNDAY_PLAN[parseInt(key.split('-')[1])]?.t;
        else if(key.startsWith('prep-'))label='ðŸ“¦ '+PREP_CHECKLIST[parseInt(key.split('-')[1])]?.t;
        return label?`<div class="modal-row"><span style="font-size:12px;color:#ccc">${label}</span><span style="color:#00ff88">âœ“</span></div>`:'';
      }).join('')}`;
    }
    const suppE=Object.entries(data.supp||{}).filter(([,v])=>v);
    if(suppE.length){
      sections+=`<div class="modal-section-lbl">SUPPLEMENTS</div>${suppE.map(([idx])=>{
        const s=SUPPLEMENTS[parseInt(idx)];
        return s?`<div class="modal-row"><span style="font-size:12px;color:#ccc">${s.n}</span><span style="font-size:11px;color:#555">${s.dose}</span></div>`:'';
      }).join('')}`;
    }
    const sexE=Object.entries(data.sex||{}).filter(([,v])=>v);
    if(sexE.length){
      sections+=`<div class="modal-section-lbl" style="color:#ff88aa">SEX GOD HABITS</div>${sexE.map(([idx])=>{
        const s=SEX_CHECKLIST[parseInt(idx)];
        return s?`<div class="modal-row"><span style="font-size:12px;color:#ff88aa">${s.n}</span><span>âœ“</span></div>`:'';
      }).join('')}`;
    }
  }
  if(!sections)sections=`<div style="font-size:13px;color:#444;text-align:center;padding:20px">No data recorded for this day.</div>`;
  return`
    <div class="modal-overlay" onclick="if(event.target===this)closeModal()">
      <div class="modal">
        <div class="modal-handle"></div>
        <div class="modal-date">${dateLabel(dateStr)}</div>
        ${sections}
        <button class="modal-close" onclick="closeModal()">CLOSE</button>
      </div>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HABITS TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHabits(today,dd){
  var totalDone = HABITS.filter(function(_,i){ return !!dd.habits[i]; }).length;
  var dow = getDowStr(today);
  var dayNum = new Date(today+'T12:00:00').getDay();
  var dowKey = ['MON','TUE','WED','THU','FRI','SAT','SUN'][dayNum===0?6:dayNum-1];

  var html = '<div style="padding:12px 0 0">';
  html += '<div style="padding:0 20px 14px;display:flex;justify-content:space-between;align-items:center">'
    + '<div><div style="font-size:10px;letter-spacing:3px;color:#555;font-family:Impact,sans-serif">DAILY NON-NEGOTIABLES</div>'
    + '<div style="font-size:12px;color:#666;margin-top:3px">'+dow+' \u00b7 tap habit name for today\u2019s instructions</div></div>'
    + '<div style="font-size:22px;font-family:Impact,sans-serif;color:var(--accent)">'+totalDone+'/'+HABITS.length+'</div>'
    + '</div>';

  var pct = Math.round(totalDone/HABITS.length*100);
  html += '<div style="margin:0 20px 16px">'
    + '<div style="display:flex;justify-content:space-between;font-size:10px;color:#444;margin-bottom:4px"><span>TOTAL PROGRESS</span><span style="color:var(--accent)">'+pct+'%</span></div>'
    + '<div style="height:6px;background:#1a1a1a;border-radius:3px"><div style="height:6px;border-radius:3px;background:var(--accent);width:'+pct+'%;transition:width 0.3s"></div></div>'
    + '</div>';

  html += renderMinoxTracker(today, dd);

  HABIT_GROUPS.forEach(function(group){
    var groupDone = group.habits.filter(function(h){ return !!dd.habits[h.id]; }).length;
    var groupTotal = group.habits.length;
    var groupComplete = groupDone === groupTotal;
    var groupKey = 'hg-'+group.id;
    var isOpen = !(dd.habits[groupKey+'_collapsed'] === true);

    html += '<div class="hgroup" style="border-color:'+(groupComplete ? group.color+'44' : '#222')+'">';
    html += '<div class="hgroup-header" onclick="toggleHabitGroup(\''+groupKey+'\')" style="background:'+(groupComplete?'#0a0a0a':'#151515')+'">'
      + '<div class="hgroup-icon">'+group.icon+'</div>'
      + '<div class="hgroup-label" style="color:'+(groupComplete?group.color:'#ccc')+'">'+group.label+'</div>'
      + '<div class="hgroup-count" style="color:'+group.color+';border:1px solid '+group.color+'44">'+groupDone+'/'+groupTotal+'</div>'
      + '<div class="hgroup-arrow'+(isOpen?' open':'')+'" id="arr-'+groupKey+'">&#9658;</div>'
      + '</div>';

    html += '<div class="hgroup-body" id="body-'+groupKey+'" style="display:'+(isOpen?'block':'none')+'">';

    group.habits.forEach(function(h){
      var isDone = !!dd.habits[h.id];
      var todayTip = h.days && h.days[dowKey] ? h.days[dowKey] : '';
      var detailKey = 'hd-'+h.id;
      var isDetailOpen = !!(dd.habits[detailKey+'_open']);

      html += '<div class="hnew-item'+(isDone?' done':'')+'" id="hi-'+h.id+'">'
        + '<div class="hnew-top">'
        + '<div class="hnew-check'+(isDone?' checked':'')+'" onclick="toggleHabitNew(event,\''+today+'\','+h.id+')">'+(isDone?'&#10003;':'')+'</div>'
        + '<div class="hnew-icon">'+h.icon+'</div>'
        + '<div class="hnew-label habit-label" onclick="toggleHabitDetail(\''+detailKey+'\')" style="'+(isDone?'color:#444;text-decoration:line-through;':'')+'">'+h.label+'</div>'
        + '<div class="hnew-expand'+(isDetailOpen?' open':'')+'" onclick="toggleHabitDetail(\''+detailKey+'\')" id="exp-'+detailKey+'">&#9660;</div>'
        + '</div>'
        + '<div class="hnew-detail'+(isDetailOpen?' open':'')+'" id="det-'+detailKey+'">'
        + '<div class="habit-detail">'+h.detail+'</div>'
        + (todayTip ? '<div class="habit-today-tip" style="background:#0f1a0f;border-left:3px solid var(--accent);color:#aaa">'
          + '<span style="font-size:10px;letter-spacing:2px;color:var(--accent);display:block;margin-bottom:4px;font-family:Impact,sans-serif">TODAY \u2014 '+dowKey+'</span>'
          + todayTip + '</div>' : '')
        + '</div>'
        + '</div>';
    });

    html += '</div></div>';
  });

  html += renderNutritionSection();
  html += '</div>';
  return html;
}

function toggleHabitGroup(key){
  var body = document.getElementById('body-'+key);
  var arr = document.getElementById('arr-'+key);
  if(!body) return;
  var isOpen = body.style.display !== 'none';
  body.style.display = isOpen ? 'none' : 'block';
  if(arr){ arr.classList.toggle('open', !isOpen); }
  var dd = getDD(UI.activeDate);
  dd.habits[key+'_collapsed'] = !isOpen;
  saveDB();
}

function toggleHabitDetail(key){
  var det = document.getElementById('det-'+key);
  var exp = document.getElementById('exp-'+key);
  if(!det) return;
  var isOpen = det.classList.contains('open');
  det.classList.toggle('open', !isOpen);
  if(exp) exp.classList.toggle('open', !isOpen);
  var dd = getDD(UI.activeDate);
  dd.habits[key+'_open'] = !isOpen;
  saveDB();
}

function toggleHabitNew(e, date, idx){
  e.stopPropagation();
  var dd = getDD(date);
  dd.habits[idx] = !dd.habits[idx];
  saveDB();
  var item = document.getElementById('hi-'+idx);
  if(!item){ render(); return; }
  var check = item.querySelector('.hnew-check');
  var label = item.querySelector('.hnew-label');
  if(dd.habits[idx]){
    item.classList.add('done');
    if(check){ check.classList.add('checked'); check.innerHTML='&#10003;'; }
    if(label){ label.style.color='#444'; label.style.textDecoration='line-through'; }
  } else {
    item.classList.remove('done');
    if(check){ check.classList.remove('checked'); check.innerHTML=''; }
    if(label){ label.style.color=''; label.style.textDecoration=''; }
  }
  item.classList.add('flash');
  setTimeout(function(){ item.classList.remove('flash'); }, 500);
  var totalDone = HABITS.filter(function(_,i){ return !!getDD(date).habits[i]; }).length;
  var newPct = Math.round(totalDone/HABITS.length*100);
  var fills = document.querySelectorAll('.hab-prog-fill');
  fills.forEach(function(f){ f.style.width=newPct+'%'; });
  var cnts = document.querySelectorAll('.hab-total-count');
  cnts.forEach(function(c){ c.textContent=totalDone+'/'+HABITS.length; });
}

function renderNutritionSection(){
  var html = '<div style="margin-top:20px">';
  html += '<div class="section-lbl" style="padding:0 20px;margin-bottom:10px">NUTRITION TARGETS</div>';
  html += '<div style="display:flex;flex-wrap:wrap;gap:8px;padding:0 20px">';
  NUTRITION.forEach(function(n){
    html += '<div class="nut-card"><div style="font-size:14px;font-family:Impact,sans-serif;letter-spacing:1px">'+n.label+'</div>'
      +'<div style="font-size:14px;font-weight:600;color:'+n.color+'">'+n.value+'</div></div>';
  });
  html += '</div></div>';
  html += '<div class="vyv-box" style="margin:16px 20px 0">'
    + '<div style="font-size:14px;font-family:Impact,sans-serif;letter-spacing:1px;color:#6699ff;margin-bottom:8px">\ud83d\udc8a VYVANSE EATING STRATEGY</div>'
    + '<div style="font-size:13px;color:#666;line-height:2">\ud83c\udf05 <strong style="color:#888">Morning:</strong> Eat big BEFORE it kicks in</div>'
    + '<div style="font-size:13px;color:#666;line-height:2">\u2600\ufe0f <strong style="color:#888">Midday:</strong> Protein shake when appetite is gone</div>'
    + '<div style="font-size:13px;color:#666;line-height:2">\ud83c\udf19 <strong style="color:#888">Evening:</strong> Biggest meal when it wears off</div>'
    + '</div>';
  html += '<div style="margin:16px 20px 0"><div class="section-lbl" style="margin-bottom:10px">PROGRESS TIMELINE</div>';
  html += '<div class="timeline-wrap"><div class="timeline-line"></div>';
  TIMELINE.forEach(function(t){
    html += '<div class="tl-item">'
      +'<div class="tl-dot" style="background:'+t.color+'"></div>'
      +'<div class="tl-week bebas" style="color:'+t.color+'">'+t.week+'</div>'
      +'<div class="tl-text">'+t.text+'</div>'
      +'</div>';
  });
  html += '</div></div>';
  return html;
}


const MOTIVATIONS = [
  {tag:"FIGHTER'S MINDSET", msg:"Every rep you do today is a rep the version of you from last year couldn't finish. You are already ahead. Now go prove it."},
  {tag:"SEXUAL ENERGY", msg:"The discipline you build in the gym transfers directly to the bedroom. Men who train hard perform hard. This is not a coincidence."},
  {tag:"MARTIAL ARTS", msg:"Your punch power is built in the gym. Hip thrusts, cable rotations, explosive squats â€” you are building knockout power right now."},
  {tag:"ACCOUNTABILITY", msg:"Nobody is coming to save you. No coach, no partner, no cheat code. Just you, the bar, and the decision to show up again."},
  {tag:"BODY TRANSFORMATION", msg:"The body you want already exists. It is sitting under the version of you that skips days. Train today and let it out."},
  {tag:"TESTOSTERONE", msg:"Sleep, training, protein, and zinc. That is your testosterone protocol. Every habit you log today is a hormone optimization."},
  {tag:"CONSISTENCY", msg:"You do not need motivation. You need discipline. Motivation is a feeling. Discipline is showing up when the feeling is gone."},
  {tag:"GROOMING", msg:"A man who handles his body in the gym also handles his skin, his beard, and his presence. You are building the whole package."},
  {tag:"FRENCH GOALS", msg:"The man you are becoming speaks French, moves with power, and commands respect in every room. Build him today."},
  {tag:"FIGHTER'S POWER", msg:"Pull. Push. Legs. Core. Four days. That is all it takes to build a body that people notice and opponents respect."},
  {tag:"RECOVERY", msg:"The workout breaks you down. Sleep and food build you back up bigger. Do not skip the recovery â€” it is half the program."},
  {tag:"SUPPLEMENTS", msg:"The pills you take daily are not optional extras. They are your performance stack. Skip them and you are leaving gains on the table."},
  {tag:"LONG GAME", msg:"Week 12 of this program, you will look in the mirror and not recognize yourself. But that version is being built right now, today, this session."},
  {tag:"SEXUAL STAMINA", msg:"Hip thrusts are not just a glute exercise. They are stamina training. Glute bridges are not just for aesthetics. They are performance training."},
  {tag:"PRESSURE", msg:"The pressure you feel right now is the resistance that builds the diamond. Every hard day is compressing you into something better."},
  {tag:"IDENTITY", msg:"Stop asking if you are motivated. Start asking who you are. A man who trains does not need to feel like it. He just does."},
  {tag:"BEARD GROWTH", msg:"Minoxidil works. Dermaroller works. But only if you are consistent. Two applications today. No excuses. The beard is being built."},
  {tag:"FIGHTER'S MINDSET", msg:"Fear is the feeling right before you grow. Step into every hard set like you step into a fight. With intention and zero hesitation."},
  {tag:"BLOOD PRESSURE", msg:"Every training session, every clean meal, every good night of sleep is actively lowering your BP. You are healing yourself by showing up."},
  {tag:"ELITE STANDARD", msg:"You are not training to be average. Average men do not track their habits, take their supplements, and show up four days a week. You are not average."},
];


function renderDailyMotivation(today){
  // Pick message based on day of year so it changes daily but is consistent within a day
  const d=new Date(today+'T12:00:00');
  const dayOfYear=Math.floor((d-(new Date(d.getFullYear(),0,0)))/(1000*60*60*24));
  const m=MOTIVATIONS[dayOfYear % MOTIVATIONS.length];
  // Check missed days â€” scan last 7 days for any day with zero activity
  // Check French habit streak
  const frenchIdx = HABITS.findIndex(function(h){return h.icon==='ðŸ‡«ðŸ‡·';});
  let frenchMissedDays = 0;
  for(let fi=0;fi<=7;fi++){
    const fdt=new Date(new Date(today+'T12:00:00'));
    fdt.setDate(fdt.getDate()-fi);
    const fds=fdt.getFullYear()+'-'+String(fdt.getMonth()+1).padStart(2,'0')+'-'+String(fdt.getDate()).padStart(2,'0');
    const fdata=DB.days&&DB.days[fds];
    if(fdata&&fdata.habits&&fdata.habits[frenchIdx]) break;
    if(fi>0) frenchMissedDays++;
  }
  const frenchHTML = frenchMissedDays>=3
    ? '<div style="margin:8px 16px 0;padding:12px 14px;background:#1a1200;border:1px solid #ffcc00;border-radius:10px">'
      +'<div style="font-size:9px;letter-spacing:2px;color:#ffcc00;margin-bottom:4px;font-family:Impact,sans-serif">ðŸ‡«ðŸ‡· FRENCH â€” '+frenchMissedDays+' DAYS WITHOUT PRACTICE</div>'
      +'<div style="font-size:12px;color:#cc9900;line-height:1.6">You bought Pingo. You have a Udemy course. You have paid real money to learn French and you are not using it. 10 minutes today. That is it. Stop wasting what you already paid for.</div>'
      +'</div>'
    : '';

  // Street Tactics missed callout â€” check Saturdays and Sundays specifically
  const streetIdx = HABITS.findIndex(function(h){return h.icon==='ðŸ¥‹';});
  let streetMissedWeeks = 0;
  // Check last 2 weekends (4 days: last Sat, last Sun, Sat before, Sun before)
  const weekendDays = [];
  const nowD = new Date(today+'T12:00:00');
  for(let wi=0;wi<=14;wi++){
    const wdt=new Date(nowD); wdt.setDate(wdt.getDate()-wi);
    if(wdt.getDay()===6||wdt.getDay()===0) weekendDays.push(wdt);
    if(weekendDays.length>=4) break;
  }
  const streetMissed = weekendDays.filter(function(wdt){
    const wds=wdt.getFullYear()+'-'+String(wdt.getMonth()+1).padStart(2,'0')+'-'+String(wdt.getDate()).padStart(2,'0');
    const wdata=DB.days&&DB.days[wds];
    return !wdata||!wdata.habits||!wdata.habits[streetIdx];
  }).length;
  const streetHTML = streetMissed>=3
    ? '<div style="margin:8px 16px 0;padding:12px 14px;background:#0d0a1a;border:1px solid #9966ff;border-radius:10px">'
      +'<div style="font-size:9px;letter-spacing:2px;color:#9966ff;margin-bottom:4px;font-family:Impact,sans-serif">ðŸ¥‹ STREET TACTICS â€” NOT BEING USED</div>'
      +'<div style="font-size:12px;color:#7744cc;line-height:1.6">You are paying for Street Tactics and not watching a single lesson. You train on weekends. Watch one video before you go. Drill what you learned while you are there. Stop paying for something you are not using.</div>'
      +'</div>'
    : '';

  // Teeth callout â€” if missed 2+ days in last 3
  const teethIdx = HABITS.findIndex(function(h){return h.icon==='ðŸ¦·';});
  const flossIdx = HABITS.findIndex(function(h){return h.icon==='ðŸ§µ';});
  let teethMissed=0, flossMissed=0;
  for(let ti=0;ti<=3;ti++){
    const tdt=new Date(new Date(today+'T12:00:00')); tdt.setDate(tdt.getDate()-ti);
    const tds=tdt.getFullYear()+'-'+String(tdt.getMonth()+1).padStart(2,'0')+'-'+String(tdt.getDate()).padStart(2,'0');
    const tdata=DB.days&&DB.days[tds];
    if(ti>0 && (!tdata||!tdata.habits||!tdata.habits[teethIdx])) teethMissed++;
    if(ti>0 && (!tdata||!tdata.habits||!tdata.habits[flossIdx])) flossMissed++;
  }
  const teethHTML = teethMissed>=2
    ? '<div style="margin:8px 16px 0;padding:12px 14px;background:#0d0d0d;border:1px solid #88ccff;border-radius:10px">'
      +'<div style="font-size:9px;letter-spacing:2px;color:#88ccff;margin-bottom:4px;font-family:Impact,sans-serif">ðŸ¦· ORAL HYGIENE â€” YOU NASTY FUCK</div>'
      +'<div style="font-size:12px;color:#5599aa;line-height:1.6">'
      +(teethMissed>=2&&flossMissed>=2
        ? 'You have not been brushing or flossing consistently. You are out here trying to be a sex god with a mouth that smells like a garbage can. Nobody wants to be close to that. Two minutes. Twice a day. Floss at night. This is not negotiable if you actually want to kiss someone.'
        : teethMissed>=2
          ? 'You keep skipping brushing your teeth. You are working on your body, your beard, your supplements â€” and then breathing on people with a dirty mouth. Fix this tonight. Two minutes is nothing.'
          : 'You have not flossed in days. Gum disease is real, it tanks your confidence up close, and it takes 60 seconds to prevent. Stop being lazy about the one habit that takes less than a minute.')
      +'</div>'
      +'</div>'
    : '';

  const missedCallouts=[];
  for(let i=0;i<=7;i++){
    const dt=new Date(new Date(today+'T12:00:00'));
    dt.setDate(dt.getDate()-i);
    const ds=dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0')+'-'+String(dt.getDate()).padStart(2,'0');
    const dayData=DB.days&&DB.days[ds];
    const dow=dt.getDay();
    const isTrainingDay=dow>=1&&dow<=4; // Mon-Thu
    if(isTrainingDay){
      const dayIdx=dow-1; // Mon=0 Tue=1 Wed=2 Thu=3
      // Check any equipment setup for that day
      const equipKeys=['gym','bowflex','bands','bodyweight'];
      let totalEx=10, doneCt=0;
      for(var eki=0;eki<equipKeys.length;eki++){
        const ek=equipKeys[eki];
        const exs=FIGHTERS[ek]&&FIGHTERS[ek].days[dayIdx]?FIGHTERS[ek].days[dayIdx].exercises:[];
        if(!exs.length) continue;
        const ekKey=ek+'-'+dayIdx;
        const dc=exs.filter(function(_,ei){return dayData&&dayData.ex&&dayData.ex[ekKey+'-'+ei];}).length;
        if(dc>doneCt){doneCt=dc;totalEx=exs.length;}
      }
      const pct=doneCt/totalEx;
      if(pct<0.5 && i>0){
        const dayName=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dow];
        missedCallouts.push(dayName+(doneCt>0?' ('+Math.round(pct*100)+'%)':''));
      }
    }
  }
  const missedAnger = missedCallouts.length>=4
    ? 'You skipped '+missedCallouts.join(', ')+' this week. That is not a rough week. That is a choice to be a bitch. The whole program is sitting right here and you still could not show up. What is actually wrong with you?'
    : missedCallouts.length>=2
    ? 'You missed '+missedCallouts.join(', ')+'. Two or more missed days means you are not serious. You are just pretending to be serious. Cut the bullshit and show up.'
    : 'You half-assed '+missedCallouts.join(', ')+'. Under 50 percent logged. That is not training. That is showing up to waste your own time. Finish the workout or do not start it.';

  const missedHTML = missedCallouts.length>0
    ? '<div style="margin:8px 16px 0;padding:14px;background:#1a0000;border:2px solid #ff0055;border-radius:10px">'
      +'<div style="font-size:10px;letter-spacing:2px;color:#ff0055;margin-bottom:6px;font-family:Impact,sans-serif">ðŸš¨ ACCOUNTABILITY CHECK â€” '+missedCallouts.join(', ').toUpperCase()+'</div>'
      +'<div style="font-size:13px;color:#ff6b35;line-height:1.7;font-weight:500">'+missedAnger+'</div>'
      +'</div>'
    : '';

  // â”€â”€ MISSED SUPPLEMENT CALLOUT â”€â”€
  let suppMissedDays=0;
  for(var si=1;si<=3;si++){
    const sdt=new Date(new Date(today+'T12:00:00')); sdt.setDate(sdt.getDate()-si);
    const sds=sdt.getFullYear()+'-'+String(sdt.getMonth()+1).padStart(2,'0')+'-'+String(sdt.getDate()).padStart(2,'0');
    const sd=DB.days&&DB.days[sds];
    const suppObj=sd&&sd.supp||{};
    const logged=Object.values(suppObj).filter(Boolean).length;
    const totalSupps=typeof SUPPLEMENTS!=='undefined'?SUPPLEMENTS.length:8;
    if(logged < Math.floor(totalSupps*0.5)) suppMissedDays++;
  }
  const suppHTML = suppMissedDays>=2
    ? '<div style="margin:8px 16px 0;padding:14px;background:#0d0800;border:2px solid #ff6b35;border-radius:10px">'
      +'<div style="font-size:10px;letter-spacing:2px;color:#ff6b35;margin-bottom:8px;font-family:Impact,sans-serif">ðŸ’Š SUPPLEMENT CALLOUT â€” '+suppMissedDays+' DAYS MISSED</div>'
      +'<div style="font-size:13px;color:#cc5500;line-height:1.7">'
      +(suppMissedDays>=3
        ? 'You spent real money on supplements â€” Zinc, D3, Ashwagandha, Nitric Oxide, BIRDMAN protein â€” and you have not been taking them. That is not a mistake. That is you self-sabotaging your own results on purpose. The pills are RIGHT THERE. Open the pouch. It takes 30 seconds. You are throwing away gains, testosterone, sleep quality, and beard growth every single day you skip. Stop being a lazy fuck and take your supplements.'
        : 'You missed your supplements again. Two days in a row. You bought them. You organized them. You built this entire app. And then you just do not take them. The Ashwagandha alone would help your cortisol and sleep. The Nitric Oxide would make your workouts better. The Zinc would boost your testosterone. But none of that works if they stay in the bottle. Open the app. Log your pack. Right now.')
      +'</div>'
      +'</div>'
    : '';

  // â”€â”€ ZERO HABITS NUCLEAR BANNER â”€â”€
  const currentHour = new Date().getHours();
  const todayHabits = Object.values((DB.days&&DB.days[today]&&DB.days[today].habits)||{}).filter(Boolean).length;
  const zeroHabitsHTML = (currentHour>=20 && todayHabits===0)
    ? '<div style="margin:8px 16px 0;padding:16px;background:#1a0000;border:3px solid #ff0000;border-radius:10px;animation:pulse 2s infinite">'
      +'<div style="font-size:11px;letter-spacing:2px;color:#ff0000;margin-bottom:8px;font-family:Impact,sans-serif">â˜ ï¸ ZERO HABITS TODAY â€” IT IS PAST 8PM</div>'
      +'<div style="font-size:14px;color:#ff4444;line-height:1.7;font-weight:500">'
      +'You logged ZERO habits today. Not one. You did not brush your teeth. You did not take your supplements. You did not do your skincare. You did not check off a single thing. That is not a bad day. That is a day you actively chose to stay exactly where you are â€” weak, unfocused, and further from the man you say you want to be. This app cannot want it for you. You have to want it. Do at least ONE thing right now before you sleep. One thing. Because a man who does nothing every day stays nothing.'
      +'</div>'
      +'<div style="margin-top:12px;font-size:11px;color:#882222">Still time tonight: Brush teeth Â· Floss Â· Take night supplements Â· Skincare Â· Log your status in Recovery</div>'
      +'</div>'
    : (currentHour>=20 && todayHabits<=2)
    ? '<div style="margin:8px 16px 0;padding:12px 14px;background:#120800;border:2px solid #ff6b35;border-radius:10px">'
      +'<div style="font-size:10px;letter-spacing:2px;color:#ff6b35;margin-bottom:6px;font-family:Impact,sans-serif">âš ï¸ ONLY '+todayHabits+' HABIT'+(todayHabits===1?'':'S')+' TODAY â€” IT IS PAST 8PM</div>'
      +'<div style="font-size:12px;color:#cc4400;line-height:1.6">Almost nothing done today. You still have time â€” brush your teeth, take your night supplements, log your recovery status. Do not end today at zero. A few checkmarks is still better than none.</div>'
      +'</div>'
    : '';

  return '<div style="margin:0 16px 0;padding:14px 16px;background:linear-gradient(135deg,#0a0a0a,#111);border:1px solid #1e1e1e;border-left:3px solid var(--accent);border-radius:10px">'
    +'<div style="font-size:9px;letter-spacing:2px;color:var(--accent);margin-bottom:6px;font-family:Impact,sans-serif">'+m.tag+' Â· TODAY</div>'
    +'<div style="font-size:13px;color:#ccc;line-height:1.6;font-style:italic">'+m.msg+'</div>'
    +'</div>'
    + missedHTML
    + suppHTML
    + zeroHabitsHTML
    + frenchHTML
    + streetHTML
    + teethHTML;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RECOVERY TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TRIGGERS = ['Stress','Boredom','Loneliness','Late night','Phone in bed','Drinking','After argument','Anxious','Tired','Idle time'];
const REDIRECT_ACTIONS = ['20 pushups NOW','Cold shower','Shadowbox 5 min','Walk outside','Call someone','Drink water + breathe','Journal it out','Do your Kegels'];

function calcCleanStreak(today){
  let streak=0;
  const todayD=new Date(today+'T12:00:00');
  for(let d=0;d<365;d++){
    const dt=new Date(todayD);
    dt.setDate(dt.getDate()-d);
    const ds=dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0')+'-'+String(dt.getDate()).padStart(2,'0');
    const dayData=DB.days&&DB.days[ds];
    if(!dayData||!dayData.sex) break;
    if(dayData.sex['porn-status']==='slipped') break;
    if(dayData.sex['porn-status']==='clean') streak++;
    else break;
  }
  return streak;
}

function renderRecovery(today,dd){
  const streak=calcCleanStreak(today);
  const todayStatus=dd.sex&&dd.sex['porn-status'];

  // Build 30-day streak calendar
  let calHTML='<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:4px">';
  const dayLabels=['M','T','W','T','F','S','S'];
  dayLabels.forEach(l=>{ calHTML+='<div style="text-align:center;font-size:9px;color:#444;padding-bottom:2px">'+l+'</div>'; });
  calHTML+='</div>';
  calHTML+='<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px">';
  const todayD=new Date(today+'T12:00:00');
  // Show last 35 days (5 weeks)
  for(let i=34;i>=0;i--){
    const dt=new Date(todayD);
    dt.setDate(dt.getDate()-i);
    const ds=dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0')+'-'+String(dt.getDate()).padStart(2,'0');
    const dayData=DB.days&&DB.days[ds];
    const status=dayData&&dayData.sex&&dayData.sex['porn-status'];
    const isToday=ds===today;
    let bg='#1a1a1a'; let border='#222';
    if(status==='clean'){bg='#003d1f';border='#00ff88';}
    else if(status==='slipped'){bg='#3d0010';border='#ff0055';}
    calHTML+='<div style="aspect-ratio:1;border-radius:4px;background:'+bg+';border:1px solid '+border+(isToday?';box-shadow:0 0 0 2px #ff6b35':'')+'" title="'+ds+'"></div>';
  }
  calHTML+='</div>';
  calHTML+='<div style="display:flex;gap:12px;margin-top:8px;font-size:10px;color:#555">'
    +'<span style="display:flex;align-items:center;gap:4px"><span style="width:10px;height:10px;background:#003d1f;border:1px solid #00ff88;border-radius:2px;display:inline-block"></span>Clean</span>'
    +'<span style="display:flex;align-items:center;gap:4px"><span style="width:10px;height:10px;background:#3d0010;border:1px solid #ff0055;border-radius:2px;display:inline-block"></span>Slip</span>'
    +'<span style="display:flex;align-items:center;gap:4px"><span style="width:10px;height:10px;background:#1a1a1a;border:1px solid #222;border-radius:2px;display:inline-block"></span>Not logged</span>'
    +'</div>';

  // Urge log for today
  const urges=(dd.urges||[]);
  const urgeHTML=urges.length?urges.map((u,i)=>{
    return '<div style="background:#0d0d0d;border:1px solid #1e1e1e;border-radius:8px;padding:10px 12px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center">'
      +'<div>'
      +'<div style="font-size:12px;color:#ccc">'+u.time+' Â· Intensity: <span style="color:'+(u.intensity>=7?'#ff0055':u.intensity>=4?'#ff6b35':'#00ff88')+'">'+u.intensity+'/10</span></div>'
      +'<div style="font-size:11px;color:#555;margin-top:2px">Trigger: '+u.trigger+' Â· Redirected: '+u.redirect+'</div>'
      +'</div>'
      +'<button onclick="deleteUrge('+i+')" style="background:none;border:none;color:#333;font-size:16px;cursor:pointer;padding:4px">Ã—</button>'
      +'</div>';
  }).join(''):'<div style="font-size:12px;color:#444;padding:8px 0">No urges logged today. Stay strong.</div>';

  // BP log
  const bpEntries=Object.entries(dd.bp||{}).sort();
  const bpHTML=bpEntries.length?bpEntries.map(([time,val])=>{
    const[sys,dia]=val.split('/').map(Number);
    const risk=sys>=140||dia>=90?'high':sys>=130?'elevated':'normal';
    const col=risk==='high'?'#ff0055':risk==='elevated'?'#ff6b35':'#00ff88';
    return '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:#0d0d0d;border:1px solid #1e1e1e;border-radius:8px;margin-bottom:6px">'
      +'<div style="font-size:14px;color:'+col+';font-family:Impact,sans-serif;letter-spacing:1px">'+val+' mmHg</div>'
      +'<div style="font-size:11px;color:#555">'+time+'</div>'
      +'</div>';
  }).join(''):'<div style="font-size:12px;color:#444;padding:8px 0">No readings logged today.</div>';

  // Sleep log
  const sleepData=dd.sleep||{};
  const sleepHTML=sleepData.hours
    ?'<div style="display:flex;gap:12px;align-items:center;padding:10px 12px;background:#0d0d0d;border:1px solid #1e1e1e;border-radius:8px">'
      +'<div style="font-size:24px;font-family:Impact,sans-serif;color:'+(sleepData.hours>=7?'#00ff88':sleepData.hours>=6?'#ff6b35':'#ff0055')+'">'+sleepData.hours+'h</div>'
      +'<div>'
      +'<div style="font-size:12px;color:#ccc">Quality: '+'â˜…'.repeat(sleepData.quality||0)+'â˜†'.repeat(5-(sleepData.quality||0))+'</div>'
      +'<div style="font-size:11px;color:#555;margin-top:2px">'+(sleepData.hours>=7?'Great sleep. Testosterone optimized.':sleepData.hours>=6?'Decent. Aim for 7-8 tonight.':'Low sleep. Testosterone took a hit today.')+'</div>'
      +'</div>'
      +'</div>'
    :'<div style="font-size:12px;color:#444;padding:8px 0">Sleep not logged yet.</div>';

  // â”€â”€ COMMITMENT DECLARATION â”€â”€
  const commitSigned = DB.commitmentSigned || false;
  const commitDate = DB.commitmentDate || null;

  const commitHTML = commitSigned
    ? '<div style="margin:0 16px 16px;padding:16px;background:linear-gradient(135deg,#0a1a0a,#111);border:1px solid #00ff88;border-radius:12px">'
      +'<div style="font-size:10px;letter-spacing:2px;color:#00ff88;margin-bottom:6px;font-family:Impact,sans-serif">âœï¸ YOUR COVENANT â€” SIGNED '+commitDate+'</div>'
      +'<div style="font-size:13px;color:#ccc;line-height:1.8;font-style:italic">"I am committed to overcoming porn addiction. I choose discipline over impulse. I choose the man God made me to be over the man my habits made me. I will not quit."</div>'
      +'</div>'
    : '<div style="margin:0 16px 16px;padding:16px;background:#0d0d0d;border:2px dashed #ff6b35;border-radius:12px">'
      +'<div style="font-size:10px;letter-spacing:2px;color:#ff6b35;margin-bottom:8px;font-family:Impact,sans-serif">âœï¸ YOUR COMMITMENT â€” READ THIS AND SIGN IT</div>'
      +'<div style="font-size:13px;color:#ccc;line-height:1.8;font-style:italic;margin-bottom:14px">"I am committed to overcoming porn addiction. I choose discipline over impulse. I choose the man God made me to be over the man my habits made me. I will not quit."</div>'
      +'<button onclick="signCommitment()" style="width:100%;padding:14px;background:#ff6b35;border:none;border-radius:10px;color:#000;font-family:Impact,sans-serif;font-size:15px;letter-spacing:2px;cursor:pointer">I COMMIT TO THIS. SIGN IT.</button>'
      +'</div>';

  return '<div style="padding:14px 0">'
    + commitHTML

    // â”€â”€ NO FAP LOG CARD â”€â”€
    +(()=>{
      const events=(dd.sex&&dd.sex['porn-events'])||[];
      const hasSlip=events.some(function(e){return e.type==='slipped';});
      const hasClean=events.some(function(e){return e.type==='clean';});
      const borderColor=hasSlip?'#ff0055':hasClean?'#00ff88':'#2a2a3a';
      const titleColor=hasSlip?'#ff0055':hasClean?'#00ff88':'#6699ff';
      let statusHTML='';
      if(hasSlip){
        const slipCount=events.filter(function(e){return e.type==='slipped';}).length;
        statusHTML='<div style="font-size:12px;color:#ff0055;margin-bottom:4px">'+slipCount+' slip'+(slipCount>1?'s':'')+' logged today. God is watching and so is your streak.</div>';
      } else if(hasClean){
        statusHTML='<div style="font-size:12px;color:#00ff88;margin-bottom:4px">âœ… CLEAN TODAY. Dopamine rewiring. Keep going.</div>';
      } else {
        statusHTML='<div style="font-size:11px;color:#555;margin-bottom:8px">Log every event â€” clean or slip. Be honest. No one gets better by lying to themselves.</div>';
      }
      let eventLogHTML='';
      if(events.length){
        eventLogHTML='<div style="margin:8px 0 4px;border-top:1px solid #1a1a2a;padding-top:8px">';
        events.forEach(function(e,ei){
          eventLogHTML+='<div style="display:flex;align-items:center;justify-content:space-between;padding:5px 0;border-bottom:1px solid #111">'
            +'<span style="font-size:11px;color:'+(e.type==='slipped'?'#ff0055':'#00ff88')+'">'+(e.type==='slipped'?'âŒ Slip':'âœ… Clean')+' Â· '+e.time+'</span>'
            +'<button onclick="deleteSlipEvent('+ei+',\''+today+'\')" style="background:none;border:none;color:#555;font-size:20px;cursor:pointer;padding:0 6px;line-height:1">Ã—</button>'
            +'</div>';
        });
        eventLogHTML+='</div>';
      }
      const actionHTML='<div style="margin-top:10px">'
        +'<div style="display:flex;gap:8px;margin-bottom:8px">'
        +'<button onclick="logPorn(this)" data-date="'+today+'" data-status="clean" style="flex:1;padding:10px;background:#0d1a0d;border:1px solid #00ff88;border-radius:8px;color:#00ff88;font-size:11px;font-family:Impact,sans-serif;letter-spacing:1px;cursor:pointer">âœ… STAYED CLEAN</button>'
        +'<button onclick="logPorn(this)" data-date="'+today+'" data-status="slipped" style="flex:1;padding:10px;background:#1a0d0d;border:1px solid #ff0055;border-radius:8px;color:#ff0055;font-size:11px;font-family:Impact,sans-serif;letter-spacing:1px;cursor:pointer">âŒ I SLIPPED</button>'
        +'</div>'
        +'<button onclick="showPastSlipModal()" style="width:100%;padding:8px;background:none;border:1px solid #2a2a2a;border-radius:8px;color:#555;font-size:11px;cursor:pointer;font-family:Impact,sans-serif;letter-spacing:1px">âª LOG A PAST SLIP</button>'
        +'</div>';
      return '<div style="margin:0 16px 16px;background:#0d0d1a;border:2px solid '+borderColor+';border-radius:12px;padding:16px">'
        +'<div style="font-size:13px;font-family:Impact,sans-serif;letter-spacing:1px;color:'+titleColor+';margin-bottom:6px">ðŸ§  NO FAP Â· NO PORN â€” TODAY</div>'
        +statusHTML+eventLogHTML+actionHTML
        +'</div>';
    })()

    // â”€â”€ STREAK HERO â”€â”€
    +'<div style="margin:0 16px 16px;padding:20px;background:linear-gradient(135deg,#0d0d1a,#111);border:2px solid '+(streak>=7?'#00ff88':streak>=3?'#ff6b35':'#ff0055')+';border-radius:14px;text-align:center">'
    +'<div style="font-size:11px;letter-spacing:3px;color:#555;margin-bottom:4px;font-family:Impact,sans-serif">NO FAP Â· NO PORN</div>'
    +'<div style="font-size:64px;font-family:Impact,sans-serif;letter-spacing:2px;color:'+(streak>=7?'#00ff88':streak>=3?'#ff6b35':'#ff0055')+'">'+streak+'</div>'
    +'<div style="font-size:14px;color:#888;margin-bottom:12px">DAY'+(streak===1?'':'S')+' CLEAN</div>'
    +'<div style="font-size:12px;color:#555;line-height:1.6">'
    +(streak===0?'ZERO DAYS. You let a screen beat you. Again. You signed a covenant, you built this whole system, and you still could not say no. That is weak. Get up, use the emergency protocol, and start today or admit you are not actually serious about changing.'
    :streak<3?'One or two days. Do not celebrate. You have been here before and thrown it away. Prove this time you actually mean it.'
    :streak<7?'Almost a week. Your brain is starting to heal. Do not throw it away for 10 minutes of garbage that leaves you feeling worse every single time.'
    :streak<14?'One week clean. Good. Now do it again. The man who quits at week 2 is the same man who stays weak. Keep going.'
    :streak<30?'Two weeks. The rewire is happening whether you feel it or not. Do not blow it now when it is actually starting to work.'
    :streak<60?'30 DAYS CLEAN. Most men never get here because most men are weak. You are not most men. Act like it.'
    :streak<90?'60 days. Your brain chemistry has genuinely changed. You worked too hard to get here to throw it away. Protect this at all costs.'
    :'90+ DAYS. This is who you are now. Not a goal. Not a streak. Your actual identity. ðŸ‘‘')
    +'</div>'
    +'</div>'

    // â”€â”€ TIME SINCE LAST SLIP CLOCK â”€â”€
    +(()=>{
      // Find most recent slip timestamp scanning back through days
      let lastSlipTs = DB.lastSlip || null;
      if(!lastSlipTs){
        // Scan days for most recent slip if no global timestamp stored
        const todayD2=new Date(today+'T12:00:00');
        for(let d=0;d<365;d++){
          const dt=new Date(todayD2);
          dt.setDate(dt.getDate()-d);
          const ds=dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0')+'-'+String(dt.getDate()).padStart(2,'0');
          const dayData=DB.days&&DB.days[ds];
          const dayEvents=(dayData&&dayData.sex&&dayData.sex['porn-events'])||[];
          const slipEvents=dayEvents.filter(e=>e.type==='slipped');
          if(slipEvents.length){
            // Approximate timestamp from date + time string
            const lastSlipTime=slipEvents[slipEvents.length-1].time;
            const[hh,mm]=lastSlipTime.split(':').map(Number);
            const slipDate=new Date(ds+'T'+lastSlipTime+':00');
            lastSlipTs=slipDate.getTime();
            break;
          }
          const oldSlip=dayData&&dayData.sex&&dayData.sex['porn-status']==='slipped';
          if(oldSlip){
            lastSlipTs=new Date(ds+'T12:00:00').getTime();
            break;
          }
        }
      }
      if(!lastSlipTs) return '<div style="margin:0 16px 16px;padding:14px;background:#0d0d0d;border:1px solid #1e1e1e;border-radius:12px;text-align:center"><div style="font-size:10px;letter-spacing:2px;color:#555;margin-bottom:6px;font-family:Impact,sans-serif">â± TIME SINCE LAST SLIP</div><div style="font-size:18px;color:#444;font-family:Impact,sans-serif">No slips recorded yet</div><div style="font-size:11px;color:#333;margin-top:4px">Keep it that way.</div></div>';
      const now=Date.now();
      const diffMs=now-lastSlipTs;
      const diffSecs=Math.floor(diffMs/1000);
      const days=Math.floor(diffSecs/86400);
      const hours=Math.floor((diffSecs%86400)/3600);
      const mins=Math.floor((diffSecs%3600)/60);
      const clockColor=days>=7?'#00ff88':days>=3?'#ff6b35':'#ff0055';
      return '<div style="margin:0 16px 16px;padding:14px;background:#0d0d0d;border:1px solid #1e1e1e;border-radius:12px;text-align:center" id="slipClock">'
        +'<div style="font-size:10px;letter-spacing:2px;color:#555;margin-bottom:8px;font-family:Impact,sans-serif">â± TIME SINCE LAST SLIP</div>'
        +'<div style="font-size:36px;font-family:Impact,sans-serif;letter-spacing:2px;color:'+clockColor+'">'
        +days+'d '+hours+'h '+mins+'m'
        +'</div>'
        +'<div style="font-size:11px;color:#555;margin-top:6px">'+(days===0&&hours===0?'It just happened. Get up. Use the protocol.':days===0?'Hours matter. Each one builds the next.':days<3?'Keep adding hours. Do not reset this clock.':'Every hour on this clock is a win. Protect it.')+'</div>'
        +'</div>';
    })()

    // â”€â”€ 35-DAY STREAK CALENDAR â”€â”€
    +'<div style="margin:0 16px 16px;padding:14px;background:#0d0d0d;border:1px solid #1e1e1e;border-radius:12px">'
    +'<div style="font-size:10px;letter-spacing:2px;color:#555;margin-bottom:10px;font-family:Impact,sans-serif">STREAK CALENDAR â€” LAST 35 DAYS</div>'
    +calHTML
    +'</div>'

    // â”€â”€ EMERGENCY BUTTON â”€â”€
    +'<div style="margin:0 16px 16px">'
    +'<div style="font-size:10px;letter-spacing:2px;color:#ff0055;margin-bottom:8px;font-family:Impact,sans-serif">ðŸš¨ FEELING AN URGE RIGHT NOW?</div>'
    +'<button onclick="triggerEmergency()" style="width:100%;padding:16px;background:#1a0000;border:2px solid #ff0055;border-radius:12px;color:#ff0055;font-family:Impact,sans-serif;font-size:18px;letter-spacing:2px;cursor:pointer">âš¡ EMERGENCY PROTOCOL</button>'
    +'</div>'

    // â”€â”€ LOG URGE â”€â”€
    +'<div style="margin:0 16px 16px;padding:14px;background:#0d0d0d;border:1px solid #1e1e1e;border-radius:12px">'
    +'<div style="font-size:10px;letter-spacing:2px;color:#ff6b35;margin-bottom:10px;font-family:Impact,sans-serif">ðŸ“Š LOG AN URGE â€” BUILD YOUR PATTERN DATA</div>'
    +'<div style="font-size:11px;color:#555;margin-bottom:10px">Track urges to find your weak spots and defend against them.</div>'
    +'<div style="margin-bottom:10px">'
    +'<div style="font-size:10px;color:#555;letter-spacing:1px;margin-bottom:6px">INTENSITY (1-10)</div>'
    +'<input id="urgeIntensity" type="range" min="1" max="10" value="5" style="width:100%;accent-color:#ff6b35">'
    +'<div style="display:flex;justify-content:space-between;font-size:10px;color:#444;margin-top:2px"><span>Mild</span><span>Moderate</span><span>Overwhelming</span></div>'
    +'</div>'
    +'<div style="margin-bottom:10px">'
    +'<div style="font-size:10px;color:#555;letter-spacing:1px;margin-bottom:6px">TRIGGER</div>'
    +'<div style="display:flex;flex-wrap:wrap;gap:6px">'
    +TRIGGERS.map((t,i)=>'<button onclick="selectTrigger(this)" data-val="'+t+'" style="padding:6px 10px;background:#111;border:1px solid #2a2a2a;border-radius:20px;color:#666;font-size:11px;cursor:pointer">'+t+'</button>').join('')
    +'</div></div>'
    +'<div style="margin-bottom:10px">'
    +'<div style="font-size:10px;color:#555;letter-spacing:1px;margin-bottom:6px">I WILL REDIRECT TO</div>'
    +'<div style="display:flex;flex-wrap:wrap;gap:6px">'
    +REDIRECT_ACTIONS.map((r,i)=>'<button onclick="selectRedirect(this)" data-val="'+r+'" style="padding:6px 10px;background:#111;border:1px solid #2a2a2a;border-radius:20px;color:#666;font-size:11px;cursor:pointer">'+r+'</button>').join('')
    +'</div></div>'
    +'<button onclick="logUrge(this)" data-date="'+today+'" style="width:100%;padding:12px;background:#1a0900;border:1px solid #ff6b35;border-radius:8px;color:#ff6b35;font-family:Impact,sans-serif;font-size:14px;letter-spacing:1px;cursor:pointer;margin-top:4px">LOG THIS URGE</button>'
    +'</div>'

    // â”€â”€ TODAY'S URGE LOG â”€â”€
    +'<div style="margin:0 16px 16px;padding:14px;background:#0d0d0d;border:1px solid #1e1e1e;border-radius:12px">'
    +'<div style="font-size:10px;letter-spacing:2px;color:#555;margin-bottom:10px;font-family:Impact,sans-serif">TODAY&#39;S URGE LOG</div>'
    +urgeHTML
    +'</div>'

    // â”€â”€ BP TRACKER â”€â”€
    +'<div style="margin:0 16px 16px;padding:14px;background:#0d0d0d;border:1px solid #1e1e1e;border-radius:12px">'
    +'<div style="font-size:10px;letter-spacing:2px;color:#6699ff;margin-bottom:10px;font-family:Impact,sans-serif">â¤ï¸ BLOOD PRESSURE LOG</div>'
    +'<div style="display:flex;gap:8px;margin-bottom:10px">'
    +'<input id="bpSys" type="number" inputmode="numeric" placeholder="Systolic" style="flex:1;background:#0a0a0a;border:1px solid #2a2a2a;border-radius:8px;padding:10px;color:#f0f0f0;font-size:15px;outline:none">'
    +'<div style="display:flex;align-items:center;color:#444;font-size:20px">/</div>'
    +'<input id="bpDia" type="number" inputmode="numeric" placeholder="Diastolic" style="flex:1;background:#0a0a0a;border:1px solid #2a2a2a;border-radius:8px;padding:10px;color:#f0f0f0;font-size:15px;outline:none">'
    +'</div>'
    +'<button onclick="logBP(this)" data-date="'+today+'" style="width:100%;padding:10px;background:#0d0d1a;border:1px solid #6699ff;border-radius:8px;color:#6699ff;font-family:Impact,sans-serif;font-size:13px;letter-spacing:1px;cursor:pointer;margin-bottom:10px">LOG READING</button>'
    +'<div style="font-size:10px;color:#333;margin-bottom:8px">Normal: below 120/80 Â· Elevated: 120-129 Â· High: 130+ Â· Goal: get these numbers dropping week by week</div>'
    +bpHTML
    +'</div>'

    // â”€â”€ SLEEP TRACKER â”€â”€
    +'<div style="margin:0 16px 16px;padding:14px;background:#0d0d0d;border:1px solid #1e1e1e;border-radius:12px">'
    +'<div style="font-size:10px;letter-spacing:2px;color:#8866ff;margin-bottom:10px;font-family:Impact,sans-serif">ðŸ˜´ SLEEP LOG</div>'
    +'<div style="margin-bottom:10px">'
    +'<div style="font-size:10px;color:#555;letter-spacing:1px;margin-bottom:6px">HOURS SLEPT</div>'
    +'<input id="sleepHours" type="number" inputmode="decimal" placeholder="7.5" min="0" max="24" step="0.5" style="width:100%;background:#0a0a0a;border:1px solid #2a2a2a;border-radius:8px;padding:10px;color:#f0f0f0;font-size:18px;outline:none;text-align:center">'
    +'</div>'
    +'<div style="margin-bottom:10px">'
    +'<div style="font-size:10px;color:#555;letter-spacing:1px;margin-bottom:6px">SLEEP QUALITY</div>'
    +'<div style="display:flex;gap:6px">'
    +[1,2,3,4,5].map(n=>'<button onclick="selectSleepQuality(this,'+n+')" data-val="'+n+'" style="flex:1;padding:8px;background:#111;border:1px solid #2a2a2a;border-radius:8px;color:#666;font-size:16px;cursor:pointer">'+n+'â˜…</button>').join('')
    +'</div></div>'
    +'<button onclick="logSleep(this)" data-date="'+today+'" style="width:100%;padding:10px;background:#0d0a1a;border:1px solid #8866ff;border-radius:8px;color:#8866ff;font-family:Impact,sans-serif;font-size:13px;letter-spacing:1px;cursor:pointer;margin-bottom:10px">LOG SLEEP</button>'
    +sleepHTML
    +'</div>'

    +'</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RECOVERY HANDLERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function triggerEmergency(){
  const overlay=document.createElement('div');
  overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,0.97);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;overflow-y:auto';
  let step=0;
  const steps=[
    {t:'STOP.', d:'Do not move. Do not touch your phone except to read this.', btn:'I STOPPED. NEXT.', color:'#ff0055'},
    {t:'STAND UP.', d:'Right now. Get vertical. Gravity changes your blood flow and your mindset.', btn:'I AM STANDING. NEXT.', color:'#ff6b35'},
    {t:'DRINK WATER.', d:'Go to the kitchen. Fill a glass. Drink the whole thing. This breaks the trance state.', btn:'WATER DONE. NEXT.', color:'#ff6b35'},
    {t:'20 PUSHUPS NOW.', d:'Drop and do them. Your body cannot be aroused and working out at the same time. Use this.', btn:'PUSHUPS DONE. NEXT.', color:'#ffcc00'},
    {t:'GO OUTSIDE.', d:'Walk out the door. Fresh air. Natural light. Even 2 minutes resets your nervous system.', btn:'I WENT OUTSIDE. NEXT.', color:'#00ff88'},
    {t:'YOU MADE IT.', d:'The urge has passed. It always passes. You are stronger than it. Log it, learn from it, move on.', btn:'PROTOCOL COMPLETE ðŸ’ª', color:'#00ff88'},
  ];
  function showStep(){
    const s=steps[step];
    overlay.innerHTML='<div style="background:#111;border:2px solid '+s.color+';border-radius:16px;padding:28px 24px;max-width:340px;text-align:center;width:100%">'
      +'<div style="font-size:11px;letter-spacing:3px;color:#555;margin-bottom:12px">EMERGENCY PROTOCOL Â· STEP '+(step+1)+' OF '+steps.length+'</div>'
      +'<div style="display:flex;gap:4px;margin-bottom:20px">'
      +steps.map((_,i)=>'<div style="flex:1;height:3px;border-radius:2px;background:'+(i<=step?s.color:'#222')+'"></div>').join('')
      +'</div>'
      +'<div style="font-size:36px;font-family:Impact,sans-serif;letter-spacing:2px;color:'+s.color+';margin-bottom:12px">'+s.t+'</div>'
      +'<div style="font-size:14px;color:#ccc;line-height:1.7;margin-bottom:24px">'+s.d+'</div>'
      +'<button id="emergBtn" style="width:100%;padding:14px;background:'+s.color+';border:none;border-radius:10px;color:#000;font-family:Impact,sans-serif;font-size:15px;letter-spacing:1px;cursor:pointer">'+s.btn+'</button>'
      +'</div>';
    document.body.appendChild(overlay);
    setTimeout(()=>{
      const btn=document.getElementById('emergBtn');
      if(btn) btn.onclick=()=>{
        step++;
        overlay.remove();
        if(step<steps.length) showStep();
        else render();
      };
    },50);
  }
  showStep();
}

function selectTrigger(el){
  document.querySelectorAll('[data-val]').forEach(b=>{
    if(TRIGGERS.includes(b.dataset.val)) { b.style.background='#111'; b.style.color='#666'; b.style.borderColor='#2a2a2a'; }
  });
  el.style.background='#1a0900'; el.style.color='#ff6b35'; el.style.borderColor='#ff6b35';
  el._selected=true;
}
function selectRedirect(el){
  document.querySelectorAll('[data-val]').forEach(b=>{
    if(REDIRECT_ACTIONS.includes(b.dataset.val)) { b.style.background='#111'; b.style.color='#666'; b.style.borderColor='#2a2a2a'; }
  });
  el.style.background='#001a09'; el.style.color='#00ff88'; el.style.borderColor='#00ff88';
}
function selectSleepQuality(el,val){
  document.querySelectorAll('[data-val]').forEach(b=>{
    if([1,2,3,4,5].includes(parseInt(b.dataset.val))) { b.style.background='#111'; b.style.color='#666'; b.style.borderColor='#2a2a2a'; }
  });
  el.style.background='#0d0a1a'; el.style.color='#8866ff'; el.style.borderColor='#8866ff';
}

function logUrge(el){
  const date=el?el.dataset.date:UI.activeDate;
  const intensity=parseInt(document.getElementById('urgeIntensity').value);
  const triggerEl=document.querySelector('[data-val][style*="ff6b35"]');
  const redirectEl=document.querySelector('[data-val][style*="00ff88"]');
  const trigger=triggerEl?triggerEl.dataset.val:'Unknown';
  const redirect=redirectEl?redirectEl.dataset.val:'Not selected';
  const now=new Date();
  const time=now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0');
  const dd=getDD(date);
  if(!dd.urges) dd.urges=[];
  dd.urges.push({time,intensity,trigger,redirect});
  saveDB(); render();
}
function deleteUrge(idx){
  const dd=getDD(UI.activeDate);
  if(dd.urges) dd.urges.splice(idx,1);
  saveDB(); render();
}
function logBP(el){
  const date=el?el.dataset.date:UI.activeDate;
  const sys=document.getElementById('bpSys').value;
  const dia=document.getElementById('bpDia').value;
  if(!sys||!dia) return;
  const now=new Date();
  const time=now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0');
  const dd=getDD(date);
  if(!dd.bp) dd.bp={};
  dd.bp[time]=sys+'/'+dia;
  saveDB(); render();
}
function logSleep(el){
  const date=el?el.dataset.date:UI.activeDate;
  const hours=parseFloat(document.getElementById('sleepHours').value);
  const qualityEl=document.querySelector('[data-val][style*="8866ff"]');
  const quality=qualityEl?parseInt(qualityEl.dataset.val):3;
  if(!hours) return;
  const dd=getDD(date);
  dd.sleep={hours,quality};
  saveDB(); render();
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEEKLY SUMMARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderWeeklySummary(today){
  // Get the Monday of the current week containing today
  const todayD = new Date(today+'T12:00:00');
  const dow = todayD.getDay(); // 0=sun
  const mondayOffset = dow===0 ? -6 : -(dow-1);
  const monday = new Date(todayD);
  monday.setDate(monday.getDate()+mondayOffset);

  // Build array of the 7 days Mon-Sun
  const weekDays=[];
  for(let i=0;i<7;i++){
    const d=new Date(monday);
    d.setDate(d.getDate()+i);
    weekDays.push(d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0'));
  }

  const weekLabel = 'Week of '+['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][monday.getMonth()]+' '+monday.getDate();

  // â”€â”€ WORKOUT SCORE â”€â”€
  // Training days are Mon(0) Tue(1) Wed(2) Thu(3) â€” skip Fri Sat Sun for compound score
  let workoutScore=0, workoutDone=0, workoutTotal=4;
  // phase replaced by FIGHTERS equipment system
  [0,1,2,3].forEach((dayIdx,wi)=>{
    const ds=weekDays[wi];
    const dayData=DB.days&&DB.days[ds];
    if(!dayData) return;
    // Check any equipment setup
    let bestDone=0, bestTotal=10;
    ['gym','bowflex','bands','bodyweight'].forEach(function(ek){
      const exs=FIGHTERS[ek]&&FIGHTERS[ek].days[dayIdx]?FIGHTERS[ek].days[dayIdx].exercises:[];
      if(!exs.length) return;
      const ekKey=ek+'-'+dayIdx;
      const done=exs.filter((_,i)=>dayData.ex&&dayData.ex[ekKey+'-'+i]).length;
      if(done>bestDone){bestDone=done;bestTotal=exs.length;}
    });
    if(bestDone>=Math.floor(bestTotal*0.7)) workoutDone++;
  });
  workoutScore=Math.round(workoutDone/workoutTotal*100);

  // â”€â”€ SUPPLEMENT SCORE â”€â”€
  let suppTotal=0, suppDone=0;
  weekDays.forEach(ds=>{
    const dayData=DB.days&&DB.days[ds];
    const totalSupps=SUPPLEMENTS.length;
    suppTotal+=totalSupps;
    if(dayData&&dayData.supp) suppDone+=Object.values(dayData.supp).filter(Boolean).length;
  });
  const suppScore=suppTotal>0?Math.round(suppDone/suppTotal*100):0;

  // â”€â”€ CLEAN STREAK (as of today) â”€â”€
  const streak=calcCleanStreak(today);
  // Days clean this week
  let cleanDays=0;
  weekDays.forEach(ds=>{
    const dayData=DB.days&&DB.days[ds];
    if(dayData&&dayData.sex&&dayData.sex['porn-status']==='clean') cleanDays++;
  });

  // â”€â”€ SLEEP AVERAGE â”€â”€
  let sleepTotal=0, sleepCount=0;
  weekDays.forEach(ds=>{
    const dayData=DB.days&&DB.days[ds];
    if(dayData&&dayData.sleep&&dayData.sleep.hours){
      sleepTotal+=dayData.sleep.hours;
      sleepCount++;
    }
  });
  const sleepAvg=sleepCount>0?(sleepTotal/sleepCount).toFixed(1):null;

  // â”€â”€ BP TREND â”€â”€
  // Get all BP readings this week, compare first vs last
  const bpReadings=[];
  weekDays.forEach(ds=>{
    const dayData=DB.days&&DB.days[ds];
    if(dayData&&dayData.bp){
      Object.entries(dayData.bp).forEach(([time,val])=>{
        const[sys]=val.split('/').map(Number);
        bpReadings.push({ds,time,sys,val});
      });
    }
  });
  let bpTrend=null, bpTrendColor='#888', bpTrendIcon='â†’';
  if(bpReadings.length>=2){
    const first=bpReadings[0].sys;
    const last=bpReadings[bpReadings.length-1].sys;
    const diff=last-first;
    if(diff<=-3){bpTrend='Down '+Math.abs(diff)+' pts';bpTrendColor='#00ff88';bpTrendIcon='â†“';}
    else if(diff>=3){bpTrend='Up '+diff+' pts';bpTrendColor='#ff0055';bpTrendIcon='â†‘';}
    else{bpTrend='Stable';bpTrendColor='#ffcc00';bpTrendIcon='â†’';}
  }

  // â”€â”€ HABITS SCORE â”€â”€
  let habitsTotal=0, habitsDone=0;
  weekDays.forEach(ds=>{
    const dayData=DB.days&&DB.days[ds];
    habitsTotal+=HABITS.length;
    if(dayData&&dayData.habits) habitsDone+=Object.values(dayData.habits).filter(Boolean).length;
  });
  const habitsScore=habitsTotal>0?Math.round(habitsDone/habitsTotal*100):0;

  // â”€â”€ OVERALL WEEK SCORE â”€â”€
  // Weighted: workouts 35%, supplements 20%, clean days 25%, sleep 10%, habits 10%
  const cleanScore=Math.round(cleanDays/7*100);
  const sleepScore=sleepAvg?(sleepAvg>=7?100:sleepAvg>=6?70:40):50;
  const overallScore=Math.round(workoutScore*0.35+suppScore*0.20+cleanScore*0.25+sleepScore*0.10+habitsScore*0.10);
  const scoreColor=overallScore>=80?'#00ff88':overallScore>=60?'#ff6b35':'#ff0055';
  const scoreLabel=overallScore>=90?'ELITE':overallScore>=80?'STRONG':overallScore>=70?'SOLID':overallScore>=60?'BUILDING':'NEEDS WORK';

  // â”€â”€ DAY-BY-DAY BREAKDOWN â”€â”€
  const dayNames=['MON','TUE','WED','THU','FRI','SAT','SUN'];
  const dayBreakdown=weekDays.map((ds,i)=>{
    const dayData=DB.days&&DB.days[ds];
    const isToday=ds===today;
    const isFuture=ds>today;
    const isTraining=i<4;
    let dots='';
    if(!isFuture){
      // Workout dot (training days only)
      if(isTraining){
        const exs=(FIGHTERS.gym&&FIGHTERS.gym.days[i]?FIGHTERS.gym.days[i].exercises:[]);
        const done=dayData?exs.filter((_,ei)=>dayData.ex&&dayData.ex[UI.activePhase+'-'+i+'-'+ei]).length:0;
        const pct=done/exs.length;
        dots+='<span style="font-size:8px;color:'+(pct>=0.7?'#00ff88':pct>0?'#ff6b35':'#333')+'">ðŸ’ª</span>';
      }
      // Clean dot
      const pornStatus=dayData&&dayData.sex&&dayData.sex['porn-status'];
      dots+='<span style="font-size:8px;color:'+(pornStatus==='clean'?'#00ff88':pornStatus==='slipped'?'#ff0055':'#333')+'">ðŸ§ </span>';
      // Sleep dot
      const hrs=dayData&&dayData.sleep&&dayData.sleep.hours;
      dots+='<span style="font-size:8px;color:'+(hrs>=7?'#00ff88':hrs>=6?'#ff6b35':hrs?'#ff0055':'#333')+'">ðŸ˜´</span>';
    }
    return '<div style="text-align:center;flex:1">'
      +'<div style="font-size:9px;color:'+(isToday?'#ff6b35':'#444')+';margin-bottom:4px;font-family:Impact,sans-serif">'+dayNames[i]+'</div>'
      +'<div style="background:'+(isToday?'#1a0900':'#0d0d0d')+';border:1px solid '+(isToday?'#ff6b35':'#1e1e1e')+';border-radius:6px;padding:6px 2px;min-height:48px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px">'
      +(isFuture?'<span style="font-size:8px;color:#222">-</span>':dots)
      +'</div></div>';
  }).join('');

  // â”€â”€ GRADE MESSAGE â”€â”€
  const gradeMessages={
    ELITE: 'LOCKED THE FUCK IN. This is what it looks like when you stop making excuses and actually commit. This is who you are when you are not being a lazy bitch. Keep it.',
    STRONG: 'Strong week. Good. But you still left points on the table and you know exactly where. Do not come back next week with the same gaps.',
    SOLID: 'Solid is a bitch word. Solid means you did enough to not feel guilty but not enough to actually change. Stop settling for solid.',
    BUILDING: 'Building is what you call it when you are too scared to fully commit. You skipped things, made excuses, and told yourself it is fine. It is not fine. Stop being a little bitch about hard days.',
    'NEEDS WORK': 'This score is embarrassing and you know it. You have the full program, the supplements, the system, God in your corner â€” and you still could not execute. Stop lying to yourself about wanting to change and actually change.',
  };

  return '<div style="padding:14px 0">'

    // â”€â”€ WEEK SCORE HERO â”€â”€
    +'<div style="margin:0 16px 16px;padding:24px 20px;background:linear-gradient(135deg,#0a0a0a,#111);border:2px solid '+scoreColor+';border-radius:14px;text-align:center">'
    +'<div style="font-size:11px;letter-spacing:3px;color:#555;margin-bottom:4px;font-family:Impact,sans-serif">'+weekLabel.toUpperCase()+'</div>'
    +'<div style="font-size:80px;font-family:Impact,sans-serif;color:'+scoreColor+';line-height:1">'+overallScore+'</div>'
    +'<div style="font-size:20px;font-family:Impact,sans-serif;letter-spacing:3px;color:'+scoreColor+';margin-bottom:10px">'+scoreLabel+'</div>'
    +'<div style="font-size:12px;color:#666;line-height:1.6;font-style:italic">'+gradeMessages[scoreLabel]+'</div>'
    +(overallScore<60?'<div style="font-size:11px;color:#ff0055;margin-top:10px;padding-top:10px;border-top:1px solid #1a0000;font-family:Impact,sans-serif;letter-spacing:1px">STOP BEING A BITCH. YOU ARE BETTER THAN THIS SCORE.</div>':'')
    +'</div>'

    // â”€â”€ DAY BY DAY â”€â”€
    +'<div style="margin:0 16px 16px;padding:14px;background:#0d0d0d;border:1px solid #1e1e1e;border-radius:12px">'
    +'<div style="font-size:10px;letter-spacing:2px;color:#555;margin-bottom:10px;font-family:Impact,sans-serif">DAY BY DAY</div>'
    +'<div style="display:flex;gap:4px">'+dayBreakdown+'</div>'
    +'<div style="display:flex;gap:12px;margin-top:8px;font-size:10px;color:#555">'
    +'<span>ðŸ’ª Workout</span><span>ðŸ§  Clean</span><span>ðŸ˜´ Sleep 7h+</span>'
    +'</div></div>'

    // â”€â”€ STAT CARDS â”€â”€
    +'<div style="margin:0 16px 16px;display:grid;grid-template-columns:1fr 1fr;gap:10px">'

    +'<div style="padding:14px;background:#0d0d0d;border:1px solid #1e1e1e;border-radius:12px;text-align:center">'
    +'<div style="font-size:9px;letter-spacing:2px;color:#555;margin-bottom:6px;font-family:Impact,sans-serif">WORKOUTS</div>'
    +'<div style="font-size:32px;font-family:Impact,sans-serif;color:'+(workoutScore>=75?'#00ff88':workoutScore>=50?'#ff6b35':'#ff0055')+'">'+workoutDone+'/'+workoutTotal+'</div>'
    +'<div style="font-size:10px;color:#444;margin-top:2px">sessions completed</div>'
    +'</div>'

    +'<div style="padding:14px;background:#0d0d0d;border:1px solid #1e1e1e;border-radius:12px;text-align:center">'
    +'<div style="font-size:9px;letter-spacing:2px;color:#555;margin-bottom:6px;font-family:Impact,sans-serif">CLEAN DAYS</div>'
    +'<div style="font-size:32px;font-family:Impact,sans-serif;color:'+(cleanDays>=6?'#00ff88':cleanDays>=4?'#ff6b35':'#ff0055')+'">'+cleanDays+'/7</div>'
    +'<div style="font-size:10px;color:#444;margin-top:2px">'+streak+' day total streak</div>'
    +'</div>'

    +'<div style="padding:14px;background:#0d0d0d;border:1px solid #1e1e1e;border-radius:12px;text-align:center">'
    +'<div style="font-size:9px;letter-spacing:2px;color:#555;margin-bottom:6px;font-family:Impact,sans-serif">SUPPLEMENTS</div>'
    +'<div style="font-size:32px;font-family:Impact,sans-serif;color:'+(suppScore>=80?'#00ff88':suppScore>=60?'#ff6b35':'#ff0055')+'">'+suppScore+'%</div>'
    +'<div style="font-size:10px;color:#444;margin-top:2px">compliance rate</div>'
    +'</div>'

    +'<div style="padding:14px;background:#0d0d0d;border:1px solid #1e1e1e;border-radius:12px;text-align:center">'
    +'<div style="font-size:9px;letter-spacing:2px;color:#555;margin-bottom:6px;font-family:Impact,sans-serif">AVG SLEEP</div>'
    +'<div style="font-size:32px;font-family:Impact,sans-serif;color:'+(sleepAvg>=7?'#00ff88':sleepAvg>=6?'#ff6b35':sleepAvg?'#ff0055':'#444')+'">'+(sleepAvg?sleepAvg+'h':'--')+'</div>'
    +'<div style="font-size:10px;color:#444;margin-top:2px">target: 8h</div>'
    +'</div>'

    +'</div>'

    // â”€â”€ BP TREND â”€â”€
    +(bpReadings.length>0?
      '<div style="margin:0 16px 16px;padding:14px;background:#0d0d0d;border:1px solid #1e1e1e;border-radius:12px;display:flex;justify-content:space-between;align-items:center">'
      +'<div>'
      +'<div style="font-size:9px;letter-spacing:2px;color:#555;margin-bottom:4px;font-family:Impact,sans-serif">BLOOD PRESSURE TREND</div>'
      +'<div style="font-size:13px;color:'+bpTrendColor+'">'+bpTrendIcon+' '+bpTrend+'</div>'
      +'<div style="font-size:11px;color:#444;margin-top:2px">'+bpReadings.length+' reading'+(bpReadings.length===1?'':'s')+' this week</div>'
      +'</div>'
      +'<div style="font-size:40px">â¤ï¸</div>'
      +'</div>'
    :'')

    // â”€â”€ NEXT WEEK FOCUS â”€â”€
    +'<div style="margin:0 16px 16px;padding:14px;background:#0d0d1a;border:1px solid #1e1e2e;border-radius:12px">'
    +'<div style="font-size:10px;letter-spacing:2px;color:#6699ff;margin-bottom:10px;font-family:Impact,sans-serif">FOCUS FOR NEXT WEEK</div>'
    +(workoutScore<75?'<div style="font-size:12px;color:#ccc;padding:4px 0;border-bottom:1px solid #1a1a2a">ðŸ’ª Hit all 4 training sessions â€” no skips</div>':'')
    +(cleanDays<5?'<div style="font-size:12px;color:#ccc;padding:4px 0;border-bottom:1px solid #1a1a2a">ðŸ§  Stay clean every day â€” use the emergency protocol</div>':'')
    +(suppScore<70?'<div style="font-size:12px;color:#ccc;padding:4px 0;border-bottom:1px solid #1a1a2a">ðŸ’Š Pack your pouches Sunday â€” supplements need to be visible</div>':'')
    +(!sleepAvg||sleepAvg<7?'<div style="font-size:12px;color:#ccc;padding:4px 0;border-bottom:1px solid #1a1a2a">ðŸ˜´ In bed by 11pm â€” testosterone is built during sleep</div>':'')
    +(workoutScore>=75&&cleanDays>=5&&suppScore>=70&&sleepAvg>=7?'<div style="font-size:13px;color:#00ff88;padding:4px 0">Everything is dialed. Raise the weights this week. Time to push harder.</div>':'')
    +'</div>'

    +'</div>'
    +'<div style="margin:0 16px 24px">'
    +'<div style="font-size:10px;letter-spacing:2px;color:#555;margin-bottom:10px;font-family:Impact,sans-serif">ðŸ“… CALENDAR</div>'
    +renderCalendar()
    +'</div>'
    +'</div>';
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EVENT HANDLERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderJournal(today, dd){
  // Load today's journal data
  const morning = dd.morning || {};
  const todos = morning.todos || [];
  const g1 = morning.g1 || '';
  const g2 = morning.g2 || '';
  const g3 = morning.g3 || '';
  const freeEntry = morning.freeEntry || '';

  // Build todo HTML
  function todoHTML(){
    if(!todos.length) return '<div style="font-size:12px;color:#333;padding:8px 0">No tasks yet. Add what you need to get done today.</div>';
    return todos.map(function(t,i){
      return '<div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:'+(t.done?'#0a0a0a':'#111')+';border:1px solid '+(t.done?'#1a1a1a':'#2a2a2a')+';border-radius:8px;margin-bottom:6px">'
        +'<div onclick="journalToggleTodo('+i+')" style="width:22px;height:22px;border-radius:5px;border:2px solid '+(t.done?'#6699ff':'#444')+';background:'+(t.done?'#6699ff':'transparent')+';flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center">'
        +(t.done?'<span style="color:#000;font-size:13px;font-weight:bold">âœ“</span>':'')
        +'</div>'
        +'<span style="font-size:13px;color:'+(t.done?'#333':'#ccc')+';flex:1">'+(t.done?'<s>'+t.text+'</s>':t.text)+'</span>'
        +'<button onclick="journalDeleteTodo('+i+')" style="background:none;border:none;color:#333;font-size:18px;cursor:pointer;padding:2px 6px">Ã—</button>'
        +'</div>';
    }).join('');
  }

  return '<div style="padding:14px 0">'

    // â”€â”€ GRATITUDE â”€â”€
    +'<div style="margin:0 16px 16px;padding:16px;background:#0d0d0d;border:1px solid #1e1e1e;border-radius:12px">'
    +'<div style="font-size:10px;letter-spacing:2px;color:#ffcc00;margin-bottom:4px;font-family:Impact,sans-serif">ðŸ™ GRATITUDE JOURNAL</div>'
    +'<div style="font-size:11px;color:#444;margin-bottom:12px">What you are grateful for today. Write 3 things â€” big or small. Psalm 23.</div>'
    +'<textarea id="j_g1" onblur="saveJournalEntry()" placeholder="I am grateful for..." style="width:100%;background:#111;border:1px solid #2a2a2a;border-radius:8px;padding:10px;color:#ccc;font-size:13px;resize:none;height:44px;box-sizing:border-box;margin-bottom:8px;outline:none;font-family:inherit">'+g1+'</textarea>'
    +'<textarea id="j_g2" onblur="saveJournalEntry()" placeholder="I am grateful for..." style="width:100%;background:#111;border:1px solid #2a2a2a;border-radius:8px;padding:10px;color:#ccc;font-size:13px;resize:none;height:44px;box-sizing:border-box;margin-bottom:8px;outline:none;font-family:inherit">'+g2+'</textarea>'
    +'<textarea id="j_g3" onblur="saveJournalEntry()" placeholder="I am grateful for..." style="width:100%;background:#111;border:1px solid #2a2a2a;border-radius:8px;padding:10px;color:#ccc;font-size:13px;resize:none;height:44px;box-sizing:border-box;outline:none;font-family:inherit">'+g3+'</textarea>'
    +'</div>'

    // â”€â”€ TO DO LIST â”€â”€
    +'<div style="margin:0 16px 16px;padding:16px;background:#0d0d0d;border:1px solid #1e1e1e;border-radius:12px">'
    +'<div style="font-size:10px;letter-spacing:2px;color:#6699ff;margin-bottom:4px;font-family:Impact,sans-serif">ðŸ“‹ TO-DO LIST</div>'
    +'<div style="font-size:11px;color:#444;margin-bottom:12px">What actually needs to get done today. Be real with yourself.</div>'
    +'<div id="journalTodos"></div>'
    +'<div style="display:flex;gap:8px;margin-top:8px">'
    +'<input id="journalTodoInput" placeholder="Add a task..." style="flex:1;background:#111;border:1px solid #2a2a2a;border-radius:8px;padding:10px 12px;color:#ccc;font-size:13px;outline:none;font-family:inherit">'
    +'<button onclick="addJournalTodo()" style="padding:10px 16px;background:#6699ff;border:none;border-radius:8px;color:#000;font-family:Impact,sans-serif;font-size:12px;letter-spacing:1px;cursor:pointer">ADD</button>'
    +'</div>'
    +'</div>'

    // â”€â”€ FREE WRITE â”€â”€
    +'<div style="margin:0 16px 16px;padding:16px;background:#0d0d0d;border:1px solid #1e1e1e;border-radius:12px">'
    +'<div style="font-size:10px;letter-spacing:2px;color:#00ff88;margin-bottom:4px;font-family:Impact,sans-serif">âœï¸ DAILY NOTES</div>'
    +'<div style="font-size:11px;color:#444;margin-bottom:12px">Thoughts, wins, reflections, what is on your mind. No rules.</div>'
    +'<textarea id="j_free" onblur="saveJournalEntry()" placeholder="Write anything..." style="width:100%;background:#111;border:1px solid #2a2a2a;border-radius:8px;padding:10px;color:#ccc;font-size:13px;resize:none;height:120px;box-sizing:border-box;outline:none;font-family:inherit">'+freeEntry+'</textarea>'
    +'</div>'

    // â”€â”€ PAST ENTRIES STRIP â”€â”€
    +'<div style="margin:0 16px 16px;padding:16px;background:#0d0d0d;border:1px solid #1e1e1e;border-radius:12px">'
    +'<div style="font-size:10px;letter-spacing:2px;color:#555;margin-bottom:10px;font-family:Impact,sans-serif">ðŸ“… RECENT ENTRIES</div>'
    +(function(){
      let html='';
      const todayD=new Date(today+'T12:00:00');
      for(let i=1;i<=7;i++){
        const dt=new Date(todayD); dt.setDate(dt.getDate()-i);
        const ds=dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0')+'-'+String(dt.getDate()).padStart(2,'0');
        const pd=DB.days&&DB.days[ds]&&DB.days[ds].morning;
        if(!pd) continue;
        const hasContent=(pd.g1||pd.g2||pd.g3||pd.freeEntry||(pd.todos&&pd.todos.length));
        if(!hasContent) continue;
        html+='<div style="padding:10px 0;border-bottom:1px solid #1a1a1a">'
          +'<div style="font-size:10px;color:#555;letter-spacing:1px;margin-bottom:4px">'+ds+'</div>';
        if(pd.g1) html+='<div style="font-size:12px;color:#666;line-height:1.5">ðŸ™ '+pd.g1+'</div>';
        if(pd.g2) html+='<div style="font-size:12px;color:#666;line-height:1.5">ðŸ™ '+pd.g2+'</div>';
        if(pd.g3) html+='<div style="font-size:12px;color:#666;line-height:1.5">ðŸ™ '+pd.g3+'</div>';
        if(pd.freeEntry) html+='<div style="font-size:12px;color:#555;margin-top:4px;font-style:italic">'+pd.freeEntry.substring(0,120)+(pd.freeEntry.length>120?'...':'')+'</div>';
        html+='</div>';
      }
      return html||'<div style="font-size:12px;color:#333">No past entries yet. Start journaling today.</div>';
    })()
    +'</div>'

    +'</div>';
}

window.refreshJournalTodos = function(){
  const container = document.getElementById('journalTodos');
  if(!container) return;
  const today = todayStr();
  const dd = getDD(today);
  const todos = (dd.morning&&dd.morning.todos)||[];
  if(!todos.length){ container.innerHTML='<div style="font-size:12px;color:#333;padding:8px 0">No tasks yet. Add what you need to get done today.</div>'; return; }
  // Bind enter key on input
  setTimeout(function(){
    var inp = document.getElementById('journalTodoInput');
    if(inp) inp.onkeydown = function(e){ if(e.key==='Enter') window.addJournalTodo(); };
  }, 30);
  container.innerHTML = todos.map(function(t,i){
    return '<div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:'+(t.done?'#0a0a0a':'#111')+';border:1px solid '+(t.done?'#1a1a1a':'#2a2a2a')+';border-radius:8px;margin-bottom:6px">'
      +'<div onclick="journalToggleTodo('+i+')" style="width:22px;height:22px;border-radius:5px;border:2px solid '+(t.done?'#6699ff':'#444')+';background:'+(t.done?'#6699ff':'transparent')+';flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center">'
      +(t.done?'<span style="color:#000;font-size:13px;font-weight:bold">&#10003;</span>':'')
      +'</div>'
      +'<span style="font-size:13px;color:'+(t.done?'#333':'#ccc')+';flex:1">'+(t.done?'<s>'+t.text+'</s>':t.text)+'</span>'
      +'<button onclick="journalDeleteTodo('+i+')" style="background:none;border:none;color:#333;font-size:18px;cursor:pointer;padding:2px 6px">&times;</button>'
      +'</div>';
  }).join('');
};

window.saveJournalEntry = function(){
  const today = todayStr();
  const dd = getDD(today);
  if(!dd.morning) dd.morning={};
  const g1el=document.getElementById('j_g1');
  const g2el=document.getElementById('j_g2');
  const g3el=document.getElementById('j_g3');
  const freel=document.getElementById('j_free');
  if(g1el) dd.morning.g1=g1el.value;
  if(g2el) dd.morning.g2=g2el.value;
  if(g3el) dd.morning.g3=g3el.value;
  if(freel) dd.morning.freeEntry=freel.value;
  saveDB();
};

window.addJournalTodo = function(){
  const input=document.getElementById('journalTodoInput');
  if(!input||!input.value.trim()) return;
  const today=todayStr();
  const dd=getDD(today);
  if(!dd.morning) dd.morning={};
  if(!dd.morning.todos) dd.morning.todos=[];
  dd.morning.todos.push({text:input.value.trim(),done:false});
  saveDB();
  input.value='';
  window.refreshJournalTodos();
};

window.journalToggleTodo = function(idx){
  const today=todayStr();
  const dd=getDD(today);
  if(dd.morning&&dd.morning.todos&&dd.morning.todos[idx]){
    dd.morning.todos[idx].done=!dd.morning.todos[idx].done;
    saveDB(); window.refreshJournalTodos();
  }
};

window.journalDeleteTodo = function(idx){
  const today=todayStr();
  const dd=getDD(today);
  if(dd.morning&&dd.morning.todos){
    dd.morning.todos.splice(idx,1);
    saveDB(); window.refreshJournalTodos();
  }
};

function toggleDyslexia(){
  const body=document.body;
  const isOn=body.classList.toggle('dyslexia-mode');
  DB.dyslexiaMode=isOn;
  saveDB();
  const btn=document.getElementById('dyslexBtn');
  if(btn){btn.style.color=isOn?'#00ff88':'#6699ff';btn.style.borderColor=isOn?'#00ff88':'#2a2a2a';}
}

function selectEquip(k){
  UI.activeEquip=k;
  if(k) { DB.lastEquip=k; saveDB(); }
  render();
}

function setMinEx(n){DB.minExercises=n;saveDB();render();}

function switchTab(t){
  UI.activeTab=t;
  render();
  if(t==='journal') setTimeout(function(){
    window.refreshJournalTodos();
    var inp = document.getElementById('journalTodoInput');
    if(inp) inp.onkeydown = function(e){ if(e.key==='Enter') window.addJournalTodo(); };
  }, 50);
}
function shiftDate(dir){
  const d=new Date(UI.activeDate+'T12:00:00');
  d.setDate(d.getDate()+dir);
  const newDate=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  // Don't go into the future
  if(newDate>todayStr()) return;
  UI.activeDate=newDate;
  // Auto-switch day tab to match the date's day of week
  UI.activeDay=getDowStr(newDate);
  render();
}
function goToToday(){
  UI.activeDate=todayStr();
  UI.activeDay=todayDow();
  render();
}
function toggleWarmup(date,key){
  const dd=getDD(UI.activeDate);
  // reuse w dict for warmup/cooldown/post-workout booleans
  dd.w[key]=!dd.w[key];
  saveDB();render();
}
function switchPhase(i){UI.activePhase=i;DB.activePhase=i;saveDB();render();}
function switchDay(d){UI.activeDay=d;DB.activeDay=d;saveDB();render();}

function toggleEx(key,type){
  const dd=getDD(UI.activeDate);
  dd.ex[key]=!dd.ex[key];
  saveDB();render();
}
function toggleBF(key){
  const dd=getDD(UI.activeDate);
  dd.bf[key]=!dd.bf[key];
  saveDB();render();
}
function toggleRec(date,key){
  const dd=getDD(date);
  dd.rec[key]=!dd.rec[key];
  saveDB();render();
}
function toggleSupp(date,idx){
  const dd=getDD(date);
  dd.supp[idx]=!dd.supp[idx];
  saveDB();render();
}
function deleteSlipEvent(idx, date){
  const dd=getDD(date);
  if(dd.sex&&dd.sex['porn-events']) dd.sex['porn-events'].splice(idx,1);
  saveDB(); render();
}

function logPorn(el){
  const date=el.dataset.date;
  const status=el.dataset.status;
  const dd=getDD(date);
  if(!dd.sex) dd.sex={};
  if(!dd.sex['porn-events']) dd.sex['porn-events']=[];

  const now=new Date();
  const time=now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0');

  // Add event to array â€” can log multiple times per day
  dd.sex['porn-events'].push({time, type:status});

  // Keep backward compat â€” set porn-status based on whether any slip exists
  const hasSlip=dd.sex['porn-events'].some(e=>e.type==='slipped');
  dd.sex['porn-status']=hasSlip?'slipped':'clean';

  // If slip â€” record exact timestamp for the clock
  if(status==='slipped'){
    dd.sex['lastSlipTimestamp']=Date.now();
    // Also update global last slip for the clock
    if(!DB.lastSlip||Date.now()>=(DB.lastSlip||0)) DB.lastSlip=Date.now();
  }

  saveDB();

  // Calculate streak
  let streak=0;
  const todayD=new Date(date+'T12:00:00');
  for(let d=0;d<365;d++){
    const dt=new Date(todayD);
    dt.setDate(dt.getDate()-d);
    const ds=dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0')+'-'+String(dt.getDate()).padStart(2,'0');
    const dayData=DB.days&&DB.days[ds];
    const dayEvents=(dayData&&dayData.sex&&dayData.sex['porn-events'])||[];
    const daySlipped=dayEvents.some(e=>e.type==='slipped')||(dayData&&dayData.sex&&dayData.sex['porn-status']==='slipped');
    const dayClean=dayEvents.some(e=>e.type==='clean')||(dayData&&dayData.sex&&dayData.sex['porn-status']==='clean');
    if(d===0){if(!daySlipped)streak=1;continue;}
    if(daySlipped) break;
    if(dayClean) streak++;
    else break;
  }

  const overlay=document.createElement('div');
  overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,0.92);z-index:999;display:flex;align-items:center;justify-content:center;padding:20px';

  if(status==='slipped'){
    overlay.innerHTML=''
      +'<div style="background:#111;border:2px solid #ff0055;border-radius:16px;padding:28px 24px;max-width:340px;text-align:center">'
      +'<div style="font-size:48px;margin-bottom:12px">ðŸ¤¦</div>'
      +'<div style="font-family:Impact,sans-serif;font-size:26px;letter-spacing:2px;color:#ff0055;margin-bottom:12px">SERIOUSLY?</div>'
      +'<div style="font-size:14px;color:#ccc;line-height:1.6;margin-bottom:8px">You threw away your streak for a screen. You have a covenant, an emergency protocol, a whole system built to stop this exact moment â€” and you still chose to be weak. That is on you. Nobody else.</div>'
      +'<div style="font-size:13px;color:#ff6b35;line-height:1.6;margin-bottom:12px">Every single slip kills your testosterone, resets your dopamine, and makes real intimacy feel less real. You are literally making yourself worse on purpose. That stops today.</div>'
      +'<div style="font-size:14px;color:#ff6b35;font-family:Impact,sans-serif;letter-spacing:1px;margin-bottom:20px">STREAK RESETS. GET UP. DO 20 PUSHUPS RIGHT NOW BEFORE YOU CLOSE THIS.</div>'
      +'<button id="pornOverlayBtn" style="width:100%;padding:14px;background:#ff0055;border:none;border-radius:10px;color:#fff;font-family:Impact,sans-serif;font-size:16px;letter-spacing:2px;cursor:pointer">'
      +'PUSHUPS DONE. MOVING ON.'
      +'</button>'
      +'</div>';
  } else {
    const msgs=[
      [1,'Day 1 logged. Good. Now do Day 2. Do not celebrate yet.'],
      [3,'3 days. Your dopamine is starting to recalibrate. She is becoming more real to you already.'],
      [7,'One week clean. Testosterone is measurably higher. Dopamine receptors are healing. Keep going.'],
      [14,'Two weeks. Most men quit before this point. You did not. That matters.'],
      [30,'30 DAYS. You are in territory most men never reach. Do not go back.'],
      [60,'60 days. Your brain chemistry has genuinely changed. You are not the same man who started.'],
      [90,'90 DAYS. This is rare. You have built something real. Protect it. ðŸ‘‘'],
    ];
    let msg=msgs[0][1];
    for(const [days,text] of msgs){if(streak>=days)msg=text;}
    overlay.innerHTML=''
      +'<div style="background:#111;border:2px solid #00ff88;border-radius:16px;padding:28px 24px;max-width:340px;text-align:center">'
      +'<div style="font-size:48px;margin-bottom:12px">ðŸ”¥</div>'
      +'<div style="font-family:Impact,sans-serif;font-size:26px;letter-spacing:2px;color:#00ff88;margin-bottom:8px">'+streak+' DAY'+(streak===1?'':'S')+' CLEAN</div>'
      +'<div style="font-size:14px;color:#ccc;line-height:1.6;margin-bottom:20px">'+msg+'</div>'
      +'<button id="pornOverlayBtn" style="width:100%;padding:14px;background:#00ff88;border:none;border-radius:10px;color:#000;font-family:Impact,sans-serif;font-size:16px;letter-spacing:2px;cursor:pointer">'
      +'LETS GO ðŸ’ª'
      +'</button>'
      +'</div>';
  }

  document.body.appendChild(overlay);
  setTimeout(()=>{
    const btn=document.getElementById('pornOverlayBtn');
    if(btn) btn.onclick=()=>{overlay.remove();render();};
  },50);
}

function toggleSex(el){
  const date=el.dataset.date||UI.activeDate;
  const idx=parseInt(el.dataset.idx);
  const dd=getDD(date);
  dd.sex[idx]=!dd.sex[idx];
  saveDB();render();
}
function showPastSlipModal(){
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px';
  // Get today and a week ago as the date range
  const todayStr2 = todayStr();
  overlay.innerHTML = ''
    +'<div style="background:#111;border:2px solid #ff0055;border-radius:16px;padding:24px;max-width:340px;width:100%">'
    +'<div style="font-family:Impact,sans-serif;font-size:18px;letter-spacing:2px;color:#ff0055;margin-bottom:6px">LOG A PAST SLIP</div>'
    +'<div style="font-size:11px;color:#555;margin-bottom:16px;line-height:1.6">Be honest. Log every one. This is between you and God.</div>'
    +'<div style="margin-bottom:12px">'
    +'<div style="font-size:10px;color:#555;letter-spacing:1px;margin-bottom:6px">DATE</div>'
    +'<input id="pastSlipDate" type="date" max="'+todayStr2+'" value="'+todayStr2+'" style="width:100%;background:#0a0a0a;border:1px solid #2a2a2a;border-radius:8px;padding:10px;color:#f0f0f0;font-size:14px;outline:none;box-sizing:border-box">'
    +'</div>'
    +'<div style="margin-bottom:16px">'
    +'<div style="font-size:10px;color:#555;letter-spacing:1px;margin-bottom:6px">TIME (approximate is fine)</div>'
    +'<input id="pastSlipTime" type="time" value="12:00" style="width:100%;background:#0a0a0a;border:1px solid #2a2a2a;border-radius:8px;padding:10px;color:#f0f0f0;font-size:14px;outline:none;box-sizing:border-box">'
    +'</div>'
    +'<div style="display:flex;gap:10px">'
    +'<button id="pastSlipCancel" style="flex:1;padding:12px;background:none;border:1px solid #333;border-radius:8px;color:#444;font-size:12px;cursor:pointer">Cancel</button>'
    +'<button id="pastSlipConfirm" style="flex:1;padding:12px;background:#ff0055;border:none;border-radius:8px;color:#fff;font-family:Impact,sans-serif;font-size:14px;letter-spacing:1px;cursor:pointer">LOG IT</button>'
    +'</div>'
    +'</div>';
  document.body.appendChild(overlay);
  setTimeout(()=>{
    document.getElementById('pastSlipCancel').onclick = ()=>overlay.remove();
    document.getElementById('pastSlipConfirm').onclick = ()=>{
      const date = document.getElementById('pastSlipDate').value;
      const time = document.getElementById('pastSlipTime').value;
      if(!date||!time){ overlay.remove(); return; }
      const dd = getDD(date);
      if(!dd.sex) dd.sex={};
      if(!dd.sex['porn-events']) dd.sex['porn-events']=[];
      dd.sex['porn-events'].push({time, type:'slipped'});
      // Update porn-status for that day
      dd.sex['porn-status']='slipped';
      // Update global last slip timestamp if this is more recent
      const slipTs = new Date(date+'T'+time+':00').getTime();
      if(!DB.lastSlip || slipTs > DB.lastSlip) DB.lastSlip = slipTs;
      saveDB();
      overlay.remove();
      render();
    };
  },50);
}

function signCommitment(){
  const today = todayStr();
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px';
  overlay.innerHTML = ''
    +'<div style="background:#111;border:2px solid #00ff88;border-radius:16px;padding:28px 24px;max-width:340px;text-align:center">'
    +'<div style="font-size:36px;margin-bottom:12px">âœï¸</div>'
    +'<div style="font-family:Impact,sans-serif;font-size:22px;letter-spacing:2px;color:#00ff88;margin-bottom:14px">YOUR COVENANT</div>'
    +'<div style="font-size:13px;color:#ccc;line-height:1.9;font-style:italic;margin-bottom:16px">"I am committed to overcoming porn addiction. I choose discipline over impulse. I choose the man God made me to be over the man my habits made me. I will not quit."</div>'
    +'<div style="font-size:11px;color:#555;margin-bottom:20px;line-height:1.6">Yea though I walk through the valley of the shadow of death, I will fear no evil. â€” Psalm 23:4<br><br>This is your valley. Walk through it.</div>'
    +'<button id="commitBtn" style="width:100%;padding:14px;background:#00ff88;border:none;border-radius:10px;color:#000;font-family:Impact,sans-serif;font-size:15px;letter-spacing:2px;cursor:pointer;margin-bottom:10px">I COMMIT. GOD IS MY WITNESS.</button>'
    +'<button id="commitCancel" style="width:100%;padding:10px;background:none;border:1px solid #333;border-radius:10px;color:#444;font-size:12px;cursor:pointer">Not ready yet</button>'
    +'</div>';
  document.body.appendChild(overlay);
  setTimeout(()=>{
    document.getElementById('commitBtn').onclick = ()=>{
      DB.commitmentSigned = true;
      DB.commitmentDate = today;
      saveDB();
      overlay.remove();
      render();
    };
    document.getElementById('commitCancel').onclick = ()=>{ overlay.remove(); };
  },50);
}

// toggleHabit replaced by toggleHabitNew

function toggleWeight(key){UI.openEx=UI.openEx===key?null:key;render();}
function calPrev(){if(UI.calMonth===0){UI.calMonth=11;UI.calYear--;}else UI.calMonth--;render();}
function calNext(){if(UI.calMonth===11){UI.calMonth=0;UI.calYear++;}else UI.calMonth++;render();}
function openModal(ds){UI.modalDate=ds;render();}
function closeModal(){UI.modalDate=null;render();}

// Auto-set today's day on load
UI.activeDay=todayDow();

// Live clock â€” update slip clock every 60 seconds if on recovery tab
setInterval(()=>{
  if(UI.activeTab==='recovery'){
    const clock=document.getElementById('slipClock');
    if(clock&&DB.lastSlip){
      const diffMs=Date.now()-DB.lastSlip;
      const diffSecs=Math.floor(diffMs/1000);
      const days=Math.floor(diffSecs/86400);
      const hours=Math.floor((diffSecs%86400)/3600);
      const mins=Math.floor((diffSecs%3600)/60);
      const clockColor=days>=7?'#00ff88':days>=3?'#ff6b35':'#ff0055';
      const timeEl=clock.querySelector('div:nth-child(2)');
      if(timeEl){ timeEl.style.color=clockColor; timeEl.textContent=days+'d '+hours+'h '+mins+'m'; }
    }
  }
  // Bedtime check â€” fires once between 10pm and 11pm if not already shown today
  checkBedtimeAlarm();
  // Morning check â€” fires once between 6am and 9am
  checkMorningAlarm();
},60000);

function checkBedtimeAlarm(){
  const now = new Date();
  const hour = now.getHours();
  // Use date string â€” after midnight count as previous day's nag
  const nagDate = hour < 2 ? new Date(now.getTime()-86400000).toISOString().split('T')[0] : now.toISOString().split('T')[0];
  // Fire any time 10pmâ€“2am
  if(hour>=22 || hour===0 || hour===1){
    if(DB.lastBedtimeNag === nagDate) return;
    DB.lastBedtimeNag = nagDate;
    saveDB();
    showBedtimeAlarm();
  }
}

function checkMorningAlarm(){
  const now = new Date();
  const hour = now.getHours();
  const today = now.toISOString().split('T')[0];
  if(hour>=6 && hour<9){
    if(DB.lastMorningAlarm === today) return;
    DB.lastMorningAlarm = today;
    saveDB();
    showMorningAlarm();
  }
}

function showMorningAlarm(){
  const msgs = [
    "Who gives a fuck about your emails right now. Who gives a fuck about social media. None of that is about you. This morning is about you. Do not hijack it with other people's noise.",
    "Do not touch your phone for anyone else's agenda this morning. No emails. No notifications. No scrolling. The first hour belongs to you. Protect it like your life depends on it because your goals do.",
    "Every man who ever built something great protected his mornings. You are handing yours to a screen before your feet hit the floor. Stop. This morning is yours. Own it.",
    "The notifications can wait. The emails can wait. The social media will still be full of garbage in an hour. Your morning routine cannot be recovered once it is gone. Start right.",
    "You are not behind on anything that matters at 7am. Stop letting your phone convince you otherwise. Worry about yourself first. Everything else second.",
  ];
  const msg = msgs[Math.floor(Math.random()*msgs.length)];

  // Build morning supplement checklist
  const morningPack = PILL_PACKS.find(function(p){return p.id==='morning';});
  let morningOffset = 0;
  // morning is first pack so offset = 0
  const today2 = todayStr();
  const dd2 = getDD(today2);

  const MORNING_MEDS = [
    {id:'med-vyvanse', label:'Vyvanse', dose:'As prescribed Â· with water before food'},
    {id:'med-wellbutrin', label:'Wellbutrin (Bupropion)', dose:'As prescribed'},
  ];

  const MORNING_SUPPS = morningPack.items.map(function(item, i){
    return {id:'msupp-'+i, label:item.n.split('(')[0].trim().split('â€”')[0].trim(), dose:item.dose, suppIdx:i};
  });

  function buildMorningChecklist(){
    let html = '<div style="text-align:left;margin-bottom:16px">';
    html += '<div style="font-size:10px;letter-spacing:2px;color:#ff6b35;margin-bottom:8px;font-family:Impact,sans-serif">ðŸ’Š MEDS â€” TAKE THESE NOW</div>';
    MORNING_MEDS.forEach(function(m){
      const checked = dd2.habits && dd2.habits[m.id];
      html += '<div data-bid="'+m.id+'" data-btype="mmed" onclick="morningToggle(this)" style="display:flex;align-items:center;gap:10px;padding:8px 10px;background:'+(checked?'#1a0a00':'#111')+';border:1px solid '+(checked?'#ff6b35':'#2a2a2a')+';border-radius:8px;margin-bottom:6px;cursor:pointer">'
        +'<div style="width:20px;height:20px;border-radius:4px;border:2px solid '+(checked?'#ff6b35':'#444')+';background:'+(checked?'#ff6b35':'transparent')+';flex-shrink:0;display:flex;align-items:center;justify-content:center">'
        +(checked?'<span style="color:#000;font-size:12px;font-weight:bold">âœ“</span>':'')
        +'</div>'
        +'<div><div style="font-size:12px;color:'+(checked?'#ff6b35':'#ccc')+';font-family:Impact,sans-serif;letter-spacing:1px">'+m.label+'</div>'
        +'<div style="font-size:10px;color:#555">'+m.dose+'</div></div>'
        +'</div>';
    });
    html += '<div style="font-size:10px;letter-spacing:2px;color:#00ff88;margin-bottom:8px;margin-top:12px;font-family:Impact,sans-serif">ðŸŒ… MORNING SUPPLEMENTS</div>';
    MORNING_SUPPS.forEach(function(s){
      const checked = dd2.supp && dd2.supp[s.suppIdx];
      html += '<div data-bid="'+s.id+'" data-btype="msupp" data-bidx="'+s.suppIdx+'" onclick="morningToggle(this)" style="display:flex;align-items:center;gap:10px;padding:8px 10px;background:'+(checked?'#0a1a0a':'#111')+';border:1px solid '+(checked?'#00ff88':'#2a2a2a')+';border-radius:8px;margin-bottom:6px;cursor:pointer">'
        +'<div style="width:20px;height:20px;border-radius:4px;border:2px solid '+(checked?'#00ff88':'#444')+';background:'+(checked?'#00ff88':'transparent')+';flex-shrink:0;display:flex;align-items:center;justify-content:center">'
        +(checked?'<span style="color:#000;font-size:12px;font-weight:bold">âœ“</span>':'')
        +'</div>'
        +'<div><div style="font-size:12px;color:'+(checked?'#00ff88':'#ccc')+';font-family:Impact,sans-serif;letter-spacing:1px">'+s.label+'</div>'
        +'<div style="font-size:10px;color:#555">'+s.dose+'</div></div>'
        +'</div>';
    });
    html += '</div>';
    return html;
  }

  const overlay = document.createElement('div');
  overlay.id = 'morningOverlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.99);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;overflow-y:auto';

  // Start with 5 second countdown screen
  overlay.innerHTML = ''
    +'<div id="morningCountdown" style="text-align:center">'
    +'<div style="font-size:14px;letter-spacing:3px;color:#ff6b35;font-family:Impact,sans-serif;margin-bottom:20px">GOOD MORNING. GET UP.</div>'
    +'<div id="countNum" style="font-size:120px;font-family:Impact,sans-serif;color:#ff6b35;line-height:1;margin-bottom:20px">5</div>'
    +'<div style="font-size:13px;color:#555;letter-spacing:2px;font-family:Impact,sans-serif">SECONDS. FEET ON THE FLOOR.</div>'
    +'<div style="margin-top:24px;width:200px;height:4px;background:#1a1a1a;border-radius:2px;margin-left:auto;margin-right:auto">'
    +'<div id="countBar" style="height:4px;background:#ff6b35;border-radius:2px;width:100%;transition:width 1s linear"></div>'
    +'</div>'
    +'</div>';

  document.body.appendChild(overlay);

  // 5 second countdown
  let count = 5;
  const bar = document.getElementById('countBar');
  const num = document.getElementById('countNum');

  function tick(){
    count--;
    if(num) num.textContent = count;
    if(bar) bar.style.width = (count/5*100)+'%';
    if(count <= 0){
      // Switch to main morning screen
      overlay.innerHTML = ''
        +'<div style="background:#0d0d0d;border:2px solid #ff6b35;border-radius:16px;padding:24px;max-width:340px;width:100%">'
        +'<div style="text-align:center;margin-bottom:16px">'
        +'<div style="font-size:32px;margin-bottom:8px">ðŸŒ…</div>'
        +'<div style="font-family:Impact,sans-serif;font-size:18px;letter-spacing:2px;color:#ff6b35;margin-bottom:10px">GOOD MORNING.</div>'
        +'<div style="font-size:12px;color:#888;line-height:1.7;margin-bottom:16px;font-style:italic">'+msg+'</div>'
        +'</div>'
        +'<div id="morningChecklist">'+buildMorningChecklist()+'</div>'

        // Gratitude journal
        +'<div style="margin-bottom:14px">'
        +'<div style="font-size:10px;letter-spacing:2px;color:#ffcc00;margin-bottom:8px;font-family:Impact,sans-serif">ðŸ™ GRATITUDE â€” 3 THINGS (Psalm 23)</div>'
        +'<textarea id="gratitude1" placeholder="I am grateful for..." style="width:100%;background:#111;border:1px solid #2a2a2a;border-radius:8px;padding:8px;color:#ccc;font-size:12px;resize:none;height:36px;box-sizing:border-box;margin-bottom:6px;outline:none"></textarea>'
        +'<textarea id="gratitude2" placeholder="I am grateful for..." style="width:100%;background:#111;border:1px solid #2a2a2a;border-radius:8px;padding:8px;color:#ccc;font-size:12px;resize:none;height:36px;box-sizing:border-box;margin-bottom:6px;outline:none"></textarea>'
        +'<textarea id="gratitude3" placeholder="I am grateful for..." style="width:100%;background:#111;border:1px solid #2a2a2a;border-radius:8px;padding:8px;color:#ccc;font-size:12px;resize:none;height:36px;box-sizing:border-box;outline:none"></textarea>'
        +'</div>'

        // To do list
        +'<div style="margin-bottom:16px">'
        +'<div style="font-size:10px;letter-spacing:2px;color:#6699ff;margin-bottom:8px;font-family:Impact,sans-serif">ðŸ“‹ TOP 3 THINGS TO ACCOMPLISH TODAY</div>'
        +'<div id="todoList"></div>'
        +'<div style="display:flex;gap:8px">'
        +'<input id="todoInput" placeholder="Add a task..." style="flex:1;background:#111;border:1px solid #2a2a2a;border-radius:8px;padding:8px 10px;color:#ccc;font-size:12px;outline:none">'
        +'<button onclick="addMorningTodo()" style="padding:8px 12px;background:#6699ff;border:none;border-radius:8px;color:#000;font-family:Impact,sans-serif;font-size:11px;cursor:pointer">ADD</button>'
        +'</div>'
        +'</div>'

        +'<button id="morningDoneBtn" style="width:100%;padding:14px;background:#ff6b35;border:none;border-radius:10px;color:#000;font-family:Impact,sans-serif;font-size:14px;letter-spacing:2px;cursor:pointer">LOCKED IN. LETS GO.</button>'
        +'</div>';

      // Load saved gratitude and todos
      const saved = DB.days[todayStr()] && DB.days[todayStr()].morning || {};
      if(saved.g1) document.getElementById('gratitude1').value = saved.g1;
      if(saved.g2) document.getElementById('gratitude2').value = saved.g2;
      if(saved.g3) document.getElementById('gratitude3').value = saved.g3;
      renderMorningTodos(saved.todos||[]);

      window.addMorningTodo = function(){
        const input = document.getElementById('todoInput');
        const val = input.value.trim();
        if(!val) return;
        const dd3 = getDD(todayStr());
        if(!dd3.morning) dd3.morning={};
        if(!dd3.morning.todos) dd3.morning.todos=[];
        dd3.morning.todos.push({text:val, done:false});
        saveDB();
        input.value='';
        renderMorningTodos(dd3.morning.todos);
      };

      window.toggleMorningTodo = function(idx){
        const dd3 = getDD(todayStr());
        if(dd3.morning&&dd3.morning.todos&&dd3.morning.todos[idx]){
          dd3.morning.todos[idx].done = !dd3.morning.todos[idx].done;
          saveDB();
          renderMorningTodos(dd3.morning.todos);
        }
      };

      function renderMorningTodos(todos){
        const container = document.getElementById('todoList');
        if(!container) return;
        if(!todos.length){ container.innerHTML='<div style="font-size:11px;color:#333;padding:6px 0">No tasks yet. Add up to 3 things you will actually do today.</div>'; return; }
        // Bind enter key on input
  setTimeout(function(){
    var inp = document.getElementById('journalTodoInput');
    if(inp) inp.onkeydown = function(e){ if(e.key==='Enter') window.addJournalTodo(); };
  }, 30);
  container.innerHTML = todos.map(function(t,i){
          return '<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #1a1a1a">'
            +'<div onclick="toggleMorningTodo('+i+')" style="width:18px;height:18px;border-radius:4px;border:2px solid '+(t.done?'#6699ff':'#444')+';background:'+(t.done?'#6699ff':'transparent')+';flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center">'
            +(t.done?'<span style="color:#000;font-size:10px;font-weight:bold">âœ“</span>':'')
            +'</div>'
            +'<span style="font-size:12px;color:'+(t.done?'#444':'#ccc')+';">'+(t.done?'<s>'+t.text+'</s>':t.text)+'</span>'
            +'</div>';
        }).join('');
      }

      document.getElementById('morningDoneBtn').onclick = function(){
        // Save gratitude
        const dd3 = getDD(todayStr());
        if(!dd3.morning) dd3.morning={};
        dd3.morning.g1 = document.getElementById('gratitude1').value;
        dd3.morning.g2 = document.getElementById('gratitude2').value;
        dd3.morning.g3 = document.getElementById('gratitude3').value;
        saveDB();
        overlay.remove();
        render();
      };

      return;
    }
    setTimeout(tick, 1000);
  }
  // Start countdown after brief delay
  setTimeout(function(){ if(bar) bar.style.width='80%'; }, 50);
  setTimeout(tick, 1000);
}

window.morningToggle = function(el){
  const id = el.dataset.bid;
  const type = el.dataset.btype;
  const today3 = todayStr();
  const dd3 = getDD(today3);
  if(type==='mmed'){
    if(!dd3.habits) dd3.habits={};
    dd3.habits[id] = !dd3.habits[id];
  } else if(type==='msupp'){
    dd3.supp[parseInt(el.dataset.bidx)] = !dd3.supp[parseInt(el.dataset.bidx)];
  }
  saveDB();
  document.getElementById('morningChecklist').innerHTML = buildMorningChecklist();
};

function showBedtimeAlarm(){
  const msgs = [
    "It is 10pm. Whatever you are watching right now is not going to make you stronger, richer, or more dangerous. Put the phone down. Take your meds. Go to bed.",
    "You are still on your phone at 10pm scrolling through nothing. The man outworking you is asleep right now. He recovers while you waste testosterone staying up for no reason. Bed. Now.",
    "10pm. That content you are consuming is not going to matter tomorrow. Your testosterone recovery window is open right now and you are throwing it away on a screen. Phone down. Lights off.",
    "Still awake scrolling? Every hour past 10pm costs you testosterone, recovery, and gains. Nothing on that screen is worth it. Take your supplements and go the fuck to bed.",
    "What are you even watching right now? Is it making you better? Is it making you stronger? Is it getting you closer to your goals? No. Put the phone down and go to sleep like a man who takes himself seriously.",
    "The social media, the videos, the stupidity you are consuming right now is actively making you worse. Lower testosterone. Worse sleep. Slower recovery. Close it. Bed. Now.",
    "10pm alarm. You know what to do. Meds logged. Phone face down. Eyes closed. The version of you that wins wakes up rested. Not the one still scrolling at midnight."
  ];
  const msg = msgs[Math.floor(Math.random()*msgs.length)];

  // Build checklist items â€” evening supplements + prescribed meds
  // Evening pack items: find their global indices in SUPPLEMENTS flat array
  const eveningPack = PILL_PACKS.find(function(p){return p.id==='evening';});
  let eveningOffset = 0;
  for(let pi=0;pi<PILL_PACKS.length;pi++){
    if(PILL_PACKS[pi].id==='evening') break;
    eveningOffset += PILL_PACKS[pi].items.length;
  }
  const today2 = todayStr();
  const dd2 = getDD(today2);

  const MEDS = [
    {id:'med-sertraline', label:'Sertraline', dose:'As prescribed'},
    {id:'med-wellbutrin', label:'Wellbutrin (Bupropion)', dose:'As prescribed'},
  ];
  const NIGHT_SUPPS = eveningPack.items.map(function(item, i){
    return {id:'supp-'+(eveningOffset+i), label:item.n.split('(')[0].trim(), dose:item.dose, suppIdx:(eveningOffset+i)};
  });

  function buildChecklist(){
    let html = '<div style="text-align:left;margin-bottom:16px">';
    html += '<div style="font-size:10px;letter-spacing:2px;color:#ff6b35;margin-bottom:8px;font-family:Impact,sans-serif">ðŸ’Š MEDS â€” TAKE THESE NOW</div>';
    MEDS.forEach(function(m){
      const checked = dd2.habits && dd2.habits[m.id];
      html += '<div id="row-'+m.id+'" data-bid="'+m.id+'" data-btype="med" onclick="bedtimeToggle(this.dataset.bid,this.dataset.btype)" style="display:flex;align-items:center;gap:10px;padding:8px 10px;background:'+(checked?'#0a1a0a':'#111')+';border:1px solid '+(checked?'#00ff88':'#2a2a2a')+';border-radius:8px;margin-bottom:6px;cursor:pointer">'
        +'<div style="width:20px;height:20px;border-radius:4px;border:2px solid '+(checked?'#00ff88':'#444')+';background:'+(checked?'#00ff88':'transparent')+';flex-shrink:0;display:flex;align-items:center;justify-content:center">'
        +(checked?'<span style="color:#000;font-size:12px;font-weight:bold">âœ“</span>':'')
        +'</div>'
        +'<div><div style="font-size:12px;color:'+(checked?'#00ff88':'#ccc')+';font-family:Impact,sans-serif;letter-spacing:1px">'+m.label+'</div>'
        +'<div style="font-size:10px;color:#555">'+m.dose+'</div></div>'
        +'</div>';
    });
    html += '<div style="font-size:10px;letter-spacing:2px;color:#6699ff;margin-bottom:8px;margin-top:12px;font-family:Impact,sans-serif">ðŸŒ™ NIGHT SUPPLEMENTS</div>';
    NIGHT_SUPPS.forEach(function(s){
      const checked = dd2.supp && dd2.supp[s.suppIdx];
      html += '<div id="row-'+s.id+'" data-bid="'+s.id+'" data-btype="supp" data-bidx="'+s.suppIdx+'" onclick="bedtimeToggle(this.dataset.bid,this.dataset.btype,this.dataset.bidx)" style="display:flex;align-items:center;gap:10px;padding:8px 10px;background:'+(checked?'#0a0a1a':'#111')+';border:1px solid '+(checked?'#6699ff':'#2a2a2a')+';border-radius:8px;margin-bottom:6px;cursor:pointer">'
        +'<div style="width:20px;height:20px;border-radius:4px;border:2px solid '+(checked?'#6699ff':'#444')+';background:'+(checked?'#6699ff':'transparent')+';flex-shrink:0;display:flex;align-items:center;justify-content:center">'
        +(checked?'<span style="color:#000;font-size:12px;font-weight:bold">âœ“</span>':'')
        +'</div>'
        +'<div><div style="font-size:12px;color:'+(checked?'#6699ff':'#ccc')+';font-family:Impact,sans-serif;letter-spacing:1px">'+s.label+'</div>'
        +'<div style="font-size:10px;color:#555">'+s.dose+'</div></div>'
        +'</div>';
    });
    html += '</div>';
    return html;
  }

  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.97);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;overflow-y:auto';
  overlay.innerHTML = ''
    +'<div style="background:#0d0d0d;border:2px solid #6699ff;border-radius:16px;padding:24px;max-width:340px;width:100%">'
    +'<div style="text-align:center;margin-bottom:16px">'
    +'<div style="font-size:36px;margin-bottom:8px">ðŸŒ™</div>'
    +'<div style="font-family:Impact,sans-serif;font-size:18px;letter-spacing:2px;color:#6699ff;margin-bottom:10px">10PM. BED TIME.</div>'
    +'<div style="font-size:12px;color:#888;line-height:1.7;margin-bottom:16px">'+msg+'</div>'
    +'</div>'
    +'<div id="bedtimeChecklist">'+buildChecklist()+'</div>'
    +'<button id="bedtimeBtn" style="width:100%;padding:14px;background:#6699ff;border:none;border-radius:10px;color:#000;font-family:Impact,sans-serif;font-size:14px;letter-spacing:2px;cursor:pointer;margin-bottom:8px;margin-top:4px">DONE. GOING TO BED.</button>'
    +'<button id="bedtimeSnooze" style="width:100%;padding:10px;background:none;border:1px solid #333;border-radius:10px;color:#333;font-size:11px;cursor:pointer">I need 15 more minutes (bitch move)</button>'
    +'</div>';
  document.body.appendChild(overlay);

  // Global toggle function for checklist items
  window.bedtimeToggle = function(id, type, suppIdx){
    const today3 = todayStr();
    const dd3 = getDD(today3);
    if(type==='med'){
      if(!dd3.habits) dd3.habits={};
      dd3.habits[id] = !dd3.habits[id];
    } else if(type==='supp'){
      dd3.supp[suppIdx] = !dd3.supp[suppIdx];
    }
    saveDB();
    // Re-render checklist in place
    document.getElementById('bedtimeChecklist').innerHTML = buildChecklist();
  };

  setTimeout(()=>{
    document.getElementById('bedtimeBtn').onclick = ()=>{ overlay.remove(); render(); };
    document.getElementById('bedtimeSnooze').onclick = ()=>{
      overlay.remove();
      DB.lastBedtimeNag = null;
      saveDB();
    };
  },50);
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STRETCH TIMERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var _AC=null;
function getAC(){if(!_AC)_AC=new(window.AudioContext||window.webkitAudioContext)();if(_AC.state==='suspended')_AC.resume();return _AC;}
function playTone(f,d,dur,v){try{var c=getAC(),o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.frequency.value=f;o.type='sine';g.gain.setValueAtTime(0,c.currentTime+d);g.gain.linearRampToValueAtTime(v||.35,c.currentTime+d+.01);g.gain.linearRampToValueAtTime(0,c.currentTime+d+dur);o.start(c.currentTime+d);o.stop(c.currentTime+d+dur+.05);}catch(e){}}
function playDone(){playTone(880,0,.15);playTone(1100,.2,.15);playTone(1320,.4,.4);if(navigator.vibrate)navigator.vibrate([100,50,100]);}
function playTick(){playTone(660,0,.07,.15);}
var _OV=null;
function closeOV(){if(_OV){if(_OV._iv)clearInterval(_OV._iv);_OV.remove();_OV=null;}}
window.closeOV=closeOV;
function parseCooldownStretches(str){
  if(!str) return [];
  var parts = str.split(/\s*[\u00B7\u2022]\s*/);
  return parts.map(function(s){
    s = s.trim();
    if(!s) return null;
    var m = s.match(/(\d+)\s*(sec|min)/i);
    var secs = 30;
    if(m){
      secs = parseInt(m[1]) * (m[2].toLowerCase()[0]==="m" ? 60 : 1);
      if(s.toLowerCase().indexOf("each")>=0) secs = Math.min(secs*2, 180);
    }
    return {name:s, secs:secs};
  }).filter(Boolean);
}

function renderStretchTimers(cooldownStr){
  var stretches = parseCooldownStretches(cooldownStr);
  if(!stretches.length) return "";
  var rows = stretches.map(function(s){
    var label = JSON.stringify(s.name);
    return '<div class="stretch-row">'
      + '<div class="stretch-lbl">' + s.name + '</div>'
      + '<div class="stretch-time">' + s.secs + 's</div>'
      + '<button class="stretch-btn" onclick="startStretch(' + label + ',' + s.secs + ')">START</button>'
      + '</div>';
  }).join("");
  return '<div class="stretch-timers">'
    + '<div class="stretch-timers-hdr">'
    + '<span style="font-size:10px;font-family:Impact,sans-serif;letter-spacing:2px;color:#aa88ff">â± STRETCH TIMERS</span>'
    + '<span style="font-size:10px;color:#444">stay in the app</span>'
    + '</div>'
    + rows + '</div>';
}

function startStretch(name, totalSecs){
  closeOV();try{getAC();}catch(e){}
  var rem=totalSecs,paused=false;
  var ov=document.createElement('div');
  ov.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,0.97);z-index:9999;display:flex;align-items:center;justify-content:center;padding:24px;box-sizing:border-box';
  _OV=ov;
  function col(){return rem/totalSecs>.5?'#aa88ff':rem/totalSecs>.25?'#ff6b35':'#ff0055';}
  function draw(){
    var C=2*Math.PI*56,off=(C*(1-rem/totalSecs)).toFixed(2),c=col();
    var mn=Math.floor(rem/60),sc=rem%60,t=mn?mn+':'+(sc<10?'0':'')+sc:''+rem;
    ov.innerHTML='<div style="text-align:center;width:100%;max-width:320px">'
      +'<div style="font-size:10px;letter-spacing:4px;color:#444;font-family:Impact,sans-serif;margin-bottom:14px">STRETCH TIMER</div>'
      +'<div style="font-size:14px;color:#999;margin-bottom:22px;line-height:1.5;padding:0 8px">'+name+'</div>'
      +'<div style="position:relative;width:160px;height:160px;margin:0 auto 24px">'
      +'<svg width="160" height="160" style="position:absolute;inset:0;transform:rotate(-90deg)">'
      +'<circle cx="80" cy="80" r="56" stroke="#1a1a1a" stroke-width="10" fill="none"/>'
      +'<circle cx="80" cy="80" r="56" stroke="'+c+'" stroke-width="10" fill="none" stroke-dasharray="'+C.toFixed(2)+'" stroke-dashoffset="'+off+'" stroke-linecap="round" style="transition:stroke-dashoffset .9s linear,stroke .3s"/>'
      +'</svg>'
      +'<div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center">'
      +'<div style="font-size:50px;font-family:Impact,sans-serif;color:'+c+';line-height:1">'+t+'</div>'
      +'<div style="font-size:11px;color:#555;font-family:Impact,sans-serif;letter-spacing:2px">'+(mn?'MIN':'SEC')+'</div>'
      +'</div></div>'
      +'<div style="display:flex;gap:12px;margin-bottom:16px">'
      +'<button id="_tp" style="flex:1;padding:15px;background:#1a0a2e;border:2px solid #aa88ff;border-radius:12px;color:#aa88ff;font-family:Impact,sans-serif;font-size:15px;cursor:pointer">'+(paused?'â–¶ RESUME':'â¸ PAUSE')+'</button>'
      +'<button onclick="closeOV()" style="flex:1;padding:15px;background:#111;border:2px solid #333;border-radius:12px;color:#555;font-family:Impact,sans-serif;font-size:15px;cursor:pointer">âœ• SKIP</button>'
      +'</div>'
      +'<div style="width:100%;height:4px;background:#1a1a1a;border-radius:2px;overflow:hidden">'
      +'<div style="height:100%;background:'+c+';width:'+Math.round((1-rem/totalSecs)*100)+'%;transition:width .9s linear"></div>'
      +'</div></div>';
    var pb=document.getElementById('_tp');
    if(pb)pb.onclick=function(){paused=!paused;draw();};
  }
  function tick(){
    if(paused)return;rem--;
    if(rem<=0){clearInterval(ov._iv);ov._iv=null;playDone();
      ov.innerHTML='<div style="text-align:center"><div style="font-size:80px;margin-bottom:20px">âœ…</div><div style="font-family:Impact,sans-serif;font-size:26px;letter-spacing:3px;color:#aa88ff;margin-bottom:10px">DONE</div><div style="font-size:13px;color:#666;margin-bottom:28px;line-height:1.5">'+name+'</div><button onclick="closeOV()" style="padding:16px 48px;background:#aa88ff;border:none;border-radius:12px;color:#000;font-family:Impact,sans-serif;font-size:16px;cursor:pointer">NEXT â–¶</button></div>';
      return;}
    if(rem<=3)playTick();draw();
  }
  draw();document.body.appendChild(ov);ov._iv=setInterval(tick,1000);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HYGIENE PREP KITS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var HYGIENE_KITS = {
  car:{label:"ðŸš— CAR",color:"#00ccff",items:[
    {i:"ðŸŒ¬ï¸",n:"Breath spray (Listerine pocket)",d:"Center console always. Non-negotiable."},
    {i:"ðŸ§»",n:"Unscented wet wipes",d:"Full body refresh if no shower. Face, pits, groin."},
    {i:"ðŸŒ¸",n:"Deodorant spray (Dove Men+)",d:"Faster than roll-on. Post-wipe reapply."},
    {i:"ðŸ¦·",n:"Travel toothbrush + mini paste",d:"Colgate Wisp works with no water"},
    {i:"ðŸ’Š",n:"Gum x2 packs",d:"Offer one, use one. Always have two."},
    {i:"ðŸ§¦",n:"Fresh socks + boxer (Ziploc bag)",d:"Glove box. Changes the whole game."},
    {i:"ðŸ§´",n:"Hand lotion (small tube)",d:"Dry cracked hands kill the vibe on contact"},
    {i:"ðŸ‘ƒ",n:"Nose/ear trimmer (USB rechargeable)",d:"Check weekly. Never get caught."},
    {i:"ðŸª®",n:"Mini lint roller",d:"Check shirt before getting out. Every time."},
    {i:"ðŸ’§",n:"Chlorophyll drops",d:"2-3 in water bottle. Internal deodorant."},
  ]},
  gym:{label:"ðŸ‹ï¸ GYM",color:"#00ff88",items:[
    {i:"ðŸš¿",n:"Body wash â€” Tea Tree (travel size)",d:"Shower before leaving if she might see you."},
    {i:"ðŸŒ¸",n:"Deodorant",d:"Reapply after shower â€” not before on wet skin"},
    {i:"ðŸŒ¬ï¸",n:"Breath spray",d:"Right after workout before any conversation"},
    {i:"ðŸ’¦",n:"Face wash (travel size)",d:"Sweat + oil = acne. Wash every workout."},
    {i:"ðŸ§´",n:"Moisturizer (small tube)",d:"30 seconds after face wash. Always."},
    {i:"ðŸ§»",n:"Private area wipes (unscented)",d:"Fresh Balls or similar â€” before and after"},
    {i:"ðŸ‘•",n:"Clean shirt + boxers + socks",d:"Always packed. Never leave dirty ones in bag."},
    {i:"ðŸ¦·",n:"Travel toothbrush",d:"Post-workout breath is brutal. No excuses."},
    {i:"ðŸ’Š",n:"Chlorophyll drops",d:"Pre-workout dose. Reduces sweat odor from inside."},
    {i:"ðŸª®",n:"Mini comb or pick",d:"Hair looks wild post-workout. Fix it."},
  ]},
  school:{label:"ðŸŽ“ SCHOOL",color:"#ffcc00",items:[
    {i:"ðŸŒ¬ï¸",n:"Gum or breath spray",d:"Before any close conversation. Always accessible."},
    {i:"ðŸŒ¸",n:"Mini deodorant stick",d:"Old Spice travel â€” locker or front pocket"},
    {i:"ðŸ§»",n:"Wet wipes",d:"Quick refresh between classes or after lunch"},
    {i:"ðŸ’§",n:"Subtle body mist (not cologne)",d:"1 spray max. Library rule. Not a club."},
    {i:"ðŸ¦·",n:"Wisp toothbrush",d:"No water needed. After lunch before afternoon."},
    {i:"ðŸ§´",n:"Hand cream (small)",d:"Dry hands before any touch or handshake"},
    {i:"ðŸª®",n:"Pocket comb",d:"Check before class â€” not during"},
    {i:"ðŸ‘“",n:"Small mirror (phone case or pocket)",d:"Check teeth, nose before talking to anyone"},
    {i:"ðŸ§¼",n:"Hand sanitizer",d:"Clean hands = less face touching = less acne"},
  ]},
  martial:{label:"ðŸ¥‹ MARTIAL ARTS",color:"#ff6b35",items:[
    {i:"ðŸ¦·",n:"Travel toothbrush + paste",d:"Post-sparring breath is on a different level. Non-negotiable."},
    {i:"ðŸŒ¬ï¸",n:"Breath spray x2",d:"One before class. One after."},
    {i:"ðŸš¿",n:"Body wash (travel)",d:"Always shower after. Never skip on fight day."},
    {i:"ðŸŒ¸",n:"Clinical deodorant",d:"Applied night before for best effect"},
    {i:"ðŸ§»",n:"Face + body wipes",d:"Between rounds if no shower access"},
    {i:"ðŸ‘•",n:"Full change of clothes",d:"Shirt, shorts, socks, boxer. Always packed."},
    {i:"ðŸ’Š",n:"Chlorophyll drops",d:"Pre-class water. Significant sweat odor reduction."},
    {i:"ðŸ¦¶",n:"Foot powder/spray (Odor-X)",d:"In shoes + on feet. No excuses on the mat."},
    {i:"ðŸ©¹",n:"Nail clippers + small first aid",d:"Trimmed nails = no scratching, no mat injuries"},
    {i:"ðŸ’¦",n:"Face wipes (post-sparring)",d:"Remove sweat and grime immediately after rolling"},
  ]}
};

var _activeKit = "car";

function renderHygieneKit(today, dd){
  var kit=HYGIENE_KITS[_activeKit];
  var hy=(dd&&dd.hygiene&&dd.hygiene[_activeKit])||{};
  var done=kit.items.filter(function(_,i){return hy[i];}).length;
  var all=done===kit.items.length;
  var tabs=Object.keys(HYGIENE_KITS).map(function(k){
    var kd=HYGIENE_KITS[k];
    return '<button class="hkit-tab'+(k===_activeKit?' on':'')+'" onclick="switchKit(\''+k+'\')" style="border:none;cursor:pointer">'+kd.label+'</button>';
  }).join('');
  var rows=kit.items.map(function(item,i){
    var chk=!!hy[i];
    var n=item.n||''; var d=item.d||'';
    return '<div onclick="toggleHygieneItem(\''+_activeKit+'\','+i+')" style="display:flex;align-items:flex-start;gap:10px;padding:11px 14px;border-bottom:1px solid #0f0f0f;cursor:pointer">'
      +'<div style="width:22px;height:22px;border-radius:5px;border:2px solid '+(chk?kit.color:'#2a2a2a')+';background:'+(chk?kit.color:'none')+';flex-shrink:0;margin-top:1px;display:flex;align-items:center;justify-content:center">'+(chk?'<span style="color:#000;font-weight:bold;font-size:12px">âœ“</span>':'')+'</div>'
      +'<div style="font-size:16px;flex-shrink:0;margin-top:1px">'+item.i+'</div>'
      +'<div><div style="font-size:12px;'+(chk?'color:#444;text-decoration:line-through':'color:#ccc')+'">'+n+'</div>'
      +'<div style="font-size:10px;color:#555;margin-top:2px;line-height:1.5">'+d+'</div></div>'
      +'</div>';
  }).join('');
  return '<div class="hkit-wrap"><div style="font-size:10px;letter-spacing:3px;color:#ff6b35;margin-bottom:8px;font-family:Impact,sans-serif">ðŸ«§ ALWAYS-READY HYGIENE KIT</div>'
    +'<div style="font-size:11px;color:#444;margin-bottom:12px;line-height:1.6">Tap items to check off. Hit the button when the bag is fully stocked.</div>'
    +'<div style="display:flex;gap:8px;margin-bottom:10px;align-items:center">'
    +'<div class="hkit-tabs" style="flex:1;display:flex;overflow-x:auto">'+tabs+'</div>'
    +'<button onclick="markAllHygiene(\''+_activeKit+'\','+(!all)+')" style="flex-shrink:0;padding:9px 14px;background:'+(all?'#003300':'#1a0900')+';border:2px solid '+(all?'#00ff88':'#ff6b35')+';border-radius:8px;color:'+(all?'#00ff88':'#ff6b35')+';font-family:Impact,sans-serif;font-size:10px;letter-spacing:1px;cursor:pointer;white-space:nowrap">'+(all?'âœ“ PACKED':'âœ… ALL PACKED')+'</button>'
    +'</div>'
    +'<div style="font-size:10px;color:#555;margin-bottom:6px">'+done+'/'+kit.items.length+' items packed</div>'
    +'<div style="border:1px solid #1e1e1e;border-radius:0 0 10px 10px;overflow:hidden;border-top:2px solid '+kit.color+'">'+rows+'</div>'
    +'</div>';
}


function toggleHygieneItem(kit,idx){var t=todayStr(),dd=getDD(t);if(!dd.hygiene)dd.hygiene={};if(!dd.hygiene[kit])dd.hygiene[kit]={};dd.hygiene[kit][idx]=!dd.hygiene[kit][idx];saveDB();var el=document.getElementById('hkitContainer');if(el)el.innerHTML=renderHygieneKit(t,dd);}
function markAllHygiene(kit,chk){var t=todayStr(),dd=getDD(t);if(!dd.hygiene)dd.hygiene={};if(!dd.hygiene[kit])dd.hygiene[kit]={};(HYGIENE_KITS[kit]?HYGIENE_KITS[kit].items:[]).forEach(function(_,i){dd.hygiene[kit][i]=chk;});saveDB();var el=document.getElementById('hkitContainer');if(el)el.innerHTML=renderHygieneKit(t,dd);}
function switchKit(k){_activeKit=k;var t=todayStr(),dd=getDD(t);var el=document.getElementById('hkitContainer');if(el)el.innerHTML=renderHygieneKit(t,dd);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REST TIMER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var _rtIv=null;
function cancelRest(){if(_rtIv){clearInterval(_rtIv);_rtIv=null;}document.querySelectorAll('.rbtn').forEach(function(b){b.classList.remove('active');if(b.dataset.o)b.textContent=b.dataset.o;b.style.cssText='';});}
function startRestTimer(secs,btn){
  cancelRest();try{getAC();}catch(e){}
  if(!btn.dataset.o)btn.dataset.o=btn.textContent;
  btn.classList.add('active');var rem=secs;
  _rtIv=setInterval(function(){
    rem--;
    if(rem<=0){clearInterval(_rtIv);_rtIv=null;btn.classList.remove('active');btn.textContent=btn.dataset.o;playDone();btn.style.cssText='background:#003300;border-color:#00ff88;color:#00ff88';setTimeout(function(){btn.style.cssText='';},1800);return;}
    if(rem<=3)playTick();
    var mn=Math.floor(rem/60),sc=rem%60;btn.textContent=(mn?mn+'m ':'')+sc+'s';
  },1000);
}
function renderRestBar(){
  return '<div class="rest-bar"><span style="font-size:10px;color:#444;font-family:Impact,sans-serif;letter-spacing:1px;flex-shrink:0">REST:</span>'
    +'<button class="rbtn" onclick="startRestTimer(60,this)">60s</button>'
    +'<button class="rbtn" onclick="startRestTimer(90,this)">90s</button>'
    +'<button class="rbtn" onclick="startRestTimer(120,this)">2m</button>'
    +'<button class="rbtn" onclick="startRestTimer(180,this)">3m</button>'
    +'<button class="rbtn" onclick="startRestTimer(300,this)">5m</button>'
    +'<button onclick="cancelRest()" style="margin-left:auto;padding:4px 10px;background:none;border:none;color:#333;font-size:18px;cursor:pointer;flex-shrink:0">âœ•</button></div>';
}

function weightProgressAlert(equip, dayIdx, exIdx) {
  var today = todayStr();
  var todayD = new Date(today + 'T12:00:00');
  var weights = [];
  var sessions = 0;
  for (var d = 1; d <= 28 && sessions < 3; d++) {
    var dt = new Date(todayD);
    dt.setDate(dt.getDate() - d);
    var ds = dt.getFullYear() + '-' + String(dt.getMonth()+1).padStart(2,'0') + '-' + String(dt.getDate()).padStart(2,'0');
    var dayData = DB.days && DB.days[ds];
    if (!dayData) continue;
    var key = equip + '-' + dayIdx + '-' + exIdx;
    if (!dayData.ex || !dayData.ex[key]) continue;
    sessions++;
    var maxW = 0;
    for (var s = 0; s < 8; s++) {
      var w = parseFloat(dayData.w && dayData.w[key + '-p0-s' + s]);
      if (w && w > maxW) maxW = w;
    }
    if (maxW > 0) weights.push(maxW);
  }
  if (weights.length < 3) return '';
  if (weights[0] === weights[1] && weights[1] === weights[2]) {
    return '<span class="add-weight">â†‘ ADD WEIGHT</span>';
  }
  return '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MINOXIDIL TRACKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMinoxTracker(today, dd) {
  var dow = new Date(today + 'T12:00:00').getDay();
  var dowNames = ['SUN','MON','TUE','WED','THU','FRI','SAT'];
  var dowKey = dowNames[dow];
  var isDermaDay = (dowKey === 'WED' || dowKey === 'SAT');

  // Streak â€” consecutive days with at least one application
  var streak = 0;
  var todayD = new Date(today + 'T12:00:00');
  for (var d = 1; d <= 60; d++) {
    var dt = new Date(todayD);
    dt.setDate(dt.getDate() - d);
    var ds = dt.getFullYear() + '-' + String(dt.getMonth()+1).padStart(2,'0') + '-' + String(dt.getDate()).padStart(2,'0');
    var prev = DB.days && DB.days[ds];
    if (prev && prev.minox && (prev.minox.am || prev.minox.pm)) {
      streak++;
    } else {
      break;
    }
  }

  // 14-day history dots
  var dots = '';
  for (var i = 13; i >= 0; i--) {
    var dt2 = new Date(todayD);
    dt2.setDate(dt2.getDate() - i);
    var ds2 = dt2.getFullYear() + '-' + String(dt2.getMonth()+1).padStart(2,'0') + '-' + String(dt2.getDate()).padStart(2,'0');
    var ddata = DB.days && DB.days[ds2];
    var hasBoth = ddata && ddata.minox && ddata.minox.am && ddata.minox.pm;
    var hasOne  = ddata && ddata.minox && (ddata.minox.am || ddata.minox.pm);
    var isToday = (ds2 === today);
    var bg = hasBoth ? '#9966ff' : hasOne ? '#4a2a7a' : '#1a1a1a';
    var bdr = isToday ? '#ff6b35' : '#222';
    dots += '<div style="width:18px;height:18px;border-radius:4px;background:' + bg + ';border:1px solid ' + bdr + '"></div>';
  }

  var amDone  = !!(dd.minox && dd.minox.am);
  var pmDone  = !!(dd.minox && dd.minox.pm);
  var dermaDone = !!(dd.minox && dd.minox.derma);

  function row(key, icon, label, note, color, done) {
    return '<div class="minox-row" onclick="toggleMinox(\'' + today + '\',\'' + key + '\')">'
      + '<div class="minox-chk' + (done ? ' on' : '') + '"></div>'
      + '<div style="flex:1"><div style="font-size:13px;' + (done ? 'color:#444;text-decoration:line-through' : 'color:#ccc') + '">' + icon + ' ' + label + '</div>'
      + '<div style="font-size:11px;color:#555;margin-top:2px">' + note + '</div></div>'
      + '</div>';
  }

  var rows = row('am', 'ðŸŒ…', 'Morning application', 'Damp skin. Half cap foam. 4h+ before sleep.', '#9966ff', amDone);
  if (isDermaDay) {
    rows += row('derma', 'ðŸ©¸', 'DERMAROLLER TONIGHT', '0.5mm roller. Roll before bed. SKIP PM Minox tonight.', '#ff6b35', dermaDone);
  } else {
    rows += row('pm', 'ðŸŒ™', 'Evening application', 'Damp skin. Half cap foam. Beard oil after absorbs.', '#9966ff', pmDone);
  }

  var warning = isDermaDay
    ? '<div style="padding:8px 16px;background:#1a0800;border-top:1px solid #2a1a0a;font-size:11px;color:#ff6b35">âš ï¸ Dermaroller night â€” skip PM Minox, apply tomorrow morning instead</div>'
    : '';

  return '<div class="minox-wrap">'
    + '<div class="minox-head">'
    + '<div>'
    + '<div style="font-size:12px;font-family:Impact,sans-serif;letter-spacing:1px;color:#9966ff">ðŸ§´ MINOXIDIL + DERMAROLLER</div>'
    + '<div style="font-size:10px;color:#555;margin-top:2px">' + dowKey + (isDermaDay ? ' Â· DERMAROLLER DAY' : ' Â· Standard day') + '</div>'
    + '</div>'
    + '<div style="text-align:right">'
    + '<div style="font-size:24px;font-family:Impact,sans-serif;color:#9966ff">' + streak + '</div>'
    + '<div style="font-size:9px;color:#555;letter-spacing:1px">DAY STREAK</div>'
    + '</div>'
    + '</div>'
    + rows
    + warning
    + '<div style="padding:10px 16px">'
    + '<div style="font-size:9px;color:#444;letter-spacing:1px;margin-bottom:6px">LAST 14 DAYS</div>'
    + '<div style="display:flex;gap:3px">' + dots + '</div>'
    + '<div style="display:flex;gap:12px;margin-top:6px;font-size:10px;color:#555">'
    + '<span><span style="display:inline-block;width:10px;height:10px;background:#9966ff;border-radius:2px;margin-right:4px"></span>Both</span>'
    + '<span><span style="display:inline-block;width:10px;height:10px;background:#4a2a7a;border-radius:2px;margin-right:4px"></span>One</span>'
    + '<span><span style="display:inline-block;width:10px;height:10px;background:#1a1a1a;border:1px solid #333;border-radius:2px;margin-right:4px"></span>Missed</span>'
    + '</div>'
    + '</div>'
    + '</div>';
}

function toggleMinox(date, key) {
  var dd = getDD(date);
  if (!dd.minox) dd.minox = {};
  dd.minox[key] = !dd.minox[key];
  saveDB(); render();
}


// Show app immediately with localStorage data, then sync Firebase
render();
loadDB();
setTimeout(function(){checkBedtimeAlarm();checkMorningAlarm();},3000);
// Check alarms on app open (in case the 60s interval hasn't fired yet)
setTimeout(function(){ checkBedtimeAlarm(); checkMorningAlarm(); }, 2500);

// iOS: Dynamically update sticky tab offset after render
function updateHeaderHeight(){
  const h=document.querySelector('.header');
  if(h){
    document.documentElement.style.setProperty('--header-h', h.offsetHeight+'px');
  }
}
updateHeaderHeight();
window.addEventListener('resize', updateHeaderHeight);

// iOS: Prevent rubber-band scroll on body but allow inside scrollable elements
document.addEventListener('touchmove', function(e){
  if(e.target===document.body) e.preventDefault();
},{passive:false});

// iOS: Fix 300ms tap delay
document.addEventListener('touchstart',function(){},{passive:true});

// Event delegation for equipment buttons (avoids quote escaping issues)
document.addEventListener('click',function(e){
  var ebtn=e.target.closest('.equip-btn');
  if(ebtn){selectEquip(ebtn.getAttribute('data-equip'));return;}
  var dbtn=e.target.closest('.switch-day-btn');
  if(dbtn){switchDay(dbtn.getAttribute('data-day'));return;}
});

// iOS: Show install banner if not already installed and not dismissed
const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
const isStandalone = window.navigator.standalone === true;
const bannerDismissed = localStorage.getItem('bannerDismissed');
if(isIOS && !isStandalone && !bannerDismissed){
  setTimeout(()=>{
    const banner = document.getElementById('installBanner');
    if(banner) banner.style.display='block';
  }, 2000);
}

// iOS: Re-measure header after fonts load
document.fonts && document.fonts.ready && document.fonts.ready.then(()=>{
  updateHeaderHeight();
  if(DB.dyslexiaMode) document.body.classList.add('dyslexia-mode');
  if(DB.lastEquip) UI.activeEquip=DB.lastEquip;
  render();
});
</script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js" defer></script>

<script>
// ===== ROUND 1 TIMER UPGRADE =====
let __rtInterval = null;
let __alarmInterval = null;

function __playAggressiveAlarm(){
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.type = "square";
  osc.frequency.value = 880;
  gain.gain.value = 0.8;
  osc.connect(gain);
  gain.connect(ctx.destination);
  osc.start();
  osc.stop(ctx.currentTime + 0.5);
  if(navigator.vibrate){ navigator.vibrate([300,150,300]); }
}

function __showAlarmOverlay(){
  const overlay = document.createElement("div");
  overlay.className = "alarm-flash";
  overlay.innerHTML = "<div>TIME IS UP</div><button style='margin-top:20px;padding:12px 20px;font-size:18px;' onclick='__dismissAlarm()'>DISMISS</button>";
  overlay.onclick = __dismissAlarm;
  document.body.appendChild(overlay);
}

function __dismissAlarm(){
  clearInterval(__alarmInterval);
  const overlay = document.querySelector(".alarm-flash");
  if(overlay) overlay.remove();
}

function startRestTimer(seconds, btn){
  clearInterval(__rtInterval);
  clearInterval(__alarmInterval);

  let remaining = seconds;

  if(btn){
    btn.classList.add("rest-btn-large");
    btn.innerText = remaining + "s";
  }

  __rtInterval = setInterval(()=>{
    remaining--;
    if(btn){ btn.innerText = remaining + "s"; }

    if(remaining <= 0){
      clearInterval(__rtInterval);
      __showAlarmOverlay();
      __playAggressiveAlarm();
      __alarmInterval = setInterval(__playAggressiveAlarm, 2000);
    }
  },1000);
}

// Add 30s button dynamically if rest bar exists
document.addEventListener("DOMContentLoaded", function(){
  const buttons = document.querySelectorAll("button");
  buttons.forEach(b=>{
    if(b.innerText === "60s"){
      const btn30 = document.createElement("button");
      btn30.innerText = "30s";
      btn30.className = b.className;
      btn30.onclick = function(){ startRestTimer(30, btn30); };
      b.parentNode.insertBefore(btn30, b);
    }
  });
});
</script>


<script>
// ===== ROUND 2: MOVEMENT-BASED PROGRESSION ENGINE =====

// Central movement progress store (non-destructive)
if(!window.movementProgress){
  window.movementProgress = {};
}

// Map common exercise names to movement categories
const movementMap = {
  "Bench Press":"chest_press",
  "Dumbbell Press":"chest_press",
  "Machine Chest Press":"chest_press",
  "Squat":"squat_pattern",
  "Hack Squat":"squat_pattern",
  "Leg Press":"squat_pattern",
  "Deadlift":"hinge_pattern",
  "Romanian Deadlift":"hinge_pattern",
  "Barbell Row":"row_pattern",
  "Lat Pulldown":"row_pattern"
};

function normalizeMovement(name){
  return movementMap[name] || name.toLowerCase().replace(/\s+/g,'_');
}

// Hook into existing logSet if present
if(typeof logSet === "function"){
  const originalLogSet = logSet;

  logSet = function(key){
    try{
      const exerciseName = document.querySelector(`#${key}_weight`)
        ?.closest(".movement")
        ?.querySelector(".movement-title")?.innerText || key;

      const movementKey = normalizeMovement(exerciseName);

      const weight = parseInt(document.getElementById(`${key}_weight`)?.value);
      const reps = parseInt(document.getElementById(`${key}_reps`)?.value);

      if(!weight || !reps) return;

      if(!movementProgress[movementKey]){
        movementProgress[movementKey] = {
          suggestedWeight: weight,
          suggestedReps: reps,
          history: []
        };
      }

      const m = movementProgress[movementKey];

      m.history.push({weight,reps,date:Date.now()});

      // Progression logic
      if(reps >= m.suggestedReps){
        m.suggestedWeight += 5;
      } else if(reps < m.suggestedReps - 2){
        m.suggestedWeight = Math.max(5, m.suggestedWeight - 5);
      }

      // Update UI suggestion display if exists
      const suggestionNode = document.querySelector(`#${key}_weight`)
        ?.closest(".movement")
        ?.querySelector(".movement-title");

      if(suggestionNode){
        suggestionNode.innerText = exerciseName + 
          " (Next: " + m.suggestedWeight + " lbs x " + m.suggestedReps + ")";
      }

      originalLogSet(key);

    } catch(e){
      originalLogSet(key);
    }
  }
}

// Improve substitution logic to preserve category
if(typeof swapExercise === "function"){
  const originalSwap = swapExercise;

  swapExercise = function(key){
    try{
      const exerciseName = document.querySelector(`#${key}_weight`)
        ?.closest(".movement")
        ?.querySelector(".movement-title")?.innerText || key;

      const movementKey = normalizeMovement(exerciseName);
      alert("Substitute allowed. Progress will accumulate under: " + movementKey);
      originalSwap(key);
    } catch(e){
      originalSwap(key);
    }
  }
}

</script>


<script>
// ===== ROUND 3: MEDS + AUDIT + RIVAL MODE =====

if(!window.medTracking){
  window.medTracking = {
    vyvanse: {taken:false, misses:0},
    wellbutrin: {taken:false, misses:0},
    sertraline: {taken:false, misses:0}
  };
}

if(!window.auditLog){
  window.auditLog = [];
}

// Simple medication UI injection
document.addEventListener("DOMContentLoaded", function(){

  const medSection = document.createElement("div");
  medSection.style.padding = "20px";
  medSection.innerHTML = `
    <h2 style="color:#00ff88;">Medication</h2>
    <label><input type="checkbox" id="med_vyvanse"> Vyvanse</label><br><br>
    <label><input type="checkbox" id="med_wellbutrin"> Wellbutrin</label><br><br>
    <label><input type="checkbox" id="med_sertraline"> Sertraline</label>
  `;

  document.body.appendChild(medSection);

  ["vyvanse","wellbutrin","sertraline"].forEach(m=>{
    document.getElementById("med_"+m).addEventListener("change", function(){
      medTracking[m].taken = this.checked;
    });
  });

});

function runAudit(){
  const missed = [];

  Object.keys(medTracking).forEach(m=>{
    if(!medTracking[m].taken){
      medTracking[m].misses++;
      missed.push(m);
    }
  });

  const entry = {
    date: Date.now(),
    missed: missed
  };

  auditLog.push(entry);

  showAuditOverlay(missed);
}

function showAuditOverlay(missed){
  const overlay = document.createElement("div");
  overlay.style.position = "fixed";
  overlay.style.inset = "0";
  overlay.style.background = "rgba(0,0,0,0.95)";
  overlay.style.color = "#00ff88";
  overlay.style.zIndex = "10000";
  overlay.style.display = "flex";
  overlay.style.flexDirection = "column";
  overlay.style.alignItems = "center";
  overlay.style.justifyContent = "center";
  overlay.style.padding = "20px";

  let message = "";

  if(missed.length === 0){
    message = "Execution clean. No misses.";
  } else {
    message = "Missed: " + missed.join(", ");
  }

  // Rival escalation
  const totalRecentMisses = auditLog.slice(-3).reduce((acc,e)=>acc + e.missed.length,0);

  if(totalRecentMisses >= 3){
    message += "<br><br><span style='color:red;'>Pattern detected. Standards slipping.</span>";
  }

  overlay.innerHTML = `
    <div style="font-size:24px;margin-bottom:20px;">DAILY AUDIT</div>
    <div style="margin-bottom:20px;text-align:center;">${message}</div>
    <button onclick="this.parentNode.remove()" style="padding:12px 20px;font-size:16px;">Close</button>
  `;

  document.body.appendChild(overlay);
}

// Optional: auto-trigger audit at 9PM
setInterval(function(){
  const now = new Date();
  if(now.getHours() === 21 && now.getMinutes() === 0){
    runAudit();
  }
},60000);

</script>


<script>
// ===== ROUND 4: NATIVE TABS + PERSISTENCE =====

// --- Simple Local Persistence Layer (safe, no Firebase risk) ---
function saveState(){
  localStorage.setItem("movementProgress", JSON.stringify(window.movementProgress || {}));
  localStorage.setItem("medTracking", JSON.stringify(window.medTracking || {}));
  localStorage.setItem("auditLog", JSON.stringify(window.auditLog || []));
}

function loadState(){
  try{
    window.movementProgress = JSON.parse(localStorage.getItem("movementProgress")) || window.movementProgress;
    window.medTracking = JSON.parse(localStorage.getItem("medTracking")) || window.medTracking;
    window.auditLog = JSON.parse(localStorage.getItem("auditLog")) || window.auditLog;
  } catch(e){}
}

loadState();

// Auto-save every 5 seconds
setInterval(saveState, 5000);

// --- Tab System ---
document.addEventListener("DOMContentLoaded", function(){

  const nav = document.createElement("div");
  nav.style.display = "flex";
  nav.style.justifyContent = "space-around";
  nav.style.padding = "10px";
  nav.style.borderBottom = "1px solid #111";
  nav.innerHTML = `
    <button id="tab_workout">Workout</button>
    <button id="tab_med">Medication</button>
    <button id="tab_audit">Audit</button>
  `;

  document.body.insertBefore(nav, document.body.firstChild);

  const sections = document.querySelectorAll("section");
  const medSection = document.createElement("section");
  const auditSection = document.createElement("section");

  medSection.innerHTML = `
    <h2 style="color:#00ff88;">Medication</h2>
    <label><input type="checkbox" id="med_vyvanse_tab"> Vyvanse (AM)</label><br><br>
    <label><input type="checkbox" id="med_wellbutrin_tab"> Wellbutrin (AM)</label><br><br>
    <label><input type="checkbox" id="med_sertraline_tab"> Sertraline (PM)</label>
  `;

  auditSection.innerHTML = `
    <h2 style="color:#00ff88;">Audit</h2>
    <div id="auditSummary" style="margin-bottom:20px;"></div>
    <button onclick="runAudit()">Run Audit</button>
  `;

  document.body.appendChild(medSection);
  document.body.appendChild(auditSection);

  function showTab(tab){
    sections.forEach(s=>s.style.display="none");
    medSection.style.display="none";
    auditSection.style.display="none";

    if(tab==="workout") sections.forEach(s=>s.style.display="block");
    if(tab==="med") medSection.style.display="block";
    if(tab==="audit") auditSection.style.display="block";
  }

  showTab("workout");

  document.getElementById("tab_workout").onclick = ()=>showTab("workout");
  document.getElementById("tab_med").onclick = ()=>showTab("med");
  document.getElementById("tab_audit").onclick = ()=>showTab("audit");

  // Sync checkboxes with medTracking
  ["vyvanse","wellbutrin","sertraline"].forEach(m=>{
    const el = document.getElementById("med_"+m+"_tab");
    if(el){
      el.checked = window.medTracking?.[m]?.taken || false;
      el.addEventListener("change", function(){
        window.medTracking[m].taken = this.checked;
        saveState();
      });
    }
  });

});

// Extend runAudit to include workout detection
const originalRunAudit = typeof runAudit === "function" ? runAudit : null;

runAudit = function(){

  const todaySets = Object.values(window.movementProgress || {})
    .flatMap(m=>m.history || [])
    .filter(h=>{
      const d = new Date(h.date);
      const now = new Date();
      return d.toDateString() === now.toDateString();
    }).length;

  const workoutMissed = todaySets === 0;

  if(workoutMissed){
    window.auditLog.push({date:Date.now(), missed:["workout"]});
  }

  if(originalRunAudit) originalRunAudit();

  const summary = document.getElementById("auditSummary");
  if(summary){
    summary.innerHTML = workoutMissed 
      ? "<span style='color:red;'>Workout missed today.</span>"
      : "<span style='color:#00ff88;'>Workout logged today.</span>";
  }

  saveState();
};

</script>


<script>
// ===== ROUND 5: DAILY RESET + RIVAL MODE + WEEKLY SUMMARY =====

// ---- Daily Reset Logic ----
function checkDailyReset(){
  const today = new Date().toDateString();
  const lastReset = localStorage.getItem("lastResetDate");

  if(lastReset !== today){
    // Reset daily med taken state
    if(window.medTracking){
      Object.keys(window.medTracking).forEach(m=>{
        window.medTracking[m].taken = false;
      });
    }
    localStorage.setItem("lastResetDate", today);
    saveState();
  }
}

checkDailyReset();

// ---- Rival Mode Pattern Escalation ----
function calculatePatterns(){
  const recent = (window.auditLog || []).slice(-5);

  const medMisses = recent.reduce((acc,e)=>{
    return acc + (e.missed || []).filter(x=>["vyvanse","wellbutrin","sertraline"].includes(x)).length;
  },0);

  const workoutMisses = recent.reduce((acc,e)=>{
    return acc + (e.missed || []).filter(x=>x==="workout").length;
  },0);

  let message = "";

  if(medMisses >= 2){
    message += "Medication consistency slipping.<br>";
  }

  if(workoutMisses >= 2){
    message += "Workout standard dropping.<br>";
  }

  if(medMisses >=2 || workoutMisses >=2){
    message += "<span style='color:red;'>This is becoming a pattern.</span>";
  }

  return message;
}

// ---- Weekly Summary ----
function renderWeeklySummary(){
  const summaryDiv = document.createElement("div");
  summaryDiv.style.marginTop = "20px";

  const last7 = (window.auditLog || []).slice(-7);

  const workoutMisses = last7.filter(e=>e.missed?.includes("workout")).length;
  const totalDays = last7.length || 1;

  const workoutRate = Math.max(0, 100 - Math.round((workoutMisses/totalDays)*100));

  const medMisses = last7.reduce((acc,e)=>{
    return acc + (e.missed || []).filter(x=>["vyvanse","wellbutrin","sertraline"].includes(x)).length;
  },0);

  const medRate = Math.max(0, 100 - Math.round((medMisses/(totalDays*3))*100));

  summaryDiv.innerHTML = `
    <div style="margin-top:15px;">
      <strong>Weekly Performance</strong><br><br>
      Workout Adherence: ${workoutRate}%<br>
      Medication Adherence: ${medRate}%
    </div>
  `;

  const auditSection = document.querySelector("section:nth-last-of-type(1)");
  if(auditSection && !document.getElementById("weeklySummary")){
    summaryDiv.id = "weeklySummary";
    auditSection.appendChild(summaryDiv);
  }
}

// Hook into existing runAudit
const originalRunAuditR5 = typeof runAudit === "function" ? runAudit : null;

runAudit = function(){
  if(originalRunAuditR5) originalRunAuditR5();

  const escalationMessage = calculatePatterns();

  if(escalationMessage){
    const auditSummary = document.getElementById("auditSummary");
    if(auditSummary){
      auditSummary.innerHTML += "<br><br>" + escalationMessage;
    }
  }

  renderWeeklySummary();
  saveState();
};

// ---- Active Tab Styling ----
document.addEventListener("DOMContentLoaded", function(){
  const tabs = document.querySelectorAll("#tab_workout, #tab_med, #tab_audit");

  tabs.forEach(tab=>{
    tab.addEventListener("click", function(){
      tabs.forEach(t=>{
        t.style.background="none";
        t.style.color="#fff";
      });
      this.style.background="#00ff88";
      this.style.color="#000";
    });
  });
});

</script>


<script>
// ===== ROUND 6: DISCIPLINE LOGIC + SLEEP + EXCUSE TRACKING =====

// ---- Sleep Tracking ----
if(!window.sleepLog){
  window.sleepLog = [];
}

// Extend Audit Tab UI safely
document.addEventListener("DOMContentLoaded", function(){

  const auditSection = document.querySelector("section:nth-last-of-type(1)");
  if(auditSection && !document.getElementById("sleepInput")){
    const sleepBlock = document.createElement("div");
    sleepBlock.style.marginTop = "20px";
    sleepBlock.innerHTML = `
      <label>Sleep (hours last night): 
        <input type="number" id="sleepInput" min="0" max="24" step="0.5" style="margin-left:10px;padding:5px;">
      </label>
    `;
    auditSection.appendChild(sleepBlock);
  }

  // Add Miss Gym button
  const workoutSection = document.querySelector("section");
  if(workoutSection && !document.getElementById("missGymBtn")){
    const btn = document.createElement("button");
    btn.id = "missGymBtn";
    btn.innerText = "Missed Gym (Log Reason)";
    btn.style.marginTop = "15px";
    btn.onclick = function(){
      const reason = prompt("Reason? (work / school / sick / other)");
      if(reason){
        window.auditLog.push({date:Date.now(), missed:["workout"], reason:reason.toLowerCase()});
        saveState();
        alert("Miss logged.");
      }
    };
    workoutSection.appendChild(btn);
  }

});

// ---- Extend runAudit ----
const originalRunAuditR6 = typeof runAudit === "function" ? runAudit : null;

runAudit = function(){

  const sleepVal = parseFloat(document.getElementById("sleepInput")?.value);
  if(!isNaN(sleepVal)){
    window.sleepLog.push({date:Date.now(), hours:sleepVal});
  }

  const todaySets = Object.values(window.movementProgress || {})
    .flatMap(m=>m.history || [])
    .filter(h=>{
      const d = new Date(h.date);
      const now = new Date();
      return d.toDateString() === now.toDateString();
    }).length;

  const workoutIncomplete = todaySets < 3;

  if(workoutIncomplete){
    window.auditLog.push({date:Date.now(), missed:["workout"], reason:"incomplete"});
  }

  if(originalRunAuditR6) originalRunAuditR6();

  // Pattern escalation
  const last7 = window.auditLog.slice(-7);

  const excuseCounts = last7.reduce((acc,e)=>{
    if(e.reason){
      acc[e.reason] = (acc[e.reason]||0)+1;
    }
    return acc;
  },{});

  const lowSleepDays = window.sleepLog.slice(-7).filter(s=>s.hours < 6).length;

  let escalation = "";

  if(excuseCounts["work"] >=3 || excuseCounts["school"] >=3){
    escalation += "Work/school used repeatedly as excuse.<br>";
  }

  if(lowSleepDays >=3){
    escalation += "Sleep pattern deteriorating.<br>";
  }

  if(escalation){
    const auditSummary = document.getElementById("auditSummary");
    if(auditSummary){
      auditSummary.innerHTML += "<br><br><span style='color:red;'>" + escalation + "</span>";
    }
  }

  saveState();
};

</script>


<style>
/* ===== ROUND 7 VISUAL REFINEMENT ===== */

.nav-active {
  background:#00ff88 !important;
  color:#000 !important;
  font-weight:bold !important;
}

.dashboard-grid {
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:12px;
  margin-top:20px;
}

.dashboard-card {
  background:#111;
  padding:15px;
  border-radius:8px;
  border:1px solid #1f1f1f;
}

.dashboard-card strong {
  color:#00ff88;
}

.escalation-banner {
  margin-top:20px;
  padding:15px;
  background:#2a0000;
  border:1px solid red;
  color:#ff6666;
  border-radius:8px;
}

.movement.logged {
  border:1px solid #00ff88;
  box-shadow:0 0 10px rgba(0,255,136,0.2);
}
</style>

<script>
// ===== ROUND 7 DASHBOARD + VISUAL COHESION =====

function renderDashboard(){

  const auditSection = document.querySelector("section:nth-last-of-type(1)");
  if(!auditSection) return;

  let dashboard = document.getElementById("performanceDashboard");
  if(!dashboard){
    dashboard = document.createElement("div");
    dashboard.id = "performanceDashboard";
    auditSection.insertBefore(dashboard, auditSection.firstChild);
  }

  const last7 = window.auditLog.slice(-7);
  const totalDays = last7.length || 1;

  const workoutMisses = last7.filter(e=>e.missed?.includes("workout")).length;
  const workoutRate = Math.max(0, 100 - Math.round((workoutMisses/totalDays)*100));

  const medMisses = last7.reduce((acc,e)=>{
    return acc + (e.missed||[]).filter(x=>["vyvanse","wellbutrin","sertraline"].includes(x)).length;
  },0);
  const medRate = Math.max(0, 100 - Math.round((medMisses/(totalDays*3))*100));

  const avgSleep = window.sleepLog.slice(-7).reduce((a,b)=>a+b.hours,0) / (window.sleepLog.slice(-7).length||1);
  const lowSleepDays = window.sleepLog.slice(-7).filter(s=>s.hours<6).length;

  dashboard.innerHTML = `
    <div class="dashboard-grid">
      <div class="dashboard-card"><strong>Workout</strong><br>${workoutRate}%</div>
      <div class="dashboard-card"><strong>Medication</strong><br>${medRate}%</div>
      <div class="dashboard-card"><strong>Avg Sleep</strong><br>${avgSleep ? avgSleep.toFixed(1) : "0"}h</div>
      <div class="dashboard-card"><strong>Low Sleep Days</strong><br>${lowSleepDays}</div>
    </div>
  `;

  const escalationMessage = calculatePatterns ? calculatePatterns() : "";
  let banner = document.getElementById("escalationBanner");

  if(escalationMessage){
    if(!banner){
      banner = document.createElement("div");
      banner.id = "escalationBanner";
      banner.className = "escalation-banner";
      auditSection.appendChild(banner);
    }
    banner.innerHTML = escalationMessage;
  }
}

const originalRunAuditR7 = typeof runAudit === "function" ? runAudit : null;

runAudit = function(){
  if(originalRunAuditR7) originalRunAuditR7();
  renderDashboard();
};

document.addEventListener("DOMContentLoaded", function(){

  const tabs = document.querySelectorAll("#tab_workout, #tab_med, #tab_audit");

  tabs.forEach(tab=>{
    tab.addEventListener("click", function(){
      tabs.forEach(t=>t.classList.remove("nav-active"));
      this.classList.add("nav-active");
    });
  });

});

</script>


<style>
/* ===== ROUND 8 FINAL POLISH ===== */

body {
  background:#000;
  letter-spacing:0.3px;
}

section {
  margin-bottom:30px;
}

button {
  transition:all 0.15s ease;
}

button:hover {
  transform:translateY(-2px);
}

button:active {
  transform:scale(0.97);
}

section h2 {
  border-bottom:1px solid #111;
  padding-bottom:8px;
  margin-bottom:20px;
}

.dashboard-card {
  transition:all 0.2s ease;
}

.dashboard-card:hover {
  border:1px solid #00ff88;
}

.escalation-banner {
  animation:pulse 1.5s infinite alternate;
}

@keyframes pulse {
  from { box-shadow:0 0 5px rgba(255,0,0,0.2); }
  to { box-shadow:0 0 15px rgba(255,0,0,0.6); }
}

.movement {
  transition:all 0.2s ease;
}

.movement:hover {
  border:1px solid #00ff88;
}

input[type="number"] {
  background:#111;
  color:#00ff88;
  border:1px solid #222;
}

input[type="number"]:focus {
  outline:none;
  border:1px solid #00ff88;
}
</style>

<script>
// ===== ROUND 8 MICRO-REFINEMENT =====

// Ensure dashboard renders on load
document.addEventListener("DOMContentLoaded", function(){
  if(typeof renderDashboard === "function"){
    renderDashboard();
  }
});

</script>

</body>
</html>
